<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - Dashboard</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --naranja: #fbbf24;
            --naranja-claro: #fdba74;
            --azul: #3b82f6;
            --azul-claro: #0ea5e9;
            --azul-oscuro: #1e3a8a;
            --azul-profundo: #1e293b;
            --neutro: #f1f5f9;
            --blanco: #ffffff;
            --success: #10B981;
            --error: #EF4444;
            --gray: #64748B;
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sombra-intensa: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radio: 15px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(160deg, var(--azul) 0%, var(--naranja) 100%);
            min-height: 100vh;
            color: var(--azul-profundo);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px 5px;
            min-height: calc(100vh - 10px);
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radio);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-intensa);
        }

        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .school-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .school-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--neutro);
            padding: 4px;
        }

        .school-name {
            color: var(--azul-oscuro);
            font-size: 18px;
            font-weight: 700;
        }

        .user-welcome {
            text-align: right;
            flex: 1;
            min-width: 180px;
        }

        .user-welcome h2 {
            color: var(--azul-oscuro);
            margin-bottom: 5px;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .dashboard {
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            margin-bottom: 5px;
        }

        .back-btn {
            margin-bottom: 15px;
        }

        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-cursos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .grid-modulos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .curso-card, .module-card {
            cursor: pointer;
            border-left: 5px solid var(--azul);
            border-right: 5px solid var(--naranja);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .curso-disponible-card {
            cursor: pointer;
            border-left: 5px solid var(--success);
            border-right: 5px solid var(--naranja-claro);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .curso-imagen, .module-imagen {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 50px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .curso-imagen img, .module-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: 10px;
        }

        .curso-card:hover .curso-imagen img,
        .module-card:hover .module-imagen img,
        .curso-disponible-card:hover .curso-imagen img {
            transform: scale(1.05);
        }

        .curso-titulo, .module-titulo {
            font-size: 16px;
            font-weight: 700;
            color: var(--azul-oscuro);
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid var(--azul);
            padding-bottom: 8px;
            word-wrap: break-word;
        }

        .curso-disponible-titulo {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid var(--success);
            padding-bottom: 8px;
            word-wrap: break-word;
        }

        .curso-content {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .curso-grupo {
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }

        .btn-acceder {
            width: 100%;
            margin-top: auto;
        }

        .btn-inscribirme {
            width: 100%;
            margin-top: auto;
            background: linear-gradient(to right, var(--success), #059669);
        }

        .section-title {
            color: var(--azul-oscuro);
            font-size: 24px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--naranja);
        }

        .section-subtitle {
            color: var(--azul-profundo);
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .curso-preview-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .curso-preview-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .preview-title {
            color: var(--azul-oscuro);
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
        }

        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .preview-description {
            color: var(--azul-profundo);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .progress-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--neutro);
            border-radius: 6px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
            margin-bottom: 4px;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 8px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--gray);
            font-weight: 600;
        }

        .progress-label {
            font-size: 11px;
            color: var(--gray);
            margin-bottom: 4px;
            text-align: center;
            font-weight: 600;
        }

        .lesson-accordion {
            background: var(--blanco);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: var(--sombra);
            border: 1px solid #e2e8f0;
        }

        .lesson-accordion.active {
            border-color: var(--azul);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .lesson-header {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            cursor: pointer;
            background: var(--blanco);
            transition: background 0.3s ease;
            position: relative;
        }

        .lesson-header:hover {
            background: #f8fafc;
        }

        .lesson-accordion.active .lesson-header {
            background: #f0f9ff;
        }

        .lesson-number-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .lesson-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--azul);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .lesson-accordion.completed .lesson-number {
            background: var(--success);
        }

        .lesson-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            color: var(--gray);
        }

        .lesson-accordion.active .lesson-arrow {
            transform: rotate(180deg);
            color: var(--azul);
        }

        .lesson-thumbnail {
            width: 120px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            margin-right: 12px;
        }

        .lesson-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lesson-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lesson-thumbnail:hover .play-icon {
            opacity: 1;
        }

        .lesson-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lesson-title {
            font-weight: 600;
            color: var(--azul-profundo);
            font-size: 15px;
            text-align: center;
            margin-bottom: 8px;
            width: 100%;
        }

        .lesson-accordion.completed .lesson-title {
            text-decoration: line-through;
            color: var(--gray);
        }

        .lesson-description {
            color: var(--azul-profundo);
            font-size: 14px;
            line-height: 1.5;
            text-align: center;
            margin-bottom: 12px;
            width: 100%;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .calificacion-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 8px 0;
            width: 100%;
        }

        .calificacion-estrellas {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }

        .estrella {
            font-size: 18px;
            color: #e0e0e0;
            transition: color 0.3s ease;
        }

        .estrella.activa {
            color: #fbbf24;
        }

        .calificacion-texto {
            font-size: 12px;
            font-weight: 600;
            color: var(--azul-oscuro);
            text-align: center;
        }

        .calificacion-valor {
            color: var(--naranja);
            font-weight: 700;
        }

        /* NUEVO: Estilo para certificado con 5 estrellas */
        .certificado-estrellas {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .certificado-texto {
            font-size: 11px;
            font-weight: 600;
            color: var(--success);
            text-align: center;
            margin-top: 4px;
        }

        /* NUEVO: Botones compactos en acordeÃ³n cerrado */
        .lesson-quick-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: var(--azul);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--azul-oscuro);
        }

        .quick-action-btn.certificado {
            background: var(--success);
        }

        .quick-action-btn.encuesta {
            background: var(--naranja);
        }

        .quick-action-btn .btn-text {
            display: none;
            font-size: 12px;
            font-weight: 600;
        }

        .lesson-accordion.active .quick-action-btn .btn-text {
            display: inline;
        }

        .vista-button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 8px;
        }

        .btn-vista {
            background: var(--azul);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-vista:hover {
            background: var(--azul-oscuro);
            transform: scale(1.05);
        }

        .btn-vista.completed {
            background: var(--success);
        }

        .lesson-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: var(--blanco);
        }

        .lesson-accordion.active .lesson-content {
            max-height: 1000px;
            padding: 0 16px 16px;
        }

        .lesson-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-start;
            margin-top: 16px;
        }

        .lesson-actions .btn {
            margin: 0;
        }

        .player-container {
            width: 100%;
            max-width: 800px;
            background: #000;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            margin: 12px 0;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 450px;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        .corner-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 40px;
            background: rgba(0,0,0,0.95);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 20;
            pointer-events: none;
            cursor: default;
            color: #fff;
            backdrop-filter: blur(5px);
            padding: 5px;
        }

        .corner-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .exit-fullscreen {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 30;
            cursor: pointer;
            display: none;
            color: #000;
            font-weight: bold;
        }

        .controls-panel {
            background: #000;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            margin-top: 0;
            transition: opacity 0.3s ease;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .progress-container-player {
            flex: 1;
            height: 20px;
            background: #444;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            z-index: 15;
        }

        .progress-player {
            height: 100%;
            background: #ff0000;
            border-radius: 10px;
            width: 0%;
            transform-origin: left center;
            position: absolute;
            left: 0;
            top: 0;
        }

        .thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            left: 0px;
        }

        .time-display {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            font-family: monospace;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 30;
            position: relative;
        }

        .video-controls button {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            flex: 1;
            max-width: 200px;
        }

        .video-controls button:hover {
            background: #cc0000;
        }

        .course-buttons, .module-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .course-buttons .btn, .module-buttons .btn {
            margin: 0;
        }

        /* NUEVO: Botones compactos en cabecera de curso */
        .course-buttons-compact {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
        }

        .course-toggle-btn {
            background: var(--azul);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .course-toggle-btn:hover {
            background: var(--azul-oscuro);
            transform: scale(1.05);
        }

        .course-emoji-btns {
            display: flex;
            gap: 6px;
        }

        .course-emoji-btn {
            background: var(--azul);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .course-emoji-btn:hover {
            transform: scale(1.1);
            background: var(--azul-oscuro);
        }

        .course-emoji-btn.whatsapp {
            background: #25D366;
        }

        .course-full-buttons {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .course-full-buttons.show {
            display: flex;
        }

        .course-info-text {
            margin-top: 15px;
            padding: 12px;
            background: var(--neutro);
            border-radius: 8px;
            border-left: 4px solid var(--azul);
        }
        
        .course-info-item {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .course-info-item:last-child {
            margin-bottom: 0;
        }
        
        .course-info-icon {
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .course-info-content {
            flex: 1;
        }
        
        .course-info-label {
            font-weight: 600;
            color: var(--azul-oscuro);
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .course-info-value {
            color: var(--azul-profundo);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .course-info-value a {
            color: var(--azul);
            text-decoration: none;
        }
        
        .course-info-value a:hover {
            text-decoration: underline;
        }

        .course-header, .module-header-expanded {
            display: none;
        }

        .course-title-section, .module-title-section {
            text-align: center;
            margin-bottom: 15px;
        }

        .course-title-section h1 {
            color: var(--azul-oscuro);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .module-title-section h2 {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .course-content, .module-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .course-image-container, .module-image-container {
            flex: 0 0 150px;
        }

        .course-header-image, .module-header-image {
            width: 100%;
            max-height: 120px;
            object-fit: cover;
            border-radius: 10px;
        }

        .course-info, .module-info {
            flex: 1;
        }

        .course-description, .module-description {
            color: var(--azul-profundo);
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 13px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error);
        }

        #universalManualModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #universalManualModal .modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            max-width: 900px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        #universalManualModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--azul-oscuro);
            color: white;
        }

        #universalManualModal .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        #universalManualModal .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        #universalManualModal iframe {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .form-container {
            width: 320px;
            padding: 25px;
            text-align: center;
        }

        .school-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .login-school-logo {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            margin: 0 auto 12px;
            display: block;
            border-radius: 8px;
            background: var(--neutro);
            padding: 8px;
        }

        .login-title {
            text-align: center;
            color: var(--azul-oscuro);
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 22px;
        }

        input[type=text], input[type=password], input[type=email], input[type=tel] {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            outline: none;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            background: white;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        input[type=text]:focus, input[type=password]:focus, input[type=email]:focus, input[type=tel]:focus {
            border-bottom: 2px solid var(--naranja);
        }

        input[type=submit], input[type=button] {
            width: 100%;
            margin: 5px 0;
        }

        .error-message {
            color: var(--error);
            font-size: 11px;
            text-align: center;
            margin: 8px 0;
            min-height: 18px;
        }

        .login-links {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .login-link {
            background: transparent;
            border: none;
            color: var(--azul);
            text-decoration: underline;
            font-size: 12px;
            cursor: pointer;
            padding: 5px;
        }
        
        .login-link:hover {
            color: var(--azul-oscuro);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--azul-oscuro);
            font-size: 13px;
        }
        /* === ESTILOS PARA SISTEMA DE ENCUESTAS === */
        .survey-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .survey-modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .survey-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--azul-oscuro);
            color: white;
            flex-shrink: 0;
        }

        .survey-modal-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .close-survey-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-survey-modal:hover {
            background: rgba(255,255,255,0.2);
        }

        .survey-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .survey-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--azul);
        }

        .survey-question {
            background: var(--neutro);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--azul);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-number {
            background: var(--azul);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .question-type-badge {
            background: var(--naranja);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .question-text {
            color: var(--azul-oscuro);
            font-size: 16px;
            font-weight: 600;
            margin: 10px 0 15px 0;
            line-height: 1.5;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-label:hover {
            border-color: var(--azul);
            background: #f0f9ff;
        }

        .option-label input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .option-text {
            flex: 1;
            color: var(--azul-profundo);
            font-size: 15px;
        }

        .question-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .question-textarea:focus {
            outline: none;
            border-color: var(--azul);
        }

        .question-file-input {
            display: none;
        }

        .file-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--azul);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-upload-btn:hover {
            background: var(--azul-oscuro);
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 6px;
            color: var(--success);
            font-size: 14px;
            display: none;
        }

        .survey-actions {
            padding: 15px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-shrink: 0;
        }

        .survey-resultado {
            padding: 25px;
            text-align: center;
        }

        .resultado-header {
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .resultado-score {
            font-size: 48px;
            font-weight: bold;
            margin: 15px 0;
        }

        .resultado-mensaje {
            font-size: 18px;
            margin: 10px 0;
        }

        .revision-question {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .revision-question.correcta {
            border-left: 5px solid var(--success);
            background: #f0fdf4;
        }

        .revision-question.incorrecta {
            border-left: 5px solid var(--error);
            background: #fef2f2;
        }

        .revision-question.pendiente {
            border-left: 5px solid var(--naranja);
            background: #fffbeb;
        }

        .revision-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .revision-status.correcta {
            background: var(--success);
            color: white;
        }

        .revision-status.incorrecta {
            background: var(--error);
            color: white;
        }

        .revision-status.pendiente {
            background: var(--naranja);
            color: white;
        }

        .respuesta-alumno {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .respuesta-correcta {
            background: #f0fdf4;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid var(--success);
        }

        .puntaje-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--azul-oscuro);
            color: white;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            margin-left: 10px;
        }

        .notes-area {
            display: none;
            margin-top: 8px;
        }

        .notes-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
        }

        .save-notes-btn {
            margin-top: 8px;
        }

        .manual-container {
            display: none;
            margin-top: 8px;
        }

        .image-fallback {
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        .no-content {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px 10px 5px;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 12px 15px;
            }
            
            .school-brand, .user-welcome {
                justify-content: center;
                text-align: center;
                min-width: auto;
            }

            .user-welcome {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .course-content, .module-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .course-image-container, .module-image-container {
                flex: 0 0 auto;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
            
            .grid-cursos, .grid-modulos {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .player-container {
                padding: 10px;
                margin: 10px 0;
            }
            
            .modal-content, .survey-modal-content {
                padding: 20px;
            }

            .survey-body {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .form-container {
                width: 100%;
                max-width: 300px;
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
                justify-content: center;
            }
            
            .modal-content {
                padding: 15px;
            }

            .lesson-actions {
                flex-direction: column;
            }

            .lesson-actions .btn {
                width: 100%;
            }
        }

        .expanded-module {
            width: 100%;
            padding: 0;
            margin-bottom: 5px;
        }

        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
        }

        .module-progress-expanded {
            margin: 15px 0;
            padding: 12px;
            text-align: center;
        }

        .content-list-expanded {
            margin-top: 15px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<!-- PÃ¡gina 1: Login -->
<div class="login-container" id="page1_id1">
    <div class="form-container card">
        <div class="school-header">
            <div id="defaultLogo" style="font-size: 40px; margin-bottom: 12px;">ðŸŽ“</div>
            <h1 class="login-title" id="schoolTitle">Plataforma Educativa</h1>
        </div>
        <input type="text" id="username" placeholder="Usuario" />
        <input type="password" id="password" placeholder="ContraseÃ±a" />
        <div class="error-message" id="errorMessage"></div>
        <input type="submit" class="btn btn-primary" value="Ingresar" onclick="LoginUser()" />
        
        <div class="login-links">
            <button class="login-link" onclick="showRegisterModal()">Â¿No tienes cuenta? RegÃ­strate</button>
            <button class="login-link" onclick="showForgotPasswordModal()">Â¿Olvidaste tu contraseÃ±a?</button>
        </div>
    </div>
</div>

<!-- Modal de Registro -->
<div id="registerModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Crear Cuenta</h2>
            <button class="close-modal" onclick="closeRegisterModal()">âœ•</button>
        </div>
        <div class="form-group">
            <input type="text" id="registerName" placeholder="Nombre" />
        </div>
        <div class="form-group">
            <input type="text" id="registerLastName" placeholder="Apellido" />
        </div>
        <div class="form-group">
            <input type="text" id="registerUser" placeholder="Usuario" />
        </div>
        <div class="form-group">
            <input type="password" id="registerPassword" placeholder="ContraseÃ±a" />
        </div>
        <div class="form-group">
            <input type="email" id="registerEmail" placeholder="Correo electrÃ³nico" />
        </div>
        <div class="form-group">
            <input type="tel" id="registerPhone" placeholder="TelÃ©fono (opcional)" />
        </div>
        <div class="error-message" id="registerErrorMessage"></div>
        <button class="btn btn-primary" onclick="registerUser()">Registrarse</button>
    </div>
</div>

<!-- Modal de OlvidÃ© ContraseÃ±a -->
<div id="forgotPasswordModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Recuperar ContraseÃ±a</h2>
            <button class="close-modal" onclick="closeForgotPasswordModal()">âœ•</button>
        </div>
        <p style="margin-bottom: 15px; text-align: center; color: var(--gray); font-size: 14px;">
            Ingresa tu correo electrÃ³nico y te enviaremos un enlace para restablecer tu contraseÃ±a.
        </p>
        <div class="form-group">
            <input type="email" id="forgotPasswordEmail" placeholder="Correo electrÃ³nico" />
        </div>
        <div class="error-message" id="forgotPasswordErrorMessage"></div>
        <button class="btn btn-primary" onclick="sendPasswordReset()">Enviar enlace</button>
    </div>
</div>

<!-- PÃ¡gina 4: Dashboard del usuario -->
<div class="dashboard page4_class1-off" id="page4_id1" style="display: none;">
    <div class="container">
        <!-- Cabecera Superior -->
        <div class="header-container card">
            <div class="school-brand">
                <img id="schoolLogo" class="school-logo" src="" alt="Logo Escuela" onerror="this.style.display='none'">
                <div class="school-name" id="headerSchoolName">Plataforma Educativa</div>
            </div>
            <div class="user-welcome">
                <h2>Â¡Hola <span id="displayusername" style="color:var(--azul);"></span>!</h2>
                <div class="status-badge">Estado: <span id="userStatus">Activo</span></div>
                <button class="btn btn-error" onclick="logout()">ðŸšª Cerrar SesiÃ³n</button>
            </div>
        </div>

        <!-- SecciÃ³n: Mis Cursos (arriba) -->
        <h2 class="section-title">Mis Cursos</h2>
        <p class="section-subtitle">Cursos en los que estÃ¡s actualmente inscrito</p>
        <div id="misCursosContainer" class="grid grid-cursos">
            <div class="loading">Cargando mis cursos...</div>
        </div>

        <!-- SecciÃ³n: Cursos Disponibles (abajo) -->
        <h2 class="section-title">Cursos Disponibles</h2>
        <p class="section-subtitle">Cursos gratuitos y generales a los que puedes inscribirte</p>
        <div id="cursosDisponiblesContainer" class="grid grid-cursos">
            <div class="loading">Cargando cursos disponibles...</div>
        </div>

        <!-- Cabecera del Curso (se muestra al acceder a un curso) -->
        <div id="courseHeader" class="course-header card" style="display: none;">
            <div class="course-title-section">
                <h1 id="courseTitle">Nombre del Curso</h1>
            </div>
            <div class="course-content">
                <div class="course-image-container">
                    <img id="courseHeaderImage" class="course-header-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
                </div>
                <div class="course-info">
                    <p id="courseDescription" class="course-description">DescripciÃ³n del curso...</p>
                    
                    <div id="courseInfoText" class="course-info-text" style="display: none;"></div>
                    
                    <!-- MODIFICADO: Botones compactos -->
                    <div id="courseButtonsContainer" class="course-buttons-compact"></div>
                </div>
            </div>
        </div>

        <!-- Contenedor para mÃ³dulos -->
        <div id="modulesContainer"></div>
    </div>
</div>

<!-- Modal para Vista Previa de Curso Disponible -->
<div id="cursoPreviewModal" class="curso-preview-container">
    <div class="curso-preview-content card">
        <div class="preview-header">
            <h3 class="preview-title" id="previewCourseTitle">Curso Disponible</h3>
            <button class="close-preview" onclick="closeCursoPreview()">âœ•</button>
        </div>
        
        <img id="previewCourseImage" class="preview-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
        
        <div class="preview-description" id="previewCourseDescription">
            DescripciÃ³n del curso...
        </div>
        
        <div class="curso-info-text" id="previewCourseInfo" style="display: none;"></div>
        
        <div class="preview-actions">
            <button class="btn btn-success" onclick="inscribirEnCursoDisponible()">ðŸ“ Inscribirme</button>
            <button class="btn btn-secondary" onclick="closeCursoPreview()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Unificado para Manuales y Calendario -->
<div id="universalManualModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="manualModalTitle">Manual</h3>
            <button class="close-modal" onclick="closeManualViewer()">âœ•</button>
        </div>
        <iframe id="manualModalFrame"></iframe>
    </div>
</div>

<!-- Modal para Encuestas -->
<div id="universalSurveyModal" class="survey-modal-overlay">
    <div class="survey-modal-content">
        <div class="survey-modal-header">
            <h3 class="survey-modal-title" id="surveyModalTitle">Encuesta</h3>
            <button class="close-survey-modal" onclick="closeSurveyModal()">âœ•</button>
        </div>
        <div class="survey-body" id="surveyBody">
            <!-- Contenido dinÃ¡mico de la encuesta -->
        </div>
        <div class="survey-actions" id="surveyActions">
            <!-- Botones de acciÃ³n -->
        </div>
    </div>
</div>
<script>
    // === CONFIGURACIÃ“N ===
    const CONFIG = {
        API_BASE_URL: 'https://escuuelaapi1.jorge-altagracia.workers.dev/'
    };

    // === VARIABLES GLOBALES ===
    let currentUser = null;
    let userProgress = {};
    let userModules = [];
    let currentPlayers = {};
    let alumnoActual = null;
    let cursosCache = null;
    let cursosDisponiblesCache = null;
    let currentCourseId = null;
    let currentGrupoId = null;
    let escuelaData = null;
    let currentCourseData = null;
    let dragging = false;
    let currentPreviewCurso = null;
    let hideControlsTimers = {};
    let isFullscreen = false;
    let currentOpenAccordion = null;

    // === VARIABLES PARA SISTEMA DE ENCUESTAS ===
    let todasEncuestas = [];
    let todasPreguntas = [];
    let currentEncuestaId = null;
    let currentClaseId = null;
    let preguntasEncuestaActual = [];
    let respuestasEncuesta = {};
    let archivosEncuesta = {};

    // === SISTEMA DE JSONP CORREGIDO ===
    function callJSONP(action, data = {}) {
        return new Promise((resolve, reject) => {
            const complexDataActions = ['guardarRespuestasAlumno'];
            
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            
            const params = new URLSearchParams();
            params.append('action', action);
            params.append('callback', callbackName);
            
            if (complexDataActions.includes(action) && Object.keys(data).length > 0) {
                const jsonData = JSON.stringify(data);
                console.log('ðŸ“¦ Enviando datos complejos como jsonData:', action, 'Length:', jsonData.length);
                params.append('jsonData', jsonData);
            } else {
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        params.append(key, String(data[key]));
                    }
                });
            }
            
            const url = CONFIG.API_BASE_URL + '?' + params.toString();
            
            if (url.length > 8000) {
                console.warn('âš ï¸ URL muy larga:', url.length, 'caracteres');
                reject(new Error('Los datos son demasiado grandes para enviar. Por favor, reduce la cantidad de informaciÃ³n.'));
                return;
            }
            
            console.log('ðŸ” Llamando JSONP:', action, 'URL length:', url.length);
            
            const script = document.createElement('script');
            script.src = url;
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                
                console.log('ðŸ“¨ Respuesta JSONP recibida:', response);
                
                if (response && response.success !== undefined) {
                    resolve(response);
                } else {
                    reject(new Error(response ? response.error : 'Error desconocido'));
                }
            };
            
            script.onerror = function() {
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                reject(new Error('Error de red al conectar con el servidor'));
            };
            
            const timeoutId = setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Timeout de la solicitud despuÃ©s de 30 segundos'));
                }
            }, 30000);
            
            const originalCallback = window[callbackName];
            window[callbackName] = function(response) {
                clearTimeout(timeoutId);
                originalCallback(response);
            };
            
            document.body.appendChild(script);
        });
    }

    // âœ… FUNCIÃ“N CORREGIDA PARA SUBIR ARCHIVOS A GITHUB VÃA CLOUDFLARE
    async function subirArchivoGitHub(archivoBase64, nombreArchivo, idAlumno, idPregunta) {
        try {
            console.log('ðŸ“¤ Iniciando subida a GitHub:', nombreArchivo);
            
            const response = await fetch(CONFIG.API_BASE_URL + 'upload-github', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    archivo: archivoBase64,
                    nombreArchivo: nombreArchivo,
                    idAlumno: idAlumno,
                    idPregunta: idPregunta
                })
            });
            
            console.log('ðŸ“¡ Status de respuesta:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ Error HTTP:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('ðŸ“¥ Respuesta de GitHub:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido al subir archivo');
            }
            
            return data;
            
        } catch (error) {
            console.error('âŒ Error en subirArchivoGitHub:', error);
            throw error;
        }
    }

    // === INICIALIZACIÃ“N ===
    document.addEventListener('DOMContentLoaded', function() {
        loadSchoolData().catch(error => {
            console.log('No se pudieron cargar los datos de la escuela:', error.message);
        });
    });

    // === FUNCIONES PARA DATOS DE LA ESCUELA ===
    async function loadSchoolData() {
        try {
            const response = await callJSONP('escuela', {});
            if (response.data && response.data.length > 0) {
                escuelaData = response.data[0];
                updateSchoolUI();
            } else {
                setDefaultSchoolData();
            }
        } catch (error) {
            console.error('Error cargando datos de la escuela:', error);
            setDefaultSchoolData();
        }
    }

    function updateSchoolUI() {
        if (!escuelaData) return;
        
        const loginTitle = document.getElementById('schoolTitle');
        if (loginTitle && escuelaData['Nombre_Escuela ']) {
            loginTitle.innerHTML = escuelaData['Nombre_Escuela '];
        }
        
        const headerSchoolName = document.getElementById('headerSchoolName');
        if (headerSchoolName && escuelaData['Nombre_Escuela ']) {
            headerSchoolName.textContent = escuelaData['Nombre_Escuela '];
        }
        
        if (escuelaData['Logo_Escuela']) {
            const logoImg = document.getElementById('schoolLogo');
            logoImg.src = escuelaData['Logo_Escuela'];
            logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
            logoImg.style.display = 'block';
        }

        if (escuelaData['Logo_Escuela']) {
            const loginHeader = document.querySelector('.school-header');
            if (loginHeader) {
                const defaultLogo = document.getElementById('defaultLogo');
                defaultLogo.style.display = 'none';
                
                const logoImg = document.createElement('img');
                logoImg.src = escuelaData['Logo_Escuela'];
                logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                logoImg.className = 'login-school-logo';
                logoImg.onerror = function() {
                    this.style.display = 'none';
                    defaultLogo.style.display = 'block';
                };
                
                loginHeader.insertBefore(logoImg, defaultLogo);
            }
        }
    }

    function setDefaultSchoolData() {
        const loginTitle = document.getElementById('schoolTitle');
        if (loginTitle) {
            loginTitle.innerHTML = 'Plataforma Educativa';
        }
        
        const headerSchoolName = document.getElementById('headerSchoolName');
        if (headerSchoolName) {
            headerSchoolName.textContent = 'Plataforma Educativa';
        }
    }

    // === FUNCIONES DE LOGIN ===
    async function LoginUser() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        
        if (!username || !password) {
            document.getElementById("errorMessage").innerHTML = "Complete todos los campos";
            return;
        }
        
        document.getElementById("errorMessage").innerHTML = "ðŸ” Verificando credenciales...";
        
        try {
            const response = await callJSONP('login', { username, password });
            
            if(response.success) {
                handleSuccessfulLogin(response);
            } else {
                document.getElementById("errorMessage").innerHTML = "âŒ " + response.error;
            }
        } catch (error) {
            document.getElementById("errorMessage").innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
        }
    }

    function handleSuccessfulLogin(response) {
        currentUser = response.alumno;
        alumnoActual = response.alumno;
        document.getElementById("displayusername").innerHTML = currentUser.Nombre + " " + currentUser.Apellido;
        
        document.getElementById("page1_id1").style.display = "none";
        document.getElementById("page4_id1").style.display = "block";
        document.getElementById("errorMessage").innerHTML = "";
        
        loadUserProgress(currentUser.ID_Alumno);
        loadMisCursos();
        loadCursosDisponibles();
        cargarDatosEncuestas();
    }

    // === CARGAR DATOS DE ENCUESTAS ===
    async function cargarDatosEncuestas() {
        try {
            console.log('ðŸ“Š Cargando datos de encuestas...');
            
            const encuestasResult = await callJSONP('obtenerEncuestas', {});
            if (encuestasResult.success) {
                todasEncuestas = encuestasResult.data || [];
                console.log('âœ… Encuestas cargadas:', todasEncuestas.length);
            }
            
            const preguntasResult = await callJSONP('obtenerPreguntas', {});
            if (preguntasResult.success) {
                todasPreguntas = preguntasResult.data || [];
                console.log('âœ… Preguntas cargadas:', todasPreguntas.length);
            }
            
        } catch (error) {
            console.error('âŒ Error cargando datos de encuestas:', error);
        }
    }

    // === SISTEMA DE CURSOS DISPONIBLES ===
    async function loadMisCursos() {
        const container = document.getElementById('misCursosContainer');
        const cacheKey = `mis_cursos_${alumnoActual.ID_Alumno}`;
        
        const cached = sessionStorage.getItem(cacheKey);
        if (cached) {
            console.log('Cargando mis cursos desde cache frontend');
            displayMisCursos(JSON.parse(cached));
            return;
        }
        
        container.innerHTML = '<div class="loading">Cargando mis cursos...</div>';
        
        try {
            const result = await callJSONP('getCursosAlumno', { alumnoId: alumnoActual.ID_Alumno });
            sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
            displayMisCursos(result.data);
        } catch (error) {
            showCursosError(error, container);
        }
    }

    async function loadCursosDisponibles() {
        const container = document.getElementById('cursosDisponiblesContainer');
        const cacheKey = `cursos_disponibles_${alumnoActual.ID_Alumno}`;
        
        container.innerHTML = '<div class="loading">Cargando cursos disponibles...</div>';
        
        try {
            const misCursosResult = await callJSONP('getCursosAlumno', { alumnoId: alumnoActual.ID_Alumno });
            const misCursosIds = misCursosResult.data.map(curso => curso.ID_Curso);
            console.log('ðŸ“š Cursos del alumno:', misCursosIds);
            
            const todosCursosResult = await callJSONP('cursos', {});
            console.log('ðŸ“‹ Todos los cursos:', todosCursosResult);
            
            if (todosCursosResult && todosCursosResult.data && Array.isArray(todosCursosResult.data)) {
                const gruposResult = await callJSONP('grupos', {});
                console.log('ðŸ‘¥ Grupos:', gruposResult);
                
                const portadasResult = await callJSONP('portada', {});
                console.log('ðŸ–¼ï¸ Portadas:', portadasResult);
                
                const cursosDisponibles = todosCursosResult.data.filter(curso => {
                    if (misCursosIds.includes(curso.ID_Curso)) {
                        console.log(`âŒ Excluyendo curso ${curso.ID_Curso} - Ya inscrito`);
                        return false;
                    }
                    
                    const condicion = curso.Condicion || '';
                    console.log(`ðŸ” Curso ${curso.ID_Curso} - CondiciÃ³n: "${condicion}"`);
                    
                    if (condicion === 'Gratis' || condicion === 'Promo') {
                        console.log(`âœ… Incluyendo curso ${curso.ID_Curso} - CondiciÃ³n especial: ${condicion}`);
                        return true;
                    }
                    
                    const grupo = gruposResult.data ? 
                        gruposResult.data.find(g => g.ID_Curso === curso.ID_Curso) : 
                        null;
                    
                    if (!grupo) {
                        console.log(`âŒ Excluyendo curso ${curso.ID_Curso} - Sin grupo`);
                        return false;
                    }
                    
                    const esGeneralOGratis = grupo.Nombre_Grupo === 'General' || grupo.Nombre_Grupo === 'Gratis';
                    console.log(`ðŸ“Š Curso ${curso.ID_Curso} - Grupo: ${grupo.Nombre_Grupo}, EsGeneralOGratis: ${esGeneralOGratis}`);
                    
                    return esGeneralOGratis;
                }).map(curso => {
                    const grupo = gruposResult.data ? 
                        gruposResult.data.find(g => g.ID_Curso === curso.ID_Curso) : 
                        null;
                    
                    const portada = portadasResult.data ? 
                        portadasResult.data.find(p => p.ID_Curso === curso.ID_Curso) : 
                        null;
                    
                    return {
                        ...curso,
                        ID_Grupo: grupo ? grupo.ID_Grupo : null,
                        Nombre_Grupo: grupo ? grupo.Nombre_Grupo : 'General',
                        Fecha_Inicio: grupo ? grupo.Fecha_Inicio : null,
                        Whatsapp: grupo ? grupo.Whatsapp : null,
                        Mensaje: grupo ? grupo.Mensaje : null,
                        Calendario: grupo ? grupo.Calendario : null,
                        Foto_Portada: portada && portada.Imagen ? portada.Imagen : (curso.Foto_Portada || curso['Foto de Portada']),
                        Condicion: curso.Condicion || ''
                    };
                });
                
                console.log('ðŸŽ¯ Cursos disponibles finales:', cursosDisponibles);
                sessionStorage.setItem(cacheKey, JSON.stringify(cursosDisponibles));
                displayCursosDisponibles(cursosDisponibles);
            } else {
                console.log('âŒ No hay datos de cursos');
                container.innerHTML = '<div class="no-content">No hay cursos disponibles en este momento.</div>';
            }
        } catch (error) {
            console.error('âŒ Error cargando cursos disponibles:', error);
            container.innerHTML = '<div class="no-content">Error al cargar cursos disponibles.</div>';
        }
    }

    function displayMisCursos(cursos) {
        const container = document.getElementById('misCursosContainer');
        
        if (!cursos || cursos.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                    <div style="font-size: 40px; margin-bottom: 12px;">ðŸŽ“</div>
                    <h3 style="color: var(--azul-oscuro); margin-bottom: 6px;">No estÃ¡s inscrito en ningÃºn curso visible</h3>
                    <p style="color: var(--gray); margin-bottom: 12px;">
                        Revisa la secciÃ³n de cursos disponibles para inscribirte.
                    </p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cursos.map(curso => {
            const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
            return `
            <div class="curso-card card" onclick="accederAlCurso('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                <div class="curso-imagen">
                    ${hasImage ? 
                        `<img src="${curso.Foto_Portada}" 
                              alt="${curso.Nombre_Curso}" 
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                              onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                        ''
                    }
                    <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">ðŸŽ“</div>
                </div>
                <div class="curso-content">
                    <h3 class="curso-titulo">${curso.Nombre_Curso}</h3>
                    <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                    <p class="curso-grupo">Inicio: ${formatFecha(curso.Fecha_Inicio)}</p>
                    <button class="btn btn-primary btn-acceder">Acceder al curso</button>
                </div>
            </div>
            `;
        }).join('');
    }

    function displayCursosDisponibles(cursos) {
        const container = document.getElementById('cursosDisponiblesContainer');
        cursosDisponiblesCache = cursos;
        
        if (!cursos || cursos.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                    <div style="font-size: 40px; margin-bottom: 12px;">ðŸ“š</div>
                    <h3 style="color: var(--azul-oscuro); margin-bottom: 6px;">No hay cursos disponibles en este momento</h3>
                    <p style="color: var(--gray); margin-bottom: 12px;">
                        PrÃ³ximamente se abrirÃ¡n nuevos cursos.
                    </p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = cursos.map(curso => {
            const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
            const condicion = curso.Condicion || '';
            const nombreCurso = curso.Nombre_Curso || curso['Nombre del Curso'];
            let badgeColor = 'var(--success)';
            let badgeText = 'Disponible';
            
            if (condicion === 'Promo') {
                badgeColor = 'var(--naranja)';
                badgeText = 'ðŸ”¥ PromociÃ³n';
            } else if (condicion === 'Gratis') {
                badgeColor = 'var(--success)';
                badgeText = 'ðŸŽ Gratuito';
            }
            
            return `
            <div class="curso-disponible-card card" onclick="verCursoDisponible('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                <div class="curso-imagen">
                    ${hasImage ? 
                        `<img src="${curso.Foto_Portada}" 
                              alt="${nombreCurso}" 
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                              onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                        ''
                    }
                    <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">ðŸ“š</div>
                    <div style="position: absolute; top: 10px; right: 10px; background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">
                        ${badgeText}
                    </div>
                </div>
                <div class="curso-content">
                    <h3 class="curso-disponible-titulo">${nombreCurso}</h3>
                    <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                    <p class="curso-grupo">${condicion === 'Promo' ? 'ðŸ”¥ PromociÃ³n especial' : (condicion === 'Gratis' ? 'ðŸŽ Curso gratuito' : 'Disponible para todos')}</p>
                    <button class="btn btn-inscribirme" onclick="event.stopPropagation(); inscribirEnCursoDisponibleDesdeBoton('${curso.ID_Curso}', '${curso.ID_Grupo}')">ðŸ“ Inscribirme</button>
                </div>
            </div>
            `;
        }).join('');
    }

    function verCursoDisponible(cursoId, grupoId) {
        const curso = cursosDisponiblesCache.find(c => c.ID_Curso === cursoId && c.ID_Grupo === grupoId);
        if (!curso) return;
        
        currentPreviewCurso = curso;
        
        document.getElementById('previewCourseTitle').textContent = curso.Nombre_Curso || curso['Nombre del Curso'];
        document.getElementById('previewCourseDescription').textContent = curso.DescripciÃ³n || curso.Descripcion || 'No hay descripciÃ³n disponible para este curso.';
        
        const previewImage = document.getElementById('previewCourseImage');
        if (curso.Foto_Portada) {
            previewImage.src = curso.Foto_Portada;
            previewImage.style.display = 'block';
        } else {
            previewImage.style.display = 'none';
        }
        
        const infoContainer = document.getElementById('previewCourseInfo');
        infoContainer.innerHTML = '';
        
        const condicion = curso.Condicion || '';
        if (condicion === 'Promo' || condicion === 'Gratis') {
            infoContainer.innerHTML += `
                <div class="course-info-item">
                    <div class="course-info-icon">${condicion === 'Promo' ? 'ðŸ”¥' : 'ðŸŽ'}</div>
                    <div class="course-info-content">
                        <div class="course-info-label">CondiciÃ³n Especial</div>
                        <div class="course-info-value">
                            ${condicion === 'Promo' ? 'ðŸ”¥ Curso en PromociÃ³n - Acceso inmediato' : 'ðŸŽ Curso completamente Gratuito'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (curso.Mensaje) {
            infoContainer.innerHTML += `
                <div class="course-info-item">
                    <div class="course-info-icon">ðŸ“¢</div>
                    <div class="course-info-content">
                        <div class="course-info-label">Mensaje Importante</div>
                        <div class="course-info-value">${curso.Mensaje}</div>
                    </div>
                </div>
            `;
        }
        
        infoContainer.style.display = 'block';
        
        document.getElementById('cursoPreviewModal').style.display = 'flex';
    }

    function closeCursoPreview() {
        document.getElementById('cursoPreviewModal').style.display = 'none';
        currentPreviewCurso = null;
    }

    async function inscribirEnCursoDisponible() {
        if (!currentPreviewCurso) return;
        
        await inscribirEnCursoDisponibleDesdeBoton(currentPreviewCurso.ID_Curso, currentPreviewCurso.ID_Grupo);
    }

    async function inscribirEnCursoDisponibleDesdeBoton(cursoId, grupoId) {
        if (!currentUser) {
            showNotification('âŒ Debes iniciar sesiÃ³n para inscribirte', 'error');
            return;
        }
        
        try {
            showNotification('ðŸ”„ InscribiÃ©ndote al curso...');
            
            const inscripcionId = 'INS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const fechaInscripcion = new Date().toISOString().split('T')[0];
            
            const response = await callJSONP('inscribir', {
                ID_Inscripcion: inscripcionId,
                ID_Alumno: currentUser.ID_Alumno,
                ID_Curso: cursoId,
                ID_Grupo: grupoId,
                Fecha_Inscripcion: fechaInscripcion,
                Postulantes: 'SI'
            });
            
            if (response.success) {
                showNotification('âœ… Â¡Te has inscrito correctamente al curso!');
                
                closeCursoPreview();
                
                sessionStorage.removeItem(`mis_cursos_${currentUser.ID_Alumno}`);
                sessionStorage.removeItem(`cursos_disponibles_${currentUser.ID_Alumno}`);
                loadMisCursos();
                loadCursosDisponibles();
                
            } else {
                showNotification('âŒ Error al inscribirse: ' + response.error, 'error');
            }
        } catch (error) {
            showNotification('âŒ Error de conexiÃ³n: ' + error.message, 'error');
        }
    }

    // === FUNCIONES AUXILIARES ===
    function showCursosError(error, container) {
        container.innerHTML = '<div class="error">Error al cargar los cursos: ' + error.message + '</div>';
    }

    function formatFecha(fechaString) {
        if (!fechaString) return 'No especificada';
        try {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES');
        } catch (e) {
            return fechaString;
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = 'notification ' + (type === 'error' ? 'error' : '');
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // === SISTEMA DE PROGRESO Y CALIFICACIONES ===
    async function loadUserProgress(alumnoId) {
        try {
            console.log('ðŸ“Š Cargando progreso para alumno:', alumnoId);
            
            const result = await callJSONP('getUserProgress', { alumnoId });
            
            console.log('ðŸ“¥ Respuesta de getUserProgress:', result);
            
            userProgress = {};
            
            if (result.success && result.data && result.data.length > 0) {
                result.data.forEach(function(item) {
                    if (item.ID_Clase) {
                        userProgress[item.ID_Clase] = {
                            completed: item.Completada === "SÃ­" || item.Completada === true,
                            notes: item.Notas_Alumno || '',
                            calificacion: item.Calificacion || 0,
                            certificado: item.Certificado || '',
                            lastUpdate: item.Fecha_Guardado || new Date()
                        };
                    }
                });
                
                console.log(`âœ… Progreso cargado: ${Object.keys(userProgress).length} clases`);
            } else {
                console.log('â„¹ï¸ No se encontrÃ³ progreso previo para este alumno');
            }
            
        } catch (error) {
            console.error("ðŸ’¥ Error cargando progreso:", error);
            userProgress = {};
        }
    }

    // âœ… CORREGIDO: VerificaciÃ³n mejorada para manejar calificaciÃ³n 0 vs vacÃ­o
    function renderCalificacionEstrellas(lessonId, tieneEncuesta) {
        // Si no tiene encuesta, no mostrar nada
        if (!tieneEncuesta) {
            return '';
        }
        
        // Si tiene certificado, mostrar 5 estrellas sin porcentaje
        if (userProgress[lessonId] && userProgress[lessonId].certificado && userProgress[lessonId].certificado.trim() !== '') {
            return `
                <div class="calificacion-container">
                    <div class="certificado-estrellas">
                        <span class="estrella activa">â˜…</span>
                        <span class="estrella activa">â˜…</span>
                        <span class="estrella activa">â˜…</span>
                        <span class="estrella activa">â˜…</span>
                        <span class="estrella activa">â˜…</span>
                    </div>
                    <div class="certificado-texto">Certificado obtenido</div>
                </div>
            `;
        }
        
        // âœ… CORREGIDO: Solo mostrar calificaciÃ³n si existe y es mayor a 0
        const tieneCalificacion = userProgress[lessonId] && 
                                 userProgress[lessonId].hasOwnProperty('Calificacion') && 
                                 userProgress[lessonId].Calificacion > 0;
        
        if (!tieneCalificacion) {
            return '<div class="calificacion-container"><div class="calificacion-texto">Sin calificar</div></div>';
        }
        
        const calificacion = userProgress[lessonId].Calificacion;
        return renderCalificacionEstrellasHTML(calificacion);
    }

    function renderCalificacionEstrellasHTML(calificacion) {
        const porcentaje = Math.min(100, Math.max(0, calificacion));
        const estrellasActivas = Math.round((porcentaje / 100) * 5);
        
        let html = '<div class="calificacion-container">';
        html += '<div class="calificacion-estrellas">';
        for (let i = 1; i <= 5; i++) {
            html += `<span class="estrella ${i <= estrellasActivas ? 'activa' : ''}">â˜…</span>`;
        }
        html += '</div>';
        html += `<div class="calificacion-texto">CalificaciÃ³n: <span class="calificacion-valor">${porcentaje}/100</span></div>`;
        html += '</div>';
        
        return html;
    }

    // === SISTEMA DE ENCUESTAS COMPLETO CON ARCHIVOS ===

    // âœ… CORREGIDO: VerificaciÃ³n mejorada con manejo de calificaciÃ³n 0
    async function abrirEncuesta(encuestaId, claseId) {
        console.log('ðŸŽ¯ Abriendo encuesta:', encuestaId, 'para clase:', claseId);
        
        currentEncuestaId = encuestaId;
        currentClaseId = claseId;
        
        try {
            const verificacion = await callJSONP('verificarEncuestaCompletada', {
                alumnoId: alumnoActual.ID_Alumno,
                encuestaId: encuestaId,
                claseId: claseId
            });
            
            console.log('ðŸ“¥ Resultado verificaciÃ³n backend:', verificacion);
            
            if (verificacion.success && verificacion.completada) {
                console.log('âœ… Backend dice: completada, mostrando revisiÃ³n');
                mostrarRevisionEncuesta(encuestaId, claseId);
                return;
            }
            
        } catch (error) {
            console.error('âŒ Error verificando encuesta:', error);
        }
        
        // âœ… CORREGIDO: VerificaciÃ³n mejorada - solo si tiene calificaciÃ³n Y es > 0
        const progresoClase = userProgress[claseId];
        const tieneCalificacion = progresoClase && 
                                 progresoClase.hasOwnProperty('Calificacion') && 
                                 progresoClase.Calificacion > 0;
        
        console.log('ðŸ“Š Estado del progreso local:', {
            existe: !!progresoClase,
            calificacion: progresoClase?.Calificacion,
            tieneCalificacion: tieneCalificacion
        });
        
        if (tieneCalificacion) {
            console.log('âœ… Frontend detecta calificaciÃ³n > 0, mostrando revisiÃ³n');
            mostrarRevisionEncuesta(encuestaId, claseId);
            return;
        }
        
        console.log('âœ… No hay calificaciÃ³n, permitiendo contestar');
        
        preguntasEncuestaActual = todasPreguntas.filter(p => p.ID_Encuesta === encuestaId);
        
        if (preguntasEncuestaActual.length === 0) {
            showNotification('âŒ No hay preguntas disponibles para esta encuesta', 'error');
            return;
        }
        
        preguntasEncuestaActual.sort((a, b) => (a.Numero_Pregunta || 0) - (b.Numero_Pregunta || 0));
        
        respuestasEncuesta = {};
        archivosEncuesta = {};
        
        mostrarEncuesta();
    }

    function actualizarEstadoBotonEncuesta(claseId, completada = true) {
        const botonEncuesta = document.getElementById(`encuesta-btn-${claseId}`);
        
        if (botonEncuesta) {
            if (completada) {
                botonEncuesta.innerHTML = 'âœ… Corregida';
                botonEncuesta.classList.remove('btn-primary');
                botonEncuesta.classList.add('btn-secondary');
                botonEncuesta.style.opacity = '0.7';
                
                const encuestaId = currentEncuestaId;
                botonEncuesta.onclick = function(e) {
                    e.stopPropagation();
                    mostrarRevisionEncuesta(encuestaId, claseId);
                };
            }
        }
    }

    function mostrarEncuesta() {
        const encuesta = todasEncuestas.find(e => e.ID_Encuesta === currentEncuestaId);
        const nombreEncuesta = encuesta ? encuesta.Nombre_Encuesta : 'Encuesta';
        
        document.getElementById('surveyModalTitle').textContent = nombreEncuesta;
        
        let html = `
            <div class="survey-info">
                <h3>${nombreEncuesta}</h3>
                <p>${encuesta ? encuesta.Descripcion : 'Responde todas las preguntas'}</p>
                <p><strong>Total de preguntas:</strong> ${preguntasEncuestaActual.length}</p>
            </div>
        `;
        
        preguntasEncuestaActual.forEach((pregunta, index) => {
            html += renderizarPregunta(pregunta, index);
        });
        
        document.getElementById('surveyBody').innerHTML = html;
        
        setTimeout(() => {
            restaurarRespuestasPrevias();
        }, 100);
        
        document.getElementById('surveyActions').innerHTML = `
            <button class="btn btn-secondary" onclick="closeSurveyModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="enviarRespuestasEncuesta()">Enviar Respuestas</button>
        `;
        
        document.getElementById('universalSurveyModal').style.display = 'flex';
    }

    function renderizarPregunta(pregunta, index) {
        const tipoOriginal = pregunta.Tipo_Pregunta || '';
        const tipo = tipoOriginal.toLowerCase();
        
        let tipoBadge = 'OpciÃ³n MÃºltiple';
        
        if (tipo === 'multiple_choice' || tipo === 'opcion_multiple') {
            tipoBadge = 'OpciÃ³n MÃºltiple';
        } else if (tipo === 'texto_abierto' || tipo === 'texto') {
            tipoBadge = 'Texto Abierto';
        } else if (tipo === 'archivo') {
            tipoBadge = 'Archivo Adjunto';
        }
        
        let html = `
            <div class="survey-question" data-pregunta-id="${pregunta.ID_Pregunta}">
                <div class="question-header">
                    <div class="question-number">${pregunta.Numero_Pregunta || (index + 1)}</div>
                    <div class="question-type-badge">${tipoBadge}</div>
                </div>
                <div class="question-text">${pregunta.Enunciado_Pregunta || 'Sin enunciado'}</div>
        `;
        
        if (tipo === 'multiple_choice' || tipo === 'opcion_multiple') {
            html += '<div class="question-options">';
            for (let i = 1; i <= 5; i++) {
                const opcion = pregunta[`Opcion_${i}`];
                if (opcion && opcion.trim() !== '') {
                    const opcionEscapada = opcion.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    html += `
                        <label class="option-label">
                            <input type="radio" name="pregunta_${pregunta.ID_Pregunta}" 
                                   value="${opcionEscapada}" 
                                   onchange="guardarRespuestaOpcion('${pregunta.ID_Pregunta}', this.value)">
                            <span class="option-text">${opcion}</span>
                        </label>
                    `;
                }
            }
            html += '</div>';
            
        } else if (tipo === 'texto_abierto' || tipo === 'texto') {
            html += `
                <textarea class="question-textarea" 
                          id="texto_${pregunta.ID_Pregunta}" 
                          placeholder="Escribe tu respuesta aquÃ­..."
                          oninput="guardarRespuestaTexto('${pregunta.ID_Pregunta}')"></textarea>
            `;
            
        } else if (tipo === 'archivo') {
            html += `
                <input type="file" id="archivo_${pregunta.ID_Pregunta}" class="question-file-input" 
                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip"
                       onchange="manejarArchivoEncuesta('${pregunta.ID_Pregunta}', this)">
                <label for="archivo_${pregunta.ID_Pregunta}" class="file-upload-btn">
                    ðŸ“Ž Seleccionar archivo
                </label>
                <div class="file-info" id="file-info-${pregunta.ID_Pregunta}"></div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    function guardarRespuestaOpcion(idPregunta, valor) {
        respuestasEncuesta[idPregunta] = valor;
        console.log('ðŸ’¾ Respuesta opciÃ³n guardada:', idPregunta, '=', valor);
        verificarCompletitud();
    }

    function guardarRespuestaTexto(idPregunta) {
        const textarea = document.getElementById(`texto_${idPregunta}`);
        if (textarea) {
            const valor = textarea.value;
            respuestasEncuesta[idPregunta] = valor;
            console.log('ðŸ’¾ Respuesta texto guardada:', idPregunta, '=', valor.substring(0, 50) + (valor.length > 50 ? '...' : ''));
            verificarCompletitud();
        }
    }

    function manejarArchivoEncuesta(idPregunta, input) {
        const file = input.files[0];
        if (!file) return;
        
        const fileInfo = document.getElementById(`file-info-${idPregunta}`);
        
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            fileInfo.textContent = `âŒ El archivo es demasiado grande. MÃ¡ximo 10 MB.`;
            fileInfo.style.display = 'block';
            fileInfo.style.color = 'var(--error)';
            input.value = '';
            return;
        }
        
        fileInfo.textContent = `ðŸ“¤ Cargando: ${file.name}...`;
        fileInfo.style.display = 'block';
        fileInfo.style.color = 'var(--azul)';
        
        const reader = new FileReader();
        reader.onload = function(e) {
            archivosEncuesta[idPregunta] = {
                base64: e.target.result,
                nombre: file.name,
                tamaÃ±o: file.size
            };
            respuestasEncuesta[idPregunta] = `Archivo: ${file.name}`;
            fileInfo.textContent = `âœ… Listo: ${file.name} (${formatBytes(file.size)})`;
            fileInfo.style.color = 'var(--success)';
            console.log('ðŸ“Ž Archivo cargado:', idPregunta, file.name, formatBytes(file.size));
            verificarCompletitud();
        };
        reader.onerror = function() {
            fileInfo.textContent = 'âŒ Error al cargar archivo';
            fileInfo.style.color = 'var(--error)';
        };
        reader.readAsDataURL(file);
    }

    function verificarCompletitud() {
        let todasRespondidas = true;
        preguntasEncuestaActual.forEach(pregunta => {
            if (!respuestasEncuesta[pregunta.ID_Pregunta] || 
                (typeof respuestasEncuesta[pregunta.ID_Pregunta] === 'string' && 
                 respuestasEncuesta[pregunta.ID_Pregunta].trim() === '')) {
                todasRespondidas = false;
            }
        });
        
        const btnEnviar = document.querySelector('#surveyActions .btn-primary');
        if (btnEnviar) {
            if (todasRespondidas) {
                btnEnviar.classList.remove('disabled');
                btnEnviar.style.opacity = '1';
            } else {
                btnEnviar.style.opacity = '0.6';
            }
        }
    }

    function restaurarRespuestasPrevias() {
        Object.keys(respuestasEncuesta).forEach(idPregunta => {
            const valor = respuestasEncuesta[idPregunta];
            
            const textarea = document.getElementById(`texto_${idPregunta}`);
            if (textarea) {
                textarea.value = valor;
            }
            
            const radio = document.querySelector(`input[name="pregunta_${idPregunta}"][value="${valor}"]`);
            if (radio) {
                radio.checked = true;
            }
        });
        verificarCompletitud();
    }

    async function enviarRespuestasEncuesta() {
        const sinResponder = [];
        preguntasEncuestaActual.forEach(pregunta => {
            const respuesta = respuestasEncuesta[pregunta.ID_Pregunta];
            if (!respuesta || (typeof respuesta === 'string' && respuesta.trim() === '')) {
                sinResponder.push(pregunta.Numero_Pregunta || '?');
            }
        });
        
        if (sinResponder.length > 0) {
            showNotification(`âŒ Faltan respuestas en las preguntas: ${sinResponder.join(', ')}`, 'error');
            return;
        }
        
        showNotification('ðŸ”„ Procesando respuestas...');
        
        try {
            for (const idPregunta in archivosEncuesta) {
                const archivoData = archivosEncuesta[idPregunta];
                
                showNotification(`ðŸ“¤ Subiendo: ${archivoData.nombre}...`);
                
                try {
                    const resultado = await subirArchivoGitHub(
                        archivoData.base64,
                        archivoData.nombre,
                        alumnoActual.ID_Alumno,
                        idPregunta
                    );
                    
                    if (resultado.success) {
                        archivosEncuesta[idPregunta].url = resultado.url;
                        archivosEncuesta[idPregunta].urlViewer = resultado.urlViewer;
                        respuestasEncuesta[idPregunta] = resultado.url;
                        
                        console.log('âœ… Archivo subido a GitHub:', archivoData.nombre);
                        console.log('ðŸ”— URL:', resultado.url);
                    } else {
                        console.warn('âš ï¸ FallÃ³ subida a GitHub, guardando referencia local');
                        respuestasEncuesta[idPregunta] = `ARCHIVO_NO_SUBIDO:${archivoData.nombre}`;
                        showNotification(`âš ï¸ El archivo ${archivoData.nombre} no se pudo subir, pero guardaremos tu respuesta`, 'warning');
                    }
                } catch (error) {
                    console.error('âŒ Error en subida individual:', error);
                    respuestasEncuesta[idPregunta] = `ERROR_SUBIDA:${archivoData.nombre}`;
                    showNotification(`âš ï¸ Error con ${archivoData.nombre}, pero continuamos...`, 'warning');
                }
            }
            
            const respuestasArray = preguntasEncuestaActual.map(pregunta => {
                const tipoOriginal = pregunta.Tipo_Pregunta || '';
                const respuestaAlumno = respuestasEncuesta[pregunta.ID_Pregunta] || '';
                const urlArchivo = archivosEncuesta[pregunta.ID_Pregunta] ? 
                                  archivosEncuesta[pregunta.ID_Pregunta].url : '';
                
                return {
                    ID_Pregunta: pregunta.ID_Pregunta,
                    Respuesta_Alumno: respuestaAlumno,
                    Respuesta_Correcta: pregunta.Respuesta_Correcta || '',
                    Tipo_Pregunta: tipoOriginal,
                    Puntaje_Pregunta: parseFloat(pregunta.Puntaje_Pregunta || 1),
                    URL_Archivo: urlArchivo
                };
            });
            
            const datosGuardar = {
                idAlumno: alumnoActual.ID_Alumno,
                idClase: currentClaseId,
                idEncuesta: currentEncuestaId,
                respuestas: respuestasArray
            };
            
            console.log('ðŸ’¾ Enviando respuestas al backend:', datosGuardar);
            
            showNotification('ðŸ’¾ Guardando respuestas...');
            
            const resultado = await callJSONP('guardarRespuestasAlumno', datosGuardar);
            
            if (resultado.success) {
                const calificacion = resultado.calificacion || 0;
                
                if (!userProgress[currentClaseId]) {
                    userProgress[currentClaseId] = {};
                }
                userProgress[currentClaseId].calificacion = calificacion;
                userProgress[currentClaseId].completed = true;
                
                await loadUserProgress(alumnoActual.ID_Alumno);
                
                mostrarResultadoEncuesta(resultado);
            } else {
                showNotification('âŒ Error al guardar respuestas: ' + resultado.error, 'error');
            }
            
        } catch (error) {
            console.error('âŒ Error enviando respuestas:', error);
            showNotification('âŒ Error: ' + error.message, 'error');
        }
    }

    function mostrarResultadoEncuesta(resultado) {
        const calificacion = resultado.calificacion || 0;
        const puntajeObtenido = resultado.puntaje_obtenido || 0;
        const puntajeMaximo = resultado.puntaje_maximo || 1;
        
        let mensaje = '';
        if (calificacion >= 90) mensaje = 'Â¡Excelente trabajo! ðŸŽ‰';
        else if (calificacion >= 70) mensaje = 'Â¡Muy bien! ðŸ‘';
        else if (calificacion >= 50) mensaje = 'Buen intento ðŸ‘';
        else mensaje = 'Sigue practicando ðŸ’ª';
        
        const html = `
            <div class="survey-resultado">
                <div class="resultado-header">
                    <h2>ðŸŽ‰ Â¡Encuesta Completada!</h2>
                    <div class="resultado-score">${calificacion}%</div>
                    <div class="resultado-mensaje">${mensaje}</div>
                </div>
                <p style="text-align: center; color: var(--gray); margin: 20px 0;">
                    Has obtenido <strong>${puntajeObtenido}</strong> de <strong>${puntajeMaximo}</strong> puntos.
                </p>
                <p style="text-align: center; color: var(--gray); font-size: 14px;">
                    ${puntajeObtenido < puntajeMaximo ? 'Las preguntas de texto y archivo serÃ¡n calificadas manualmente por el instructor.' : ''}
                </p>
            </div>
        `;
        
        document.getElementById('surveyBody').innerHTML = html;
        document.getElementById('surveyActions').innerHTML = `
            <button class="btn btn-primary" onclick="cerrarYActualizarEncuesta()" style="width: 100%;">Cerrar</button>
        `;
        
        showNotification('âœ… Respuestas guardadas correctamente');
    }

    async function mostrarRevisionEncuesta(encuestaId, claseId) {
        showNotification('ðŸ”„ Cargando revisiÃ³n...');
        
        try {
            const resultado = await callJSONP('obtenerRespuestasAlumno', {
                alumnoId: alumnoActual.ID_Alumno,
                encuestaId: encuestaId
            });
            
            if (resultado.success && resultado.data) {
                renderizarRevisionEncuesta(resultado.data);
            } else {
                showNotification('âŒ Error cargando revisiÃ³n', 'error');
            }
            
        } catch (error) {
            showNotification('âŒ Error: ' + error.message, 'error');
        }
    }

    function renderizarRevisionEncuesta(respuestas) {
        const encuesta = todasEncuestas.find(e => e.ID_Encuesta === currentEncuestaId);
        
        let correctas = 0;
        let incorrectas = 0;
        let pendientes = 0;
        let puntajeTotal = 0;
        let puntajeMaximo = 0;
        
        respuestas.forEach(r => {
            puntajeTotal += parseFloat(r.Puntaje_Obtenido) || 0;
            puntajeMaximo += parseFloat(r.Puntaje_Pregunta) || 0;
            
            if (r.Estado === 'CALIFICADO') {
                if (r.Es_Correcta) correctas++;
                else incorrectas++;
            } else {
                pendientes++;
            }
        });
        
        const porcentaje = puntajeMaximo > 0 ? Math.round((puntajeTotal / puntajeMaximo) * 100) : 0;
        
        let html = `
            <div class="survey-resultado">
                <div class="resultado-header">
                    <h3>${encuesta ? encuesta.Nombre_Encuesta : 'Encuesta Completada'}</h3>
                    <div class="resultado-score">${porcentaje}%</div>
                    <div style="display: flex; justify-content: space-around; margin-top: 20px; color: white;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${correctas}</div>
                            <div>Correctas</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${incorrectas}</div>
                            <div>Incorrectas</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${pendientes}</div>
                            <div>Pendientes</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">Puntaje: ${puntajeTotal} / ${puntajeMaximo}</div>
                </div>
                
                <div style="margin-top: 20px;">
        `;
        
        respuestas.forEach(r => {
            const statusClass = r.Estado === 'CALIFICADO' ? (r.Es_Correcta ? 'correcta' : 'incorrecta') : 'pendiente';
            const statusText = r.Estado === 'CALIFICADO' ? (r.Es_Correcta ? 'âœ… Correcta' : 'âŒ Incorrecta') : 'â³ Pendiente';
            
            html += `
                <div class="revision-question ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${r.Numero_Pregunta}. ${r.Enunciado}</strong>
                        <div>
                            <span class="revision-status ${statusClass}">${statusText}</span>
                            <span class="puntaje-badge">${r.Puntaje_Obtenido} / ${r.Puntaje_Pregunta} pts</span>
                        </div>
                    </div>
            `;
            
            if (r.Opciones && r.Opciones.length > 0) {
                html += '<div style="margin: 10px 0;"><strong>Opciones:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                r.Opciones.forEach(op => {
                    const isCorrecta = op === r.Respuesta_Correcta;
                    const isAlumno = op === r.Respuesta_Alumno;
                    let style = '';
                    if (isCorrecta) style = 'color: var(--success); font-weight: bold;';
                    if (isAlumno && !isCorrecta) style = 'color: var(--error); font-weight: bold;';
                    
                    html += `<li style="${style}">${op}${isCorrecta ? ' (Correcta)' : ''}${isAlumno ? ' (Tu respuesta)' : ''}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += `<div class="respuesta-alumno"><strong>Tu respuesta:</strong> ${r.Respuesta_Alumno}`;
            if (r.URL_Archivo) {
                html += ` <a href="${r.URL_Archivo}" target="_blank" style="color: var(--azul); text-decoration: none;">ðŸ“Ž Ver archivo</a>`;
            }
            html += '</div>';
            
            if (r.Tipo_Pregunta === 'MULTIPLE_CHOICE' && r.Respuesta_Correcta) {
                html += `<div class="respuesta-correcta"><strong>Respuesta correcta:</strong> ${r.Respuesta_Correcta}</div>`;
            }
            
            if (r.Comentario_Maestro) {
                html += `<div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid var(--azul);">
                    <strong>ðŸ’¬ Comentario del Maestro:</strong><br>${r.Comentario_Maestro}
                </div>`;
            }
            
            html += '</div>';
        });
        
        html += '</div></div>';
        
        document.getElementById('surveyBody').innerHTML = html;
        document.getElementById('surveyActions').innerHTML = `
            <button class="btn btn-primary" onclick="closeSurveyModal()" style="width: 100%;">Cerrar</button>
        `;
        
        document.getElementById('surveyModalTitle').textContent = 'RevisiÃ³n de Encuesta';
        document.getElementById('universalSurveyModal').style.display = 'flex';
    }

    function closeSurveyModal() {
        document.getElementById('universalSurveyModal').style.display = 'none';
        currentEncuestaId = null;
        currentClaseId = null;
        preguntasEncuestaActual = [];
        respuestasEncuesta = {};
        archivosEncuesta = {};
    }

    function cerrarYActualizarEncuesta() {
        const encuestaIdTemp = currentEncuestaId;
        const claseIdTemp = currentClaseId;
        
        closeSurveyModal();
        
        if (claseIdTemp && userProgress[claseIdTemp]) {
            const calificacion = userProgress[claseIdTemp].calificacion || 0;
            const calificacionContainer = document.querySelector(`[data-lesson="${claseIdTemp}"] .calificacion-container`);
            
            if (calificacionContainer) {
                calificacionContainer.innerHTML = renderCalificacionEstrellasHTML(calificacion);
            }
            
            const botonEncuesta = document.getElementById(`encuesta-btn-${claseIdTemp}`);
            if (botonEncuesta) {
                botonEncuesta.innerHTML = 'âœ… Corregida';
                botonEncuesta.classList.remove('btn-primary');
                botonEncuesta.classList.add('btn-secondary');
                botonEncuesta.style.opacity = '0.7';
                botonEncuesta.onclick = function(e) {
                    e.stopPropagation();
                    mostrarRevisionEncuesta(encuestaIdTemp, claseIdTemp);
                };
            }
        }
        
        showNotification('âœ… Encuesta completada y guardada');
    }

    async function verificarYActualizarBotonesEncuesta() {
        if (!alumnoActual) return;
        
        try {
            const botonesEncuesta = document.querySelectorAll('[id^="encuesta-btn-"]');
            
            for (const boton of botonesEncuesta) {
                const claseId = boton.id.replace('encuesta-btn-', '');
                const onclickText = boton.getAttribute('onclick');
                
                const match = onclickText.match(/abrirEncuesta\(['"]([^'"]+)['"],\s*['"]([^'"]+)['"]\)/);
                
                if (match) {
                    const encuestaId = match[1];
                    const claseIdFromOnclick = match[2];
                    
                    const verificacion = await callJSONP('verificarEncuestaCompletada', {
                        alumnoId: alumnoActual.ID_Alumno,
                        encuestaId: encuestaId,
                        claseId: claseIdFromOnclick
                    });
                    
                    if (verificacion.success && verificacion.completada) {
                        boton.innerHTML = 'âœ… Corregida';
                        boton.classList.remove('btn-primary');
                        boton.classList.add('btn-secondary');
                        boton.style.opacity = '0.7';
                        boton.onclick = function(e) {
                            e.stopPropagation();
                            mostrarRevisionEncuesta(encuestaId, claseIdFromOnclick);
                        };
                    }
                }
            }
        } catch (error) {
            console.error('Error verificando estado de encuestas:', error);
        }
    }

    // === SISTEMA DE MÃ“DULOS Y CLASES ===
    async function accederAlCurso(cursoId, grupoId) {
        currentCourseId = cursoId;
        currentGrupoId = grupoId;
        
        const misCursosCache = JSON.parse(sessionStorage.getItem(`mis_cursos_${alumnoActual.ID_Alumno}`) || '[]');
        currentCourseData = misCursosCache.find(curso => 
            curso.ID_Curso === cursoId && curso.ID_Grupo === grupoId
        );
        
        if (!currentCourseData) {
            showNotification('âŒ No tienes acceso a este curso', 'error');
            return;
        }

        document.getElementById('courseTitle').textContent = currentCourseData.Nombre_Curso;
        document.getElementById('courseDescription').textContent = currentCourseData.Descripcion || 'No hay descripciÃ³n disponible para este curso.';
        
        if (currentCourseData.Foto_Cabecera) {
            document.getElementById('courseHeaderImage').src = currentCourseData.Foto_Cabecera;
            document.getElementById('courseHeaderImage').style.display = 'block';
        } else {
            document.getElementById('courseHeaderImage').style.display = 'none';
        }
        
        updateCourseInfo();
        updateCourseButtons();
        
        document.getElementById('courseHeader').style.display = 'block';
        
        document.getElementById('misCursosContainer').style.display = 'none';
        document.getElementById('cursosDisponiblesContainer').style.display = 'none';
        document.querySelectorAll('.section-title, .section-subtitle').forEach(el => el.style.display = 'none');
        
        const container = document.getElementById('modulesContainer');
        container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button><div class="loading">Cargando mÃ³dulos...</div>';
        
        setTimeout(() => {
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
        
        const cacheKey = `modulos_${alumnoActual.ID_Alumno}_${cursoId}_${grupoId}`;
        const cached = sessionStorage.getItem(cacheKey);
        
        if (cached) {
            console.log('Cargando mÃ³dulos desde cache frontend');
            displayModulos(JSON.parse(cached), cursoId, grupoId);
        } else {
            try {
                const result = await callJSONP('getModulosCurso', {
                    alumnoId: alumnoActual.ID_Alumno,
                    cursoId: cursoId,
                    grupoId: grupoId
                });
                sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                displayModulos(result.data, cursoId, grupoId);
            } catch (error) {
                container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button><div class="error">Error al cargar mÃ³dulos: ' + error.message + '</div>';
            }
        }
    }

    function updateCourseInfo() {
        const infoContainer = document.getElementById('courseInfoText');
        infoContainer.innerHTML = '';
        
        let hasInfo = false;
        
        if (currentCourseData.Mensaje) {
            hasInfo = true;
            const messageItem = document.createElement('div');
            messageItem.className = 'course-info-item';
            messageItem.innerHTML = `
                <div class="course-info-icon">ðŸ“¢</div>
                <div class="course-info-content">
                    <div class="course-info-label">Mensaje Importante</div>
                    <div class="course-info-value">${currentCourseData.Mensaje}</div>
                </div>
            `;
            infoContainer.appendChild(messageItem);
        }
        
        infoContainer.style.display = hasInfo ? 'block' : 'none';
    }

    function updateCourseButtons() {
        const buttonsContainer = document.getElementById('courseButtonsContainer');
        buttonsContainer.innerHTML = '';
        
        let hasButtons = false;
        
        const emojiContainer = document.createElement('div');
        emojiContainer.className = 'course-emoji-btns';
        
        if (currentCourseData.Manual_c) {
            hasButtons = true;
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'course-emoji-btn';
            emojiBtn.innerHTML = 'ðŸ“˜';
            emojiBtn.title = 'Manual del Curso';
            emojiBtn.onclick = function() {
                showCourseManual(currentCourseData.Manual_c);
            };
            emojiContainer.appendChild(emojiBtn);
        }
        
        if (currentCourseData.Calendario) {
            hasButtons = true;
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'course-emoji-btn';
            emojiBtn.innerHTML = 'ðŸ“…';
            emojiBtn.title = 'Calendario Lectivo';
            emojiBtn.onclick = function() {
                openManualViewer(currentCourseData.Calendario, 'Calendario Lectivo');
            };
            emojiContainer.appendChild(emojiBtn);
        }
        
        if (currentCourseData.Whatsapp) {
            hasButtons = true;
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'course-emoji-btn whatsapp';
            emojiBtn.innerHTML = 'ðŸ“±';
            emojiBtn.title = 'WhatsApp del Grupo';
            emojiBtn.onclick = function() {
                window.open(currentCourseData.Whatsapp, '_blank');
            };
            emojiContainer.appendChild(emojiBtn);
        }
        
        if (hasButtons) {
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'course-toggle-btn';
            toggleBtn.innerHTML = 'ðŸ“‹ mÃ¡s...';
            toggleBtn.onclick = function() {
                const fullButtons = document.getElementById('courseFullButtons');
                if (fullButtons.classList.contains('show')) {
                    fullButtons.classList.remove('show');
                    toggleBtn.innerHTML = 'ðŸ“‹ mÃ¡s...';
                } else {
                    fullButtons.classList.add('show');
                    toggleBtn.innerHTML = 'ðŸ“‹ menos...';
                }
            };
            
            buttonsContainer.appendChild(emojiContainer);
            buttonsContainer.appendChild(toggleBtn);
            
            const fullButtonsContainer = document.createElement('div');
            fullButtonsContainer.id = 'courseFullButtons';
            fullButtonsContainer.className = 'course-full-buttons';
            
            if (currentCourseData.Manual_c) {
                const fullBtn = document.createElement('button');
                fullBtn.className = 'btn btn-primary';
                fullBtn.innerHTML = 'ðŸ“˜ Manual del Curso';
                fullBtn.onclick = function() {
                    showCourseManual(currentCourseData.Manual_c);
                };
                fullButtonsContainer.appendChild(fullBtn);
            }
            
            if (currentCourseData.Calendario) {
                const fullBtn = document.createElement('button');
                fullBtn.className = 'btn btn-secondary';
                fullBtn.innerHTML = 'ðŸ“… Calendario Lectivo';
                fullBtn.onclick = function() {
                    openManualViewer(currentCourseData.Calendario, 'Calendario Lectivo');
                };
                fullButtonsContainer.appendChild(fullBtn);
            }
            
            if (currentCourseData.Whatsapp) {
                const fullBtn = document.createElement('button');
                fullBtn.className = 'btn btn-success';
                fullBtn.innerHTML = 'ðŸ“± WhatsApp del Grupo';
                fullBtn.onclick = function() {
                    window.open(currentCourseData.Whatsapp, '_blank');
                };
                fullButtonsContainer.appendChild(fullBtn);
            }
            
            buttonsContainer.appendChild(fullButtonsContainer);
        }
    }

    function showCourseManual(manualUrl) {
        if (manualUrl) {
            openManualViewer(manualUrl, 'Manual del Curso');
        }
    }

    function volverACursos() {
        for (var lessonId in currentPlayers) {
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].destroy();
            }
        }
        currentPlayers = {};
        
        document.getElementById('courseHeader').style.display = 'none';
        
        const container = document.getElementById('modulesContainer');
        container.innerHTML = '';
        
        document.getElementById('misCursosContainer').style.display = 'grid';
        document.getElementById('cursosDisponiblesContainer').style.display = 'grid';
        document.querySelectorAll('.section-title, .section-subtitle').forEach(el => el.style.display = 'block');
    }

    function displayModulos(modules, cursoId, grupoId) {
        const container = document.getElementById("modulesContainer");
        container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button>';
        
        if (!modules || modules.length === 0) {
            container.innerHTML += "<p class='no-content'>No tienes mÃ³dulos disponibles en este momento.</p>";
            return;
        }
        
        userModules = modules;
        
        let modulesList = "<h3 style='color: var(--azul-oscuro); margin-bottom: 12px;'>Tus MÃ³dulos Disponibles:</h3><div class='grid grid-modulos'>";
        
        modules.forEach(module => {
            const progressPercentage = module.Total_Clases > 0 ? 
                Math.round((module.Clases_Completadas / module.Total_Clases) * 100) : 0;
            
            const hasImage = module.imagen_m && module.imagen_m.trim() !== '';
            
            modulesList += `
            <div class='module-card card' onclick='expandModule("${module.ID_MÃ³dulo}")'>
                <div class="module-imagen">
                    ${hasImage ? 
                        `<img src="${module.imagen_m}" 
                              alt="Imagen del mÃ³dulo" 
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                              onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                        ''
                    }
                    <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">ðŸ“š</div>
                </div>
                <h4 class="module-titulo">${module['Nombre del MÃ³dulo'] || module.Nombre_Modulo}</h4>
                <div class='progress-container'>
                    <div class='progress-label'>Progreso del MÃ³dulo</div>
                    <div class='progress-bar-container'>
                        <div class='progress-bar' style='width: ${progressPercentage}%'></div>
                    </div>
                    <div class='progress-text'>${progressPercentage}% completado</div>
                </div>
            </div>`;
        });
        
        modulesList += "</div>";
        container.innerHTML += modulesList;
    }

    function expandModule(moduleId) {
        document.querySelectorAll('.module-card').forEach(card => {
            card.style.display = 'none';
        });
        
        document.querySelector('#modulesContainer h3').style.display = 'none';
        
        var selectedModule = null;
        for (var i = 0; i < userModules.length; i++) {
            if (userModules[i].ID_MÃ³dulo === moduleId) {
                selectedModule = userModules[i];
                break;
            }
        }
        
        if (!selectedModule) return;
        
        var expandedContent = "<div class='expanded-module'>";
        
        expandedContent += `
        <div class='module-header-expanded card'>
            <div class='module-title-section'>
                <h2>${selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo}</h2>
            </div>
            <div class='module-content'>
                <div class='module-image-container'>
                    ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 
                        `<img src="${selectedModule['imagen_m']}" class='module-header-image' alt='Imagen del mÃ³dulo' onerror='this.style.display="none"; this.nextElementSibling.style.display="flex";' onload='this.style.display="block"; this.nextElementSibling.style.display="none";'>` : 
                        ''
                    }
                    <div style="width: 140px; height: 100px; background: linear-gradient(135deg, var(--azul), var(--naranja)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 'display: none;' : ''}">ðŸ“š</div>
                </div>
                <div class='module-info'>
                    <p class='module-description'>${selectedModule['DescripciÃ³n del MÃ³dulo'] || 'No hay descripciÃ³n disponible para este mÃ³dulo.'}</p>
                    <div class='module-buttons'>
                        ${selectedModule['Manual_m'] && selectedModule['Manual_m'].trim() !== '' ? 
                            `<button class='btn btn-secondary' onclick='showModuleManual("${selectedModule['Manual_m']}")'>ðŸ“˜ Manual del MÃ³dulo</button>` : 
                            ''
                        }
                    </div>
                </div>
            </div>
        </div>`;
        
        expandedContent += "<div class='module-header'>";
        expandedContent += "<button class='btn btn-secondary back-button' onclick='collapseModule()'>â† Mis MÃ³dulos</button>";
        expandedContent += "</div>";
        
        var completedCount = selectedModule.Clases_Completadas || 0;
        var totalCount = selectedModule.Total_Clases || 0;
        
        var progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        expandedContent += "<div class='module-progress-expanded progress-container'>";
        expandedContent += "<div class='progress-label'>Progreso del MÃ³dulo</div>";
        expandedContent += "<div class='progress-bar-container'>";
        expandedContent += "<div class='progress-bar' style='width: " + progressPercentage + "%'></div>";
        expandedContent += "</div>";
        expandedContent += "<div class='progress-text'>" + completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)</div>";
        expandedContent += "</div>";
        
        if (selectedModule.Clases && selectedModule.Clases.length > 0) {
            expandedContent += "<div class='content-list-expanded'>";
            
            for (var j = 0; j < selectedModule.Clases.length; j++) {
                var content = selectedModule.Clases[j];
                var lessonId = content.ID_Clase;
                var isCompleted = userProgress[lessonId] && userProgress[lessonId].completed;
                
                var hasNotes = userProgress[lessonId] && 
                              userProgress[lessonId].notes && 
                              typeof userProgress[lessonId].notes === 'string' && 
                              userProgress[lessonId].notes.trim() !== '';
                
                var tieneEncuesta = content.ID_Encuesta && content.ID_Encuesta.trim() !== '';
                
                var tieneCertificado = userProgress[lessonId] && 
                                      userProgress[lessonId].certificado && 
                                      userProgress[lessonId].certificado.trim() !== '';
                
                // âœ… CORREGIDO: VerificaciÃ³n mejorada - solo si tiene calificaciÃ³n Y es > 0
                var encuestaCompletada = userProgress[lessonId] && 
                                        userProgress[lessonId].hasOwnProperty('Calificacion') && 
                                        userProgress[lessonId].Calificacion > 0;
                
                expandedContent += `
                <div class='lesson-accordion ${isCompleted ? 'completed' : ''}' data-lesson="${lessonId}">
                    <div class='lesson-header' onclick="toggleLessonAccordion('${lessonId}')">
                        <div class='lesson-number-container'>
                            <div class='lesson-number'>${j+1}</div>
                            <div class='lesson-arrow'>â–¼</div>
                        </div>
                        <div class='lesson-thumbnail' onclick="event.stopPropagation(); toggleVideoPlayer('${lessonId}', '${content['URL Video']}')">`;
                
                var videoUrl = content['URL Video'] || '';
                var videoId = extractVideoId(videoUrl);
                if (videoId) {
                    var thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                    expandedContent += `
                                    <img src='${thumbnailUrl}' alt='Miniatura del video'>
                                    <div class='play-icon'>â–¶</div>`;
                } else {
                    expandedContent += `
                                    <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #64748b; font-size: 20px;">ðŸ“¹</div>`;
                }
                
                expandedContent += `
                        </div>
                        <div class='lesson-main-content'>
                            <div class='lesson-title'>${content['Nombre de la Clase'] || content.Nombre_Clase}</div>
                            <div class='lesson-description'>${content['DescripciÃ³n'] || 'No hay descripciÃ³n disponible para esta clase.'}</div>
                            
                            ${renderCalificacionEstrellas(lessonId, tieneEncuesta)}
                            
                            <div class='lesson-quick-actions'>
                                ${content['URL Video'] && content['URL Video'].trim() !== '' ? 
                                    `<button class='quick-action-btn' onclick="event.stopPropagation(); toggleVideoPlayer('${lessonId}', '${content['URL Video']}')" title="Ver Clase">
                                        â–¶ï¸<span class='btn-text'>Ver Clase</span>
                                    </button>` : ''
                                }
                                ${content['URL Manual'] && content['URL Manual'].trim() !== '' ? 
                                    `<button class='quick-action-btn' onclick="event.stopPropagation(); showManual('${lessonId}', '${content['URL Manual']}')" title="Manual Completo">
                                        ðŸ“š<span class='btn-text'>Manual</span>
                                    </button>` : ''
                                }
                                ${tieneEncuesta ? 
                                    `<button id='encuesta-btn-${lessonId}' class='quick-action-btn encuesta' onclick="event.stopPropagation(); ${encuestaCompletada ? `mostrarRevisionEncuesta('${content.ID_Encuesta}', '${lessonId}')` : `abrirEncuesta('${content.ID_Encuesta}', '${lessonId}')`}" title="${encuestaCompletada ? 'Corregida' : 'PruÃ©bate'}">
                                        ðŸŽ¯<span class='btn-text'>${encuestaCompletada ? 'Corregida' : 'PruÃ©bate'}</span>
                                    </button>` : ''
                                }
                                ${tieneCertificado ? 
                                    `<button class='quick-action-btn certificado' onclick="event.stopPropagation(); verCertificado('${userProgress[lessonId].certificado}')" title="Ver Certificado">
                                        ðŸ†<span class='btn-text'>Certificado</span>
                                    </button>` : ''
                                }
                                <button class='quick-action-btn' onclick="event.stopPropagation(); toggleNotes('${lessonId}')" title="Mis Notas">
                                    ðŸ“<span class='btn-text'>Notas</span>
                                </button>
                            </div>
                            
                            <div class='vista-button-container'>
                                <button id='vista-btn-${lessonId}' class='btn-vista ${isCompleted ? 'completed' : ''}' 
                                        onclick="event.stopPropagation(); toggleVista('${lessonId}', '${moduleId}', '${(selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo)}', '${(content['Nombre de la Clase'] || content.Nombre_Clase)}')">
                                    ${isCompleted ? 'Vista âœ“' : 'Vista'}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class='lesson-content'>
                        <div class='lesson-actions'>
                            <button id='video-btn-${lessonId}' class='btn btn-secondary action-btn' onclick='toggleVideoPlayer("${lessonId}", "${content['URL Video']}")'>â–¶ï¸ Ver Clase</button>`;
                
                if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                    expandedContent += `<button class='btn btn-secondary action-btn' onclick='showManual("${lessonId}", "${content['URL Manual']}")'>ðŸ“š Manual Completo</button>`;
                }
                
                if (tieneEncuesta) {
                    if (encuestaCompletada) {
                        expandedContent += `<button id='encuesta-btn-expanded-${lessonId}' class='btn btn-secondary action-btn' onclick='mostrarRevisionEncuesta("${content.ID_Encuesta}", "${lessonId}")' style="opacity: 0.7;">âœ… Corregida</button>`;
                    } else {
                        expandedContent += `<button id='encuesta-btn-expanded-${lessonId}' class='btn btn-primary action-btn' onclick='abrirEncuesta("${content.ID_Encuesta}", "${lessonId}")'>ðŸŽ¯ PruÃ©bate</button>`;
                    }
                }
                
                if (tieneCertificado) {
                    expandedContent += `<button class='btn btn-success action-btn' onclick='verCertificado("${userProgress[lessonId].certificado}")'>ðŸ† Ver Certificado</button>`;
                }
                
                expandedContent += `<button id='notes-btn-${lessonId}' class='btn btn-primary action-btn' onclick='toggleNotes("${lessonId}")'>ðŸ“ Mis Notas</button>`;
                
                if (j < selectedModule.Clases.length - 1) {
                    expandedContent += `<button class='btn btn-secondary action-btn' onclick='nextClass("${lessonId}", "${moduleId}")'>âž¡ï¸ Siguiente Clase</button>`;
                }
                
                expandedContent += `</div>
                    </div>
                </div>`;
                
                if (content['URL Video'] && content['URL Video'].trim() !== '') {
                    expandedContent += `<div id='player-container-${lessonId}' class='player-container' style='display: none;'>
                        <div class='video-container' id='videoContainer-${lessonId}'>
                            <div id='player-${lessonId}'></div>
                            <div class='overlay' id='overlay-${lessonId}'></div>
                            <div class='corner-box'>`;
                    if (escuelaData && escuelaData.Logo_Escuela) {
                        expandedContent += `<img src='${escuelaData.Logo_Escuela}' alt='Logo' class='school-logo-mini'>`;
                    } else {
                        expandedContent += "ðŸŽ“";
                    }
                    expandedContent += `</div>
                            <div class='exit-fullscreen' id='exitFullscreenBtn-${lessonId}'>âœ–</div>
                        </div>
                        <div class='controls-panel'>
                            <div class='progress-row'>
                                <div class='progress-container-player' id='progressBar-${lessonId}'>
                                    <div class='progress-player' id='progress-${lessonId}'></div>
                                    <div class='thumb' id='thumb-${lessonId}'></div>
                                </div>
                                <div class='time-display' id='timeDisplay-${lessonId}'>0:00 / 0:00</div>
                            </div>
                            <div class='video-controls'>
                                <button id='playPauseBtn-${lessonId}'>â–¶ Play</button>
                                <button id='restartBtn-${lessonId}'>â® Reiniciar</button>
                                <button id='fullscreenBtn-${lessonId}'>â›¶ Pantalla completa</button>
                            </div>
                        </div>
                    </div>`;
                }
                
                if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                    expandedContent += `<div id='manual-container-${lessonId}' class='manual-container card' style='display: none;'>
                        <div class='manual-header'>
                            <h4>ðŸ“š Material de Estudio</h4>
                            <p>Accede a tu contenido educativo</p>
                        </div>
                        <div class='content-links'>
                            <button class='btn btn-secondary action-btn' onclick='downloadManual("${lessonId}", "${content['URL Manual']}")'>ðŸ“¥ Descargar</button>
                            <button class='btn btn-secondary action-btn' onclick='printManual("${lessonId}")'>ðŸ–¨ï¸ Imprimir</button>
                        </div>
                        <div id='welcome-message-${lessonId}' class='welcome-message'>
                            <h5>Â¡Bienvenido!</h5>
                            <p>Haz clic en "Manual Completo" para acceder al material de estudio.</p>
                            <p>Una vez abierto, podrÃ¡s descargarlo o imprimirlo segÃºn necesites.</p>
                        </div>
                        <iframe id='pdf-frame-${lessonId}' class='pdf-frame' style='display: none; width: 100%; height: 500px; border: none;'></iframe>
                    </div>`;
                }
                
                expandedContent += `<div id='notes-area-${lessonId}' class='notes-area card' style='display: none;'>
                    <h4>Mis notas para esta lecciÃ³n:</h4>
                    <textarea id='notes-text-${lessonId}' class='notes-textarea' placeholder='Escribe tus notas aquÃ­...'>`;
                if (hasNotes) {
                    expandedContent += userProgress[lessonId].notes;
                }
                expandedContent += `</textarea>
                    <button id='save-notes-btn-${lessonId}' class='btn btn-primary save-notes-btn' onclick='saveNotes("${lessonId}", "${(selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo)}", "${(content['Nombre de la Clase'] || content.Nombre_Clase)}")'>Guardar notas</button>
                </div>`;
            }
            
            expandedContent += "</div>";
        } else {
            expandedContent += "<p class='no-content'>Contenido prÃ³ximamente...</p>";
        }
        
        expandedContent += "</div>";
        
        var expandedContainer = document.createElement('div');
        expandedContainer.id = 'expanded-module-container';
        expandedContainer.innerHTML = expandedContent;
        
        document.getElementById('modulesContainer').appendChild(expandedContainer);
        
        setTimeout(verificarYActualizarBotonesEncuesta, 1000);
        
        setTimeout(() => {
            expandedContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    function verCertificado(certificadoUrl) {
        if (certificadoUrl && certificadoUrl.trim() !== '') {
            openManualViewer(certificadoUrl, 'Tu Certificado ðŸ†');
        } else {
            showNotification('âŒ No hay certificado disponible', 'error');
        }
    }

    function collapseModule() {
        var expandedContainer = document.getElementById('expanded-module-container');
        if (expandedContainer) {
            expandedContainer.remove();
        }
        
        document.querySelectorAll('.module-card').forEach(card => {
            card.style.display = 'block';
        });
        
        document.querySelector('#modulesContainer h3').style.display = 'block';
        
        currentOpenAccordion = null;
    }

    function toggleLessonAccordion(lessonId) {
        const accordion = document.querySelector(`.lesson-accordion[data-lesson="${lessonId}"]`);
        
        if (accordion.classList.contains('active')) {
            accordion.classList.remove('active');
            hideVideoPlayer(lessonId);
            currentOpenAccordion = null;
            return;
        }
        
        if (currentOpenAccordion && currentOpenAccordion !== accordion) {
            const previousLessonId = currentOpenAccordion.getAttribute('data-lesson');
            currentOpenAccordion.classList.remove('active');
            hideVideoPlayer(previousLessonId);
        }
        
        accordion.classList.add('active');
        currentOpenAccordion = accordion;
    }

    function toggleVista(lessonId, moduleId, moduleName, lessonName) {
        const vistaBtn = document.getElementById('vista-btn-' + lessonId);
        const isCurrentlyCompleted = vistaBtn.classList.contains('completed');
        const newCompletedState = !isCurrentlyCompleted;
        
        if (newCompletedState) {
            vistaBtn.classList.add('completed');
            vistaBtn.textContent = 'Vista âœ“';
        } else {
            vistaBtn.classList.remove('completed');
            vistaBtn.textContent = 'Vista';
        }
        
        markAsViewed(lessonId, moduleId, moduleName, lessonName, {checked: newCompletedState});
    }

    async function markAsViewed(lessonId, moduleId, moduleName, lessonName, checkbox) {
        const completed = checkbox.checked;
        const notes = userProgress[lessonId] ? userProgress[lessonId].notes : '';
        
        console.log('ðŸ“Œ Marcando clase como vista:', {
            lessonId,
            moduleId,
            completed,
            hasNotes: !!notes
        });
        
        const contentItem = document.querySelector(`.lesson-accordion[data-lesson="${lessonId}"]`);
        if (completed) {
            contentItem.classList.add('completed');
        } else {
            contentItem.classList.remove('completed');
        }
        
        const vistaBtn = document.getElementById('vista-btn-' + lessonId);
        if (vistaBtn) {
            if (completed) {
                vistaBtn.classList.add('completed');
                vistaBtn.textContent = 'Vista âœ“';
            } else {
                vistaBtn.classList.remove('completed');
                vistaBtn.textContent = 'Vista';
            }
        }
        
        try {
            const saveResult = await saveProgressToDatabase(lessonId, completed, notes);
            
            console.log('âœ… Progreso guardado exitosamente:', saveResult);
            
            if (!userProgress[lessonId]) {
                userProgress[lessonId] = {};
            }
            
            userProgress[lessonId].completed = completed;
            userProgress[lessonId].notes = notes;
            userProgress[lessonId].lastUpdate = new Date();
            
            updateLocalCache();
            
            showNotification(completed ? 'âœ… LecciÃ³n completada' : 'ðŸ“ Progreso actualizado');
            
            updateModuleProgress(moduleId);
            
        } catch (error) {
            console.error('âŒ Error al guardar:', error);
            showNotification('âŒ Error al guardar: ' + error.message, 'error');
            
            checkbox.checked = !completed;
            
            if (completed) {
                contentItem.classList.remove('completed');
                if (vistaBtn) {
                    vistaBtn.classList.remove('completed');
                    vistaBtn.textContent = 'Vista';
                }
            } else {
                contentItem.classList.add('completed');
                if (vistaBtn) {
                    vistaBtn.classList.add('completed');
                    vistaBtn.textContent = 'Vista âœ“';
                }
            }
        }
    }

    async function saveProgressToDatabase(lessonId, completed, notes) {
        try {
            console.log('ðŸ’¾ Intentando guardar progreso:', {
                alumno: alumnoActual.ID_Alumno,
                clase: lessonId,
                completada: completed,
                notasLength: notes ? notes.length : 0
            });
            
            const params = {
                ID_Alumno: alumnoActual.ID_Alumno,
                ID_Clase: lessonId,
                Fecha_Guardado: new Date().toISOString().split('T')[0],
                Completada: completed ? "TRUE" : "FALSE",
                Notas_Alumno: notes || ''
            };
            
            console.log('ðŸ“¤ ParÃ¡metros enviados:', params);
            
            const response = await callJSONP('saveProgress', params);
            
            console.log('ðŸ“¥ Respuesta recibida:', response);
            
            if (!response.success) {
                throw new Error(response.error || 'Error al guardar el progreso');
            }
            
            return response;
            
        } catch (error) {
            console.error('ðŸ’¥ Error guardando progreso:', error);
            throw error;
        }
    }

    function updateModuleProgress(moduleId) {
        const selectedModule = userModules.find(m => m.ID_MÃ³dulo === moduleId);
        if (!selectedModule) return;
        
        let completedCount = 0;
        selectedModule.Clases.forEach(content => {
            if (userProgress[content.ID_Clase] && userProgress[content.ID_Clase].completed) {
                completedCount++;
            }
        });
        
        const totalCount = selectedModule.Clases.length;
        const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        const progressBar = document.querySelector('.module-progress-expanded .progress-bar');
        const progressText = document.querySelector('.module-progress-expanded .progress-text');
        
        if (progressBar) {
            progressBar.style.width = progressPercentage + '%';
        }
        
        if (progressText) {
            progressText.textContent = completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)";
        }
        
        const moduleCard = document.querySelector(`[onclick="expandModule('${moduleId}')"]`);
        if (moduleCard) {
            const cardProgressBar = moduleCard.querySelector('.progress-bar');
            const cardProgressText = moduleCard.querySelector('.progress-text');
            
            if (cardProgressBar) {
                cardProgressBar.style.width = progressPercentage + '%';
            }
            
            if (cardProgressText) {
                cardProgressText.textContent = progressPercentage + '% completado';
            }
        }
    }

    function updateLocalCache() {
        if (alumnoActual) {
            sessionStorage.removeItem(`cursos_${alumnoActual.ID_Alumno}`);
            if (currentCourseId && currentGrupoId) {
                sessionStorage.removeItem(`modulos_${alumnoActual.ID_Alumno}_${currentCourseId}_${currentGrupoId}`);
            }
        }
    }

    // === SISTEMA DE VIDEO ===
    function toggleVideoPlayer(lessonId, videoUrl) {
        const playerContainer = document.getElementById('player-container-' + lessonId);
        const videoBtn = document.getElementById('video-btn-' + lessonId);
        
        if (playerContainer.style.display === 'none' || !playerContainer.style.display) {
            showVideoPlayer(lessonId, videoUrl);
            if (videoBtn) videoBtn.textContent = 'âŒ Cerrar Video';
        } else {
            hideVideoPlayer(lessonId);
            if (videoBtn) videoBtn.textContent = 'â–¶ï¸ Ver Clase';
        }
    }

    function showVideoPlayer(lessonId, videoUrl) {
        var videoId = extractVideoId(videoUrl);
        if (!videoId) {
            showNotification("URL de video invÃ¡lida", "error");
            return;
        }

        pauseAllVideos();
        
        var playerContainer = document.getElementById('player-container-' + lessonId);
        
        document.querySelectorAll('.player-container').forEach(container => {
            if (container.id !== 'player-container-' + lessonId) {
                container.style.display = 'none';
                const otherLessonId = container.id.replace('player-container-', '');
                const otherVideoBtn = document.getElementById('video-btn-' + otherLessonId);
                if (otherVideoBtn) {
                    otherVideoBtn.textContent = 'â–¶ï¸ Ver Clase';
                }
            }
        });
        
        playerContainer.style.display = 'block';
        
        playerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        if (!currentPlayers[lessonId] || currentPlayers[lessonId].getVideoData === undefined) {
            createPlayer(lessonId, videoId);
        } else {
            currentPlayers[lessonId].cueVideoById(videoId);
            setTimeout(function() {
                adjustPlayerSize(lessonId);
            }, 100);
        }
    }

    function hideVideoPlayer(lessonId) {
        var playerContainer = document.getElementById('player-container-' + lessonId);
        if (playerContainer) {
            playerContainer.style.display = 'none';
        }
        
        if (currentPlayers[lessonId]) {
            currentPlayers[lessonId].pauseVideo();
        }
        
        const videoBtn = document.getElementById('video-btn-' + lessonId);
        if (videoBtn) {
            videoBtn.textContent = 'â–¶ï¸ Ver Clase';
        }
    }

    function pauseAllVideos() {
        for (var lessonId in currentPlayers) {
            if (currentPlayers[lessonId] && typeof currentPlayers[lessonId].pauseVideo === 'function') {
                currentPlayers[lessonId].pauseVideo();
            }
        }
    }

    function extractVideoId(url) {
        var regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        var match = url.match(regex);
        return match ? match[1] : null;
    }

    function createPlayer(lessonId, videoId) {
        var playerId = 'player-' + lessonId;
        
        currentPlayers[lessonId] = new YT.Player(playerId, {
            videoId: videoId,
            playerVars: { 
                controls: 0, 
                modestbranding: 1, 
                rel: 0, 
                iv_load_policy: 3,
                playsinline: 1
            },
            events: {
                onReady: function() { onPlayerReady(lessonId); },
                onStateChange: function(event) { onPlayerStateChange(lessonId, event); }
            }
        });
    }

    function onPlayerReady(lessonId) {
        var player = currentPlayers[lessonId];
        adjustPlayerSize(lessonId);
        setupCustomControls(lessonId);
        setInterval(function() { updateProgress(lessonId); }, 500);
    }

    function onPlayerStateChange(lessonId, event) {
        var btn = document.getElementById("playPauseBtn-" + lessonId);
        if (btn) {
            btn.textContent = event.data === YT.PlayerState.PLAYING ? "â¸ Pause" : "â–¶ Play";
        }
    }

    function adjustPlayerSize(lessonId) {
        var player = currentPlayers[lessonId];
        if (!player) return;
        
        var container = document.getElementById('videoContainer-' + lessonId);
        if (!container) return;
        
        var containerWidth = container.clientWidth;
        var containerHeight = containerWidth * 9 / 16;
        
        player.setSize(containerWidth, containerHeight);
    }

    function setupCustomControls(lessonId) {
        var overlay = document.getElementById("overlay-" + lessonId);
        var playPauseBtn = document.getElementById("playPauseBtn-" + lessonId);
        var restartBtn = document.getElementById("restartBtn-" + lessonId);
        var fullscreenBtn = document.getElementById("fullscreenBtn-" + lessonId);

        if (overlay) {
            overlay.onclick = function(e) { 
                if (!e.target.closest('.video-controls') && !e.target.closest('.exit-fullscreen')) {
                    togglePlayPause(lessonId); 
                }
            };
        }
        
        if (playPauseBtn) playPauseBtn.onclick = function() { togglePlayPause(lessonId); };
        if (restartBtn) restartBtn.onclick = function() { restartVideo(lessonId); };
        if (fullscreenBtn) fullscreenBtn.onclick = function() { goFullScreen(lessonId); };
    }

    function togglePlayPause(lessonId) {
        var player = currentPlayers[lessonId];
        if (!player) return;
        var state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
            player.pauseVideo();
        } else {
            player.playVideo();
        }
    }

    function restartVideo(lessonId) {
        var player = currentPlayers[lessonId];
        if (!player) return;
        player.seekTo(0, true);
        player.playVideo();
    }

    function goFullScreen(lessonId) {
        var container = document.getElementById("player-container-" + lessonId);
        if (!container) return;
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        }
    }

    function updateProgress(lessonId) {
        var player = currentPlayers[lessonId];
        if (!player || !player.getCurrentTime || dragging) return;
        var currentTime = player.getCurrentTime();
        var duration = player.getDuration();
        var percent = (currentTime / duration) * 100;
        var progressElement = document.getElementById("progress-" + lessonId);
        if (progressElement) {
            progressElement.style.width = percent + "%";
        }
    }

    // === SISTEMA DE NOTAS ===
    function toggleNotes(lessonId) {
        var notesArea = document.getElementById('notes-area-' + lessonId);
        
        if (notesArea.style.display === 'none' || !notesArea.style.display) {
            notesArea.style.display = 'block';
            var notesTextarea = document.getElementById('notes-text-' + lessonId);
            if (notesTextarea.value === '' && userProgress[lessonId] && userProgress[lessonId].notes) {
                notesTextarea.value = userProgress[lessonId].notes;
            }
        } else {
            notesArea.style.display = 'none';
        }
    }

    async function saveNotes(lessonId, moduleName, lessonName) {
        const notesText = document.getElementById('notes-text-' + lessonId).value;
        const saveButton = document.getElementById('save-notes-btn-' + lessonId);
        
        saveButton.textContent = 'Guardando...';
        saveButton.disabled = true;
        
        try {
            const isCompleted = userProgress[lessonId] ? userProgress[lessonId].completed : false;
            const saveResult = await saveProgressToDatabase(lessonId, isCompleted, notesText);
            
            if (!userProgress[lessonId]) {
                userProgress[lessonId] = {};
            }
            userProgress[lessonId].notes = notesText;
            userProgress[lessonId].lastUpdate = new Date();
            
            updateLocalCache();
            showNotification('âœ… Notas guardadas correctamente');
            saveButton.textContent = 'Guardado âœ“';
            
            setTimeout(() => {
                saveButton.textContent = 'Guardar notas';
                saveButton.disabled = false;
            }, 2000);
            
        } catch (error) {
            showNotification('âŒ Error: ' + error.message, 'error');
            saveButton.textContent = 'Guardar notas';
            saveButton.disabled = false;
        }
    }

    // === SISTEMA DE MANUALES ===
    function showModuleManual(manualUrl) {
        if (manualUrl) {
            openManualViewer(manualUrl, 'Manual del MÃ³dulo');
        }
    }

    function openManualViewer(manualUrl, title) {
        const modal = document.getElementById('universalManualModal');
        const frame = document.getElementById('manualModalFrame');
        const modalTitle = document.getElementById('manualModalTitle');
        
        if (modal && frame) {
            modalTitle.textContent = title;
            const viewerUrl = convertToGoogleDriveViewer(manualUrl);
            frame.src = viewerUrl;
            modal.style.display = 'flex';
        }
    }

    function closeManualViewer() {
        const modal = document.getElementById('universalManualModal');
        const frame = document.getElementById('manualModalFrame');
        if (modal && frame) {
            modal.style.display = 'none';
            frame.src = '';
        }
    }

    function convertToGoogleDriveViewer(url) {
        var fileId = extractGoogleDriveFileId(url);
        if (fileId) {
            return 'https://drive.google.com/file/d/' + fileId + '/preview';
        }
        return url;
    }

    function extractGoogleDriveFileId(url) {
        var match = url.match(/[-\w]{25,}/);
        return match ? match[0] : null;
    }

    function showManual(lessonId, manualUrl) {
        var manualContainer = document.getElementById('manual-container-' + lessonId);
        
        if (manualContainer.style.display === 'none' || !manualContainer.style.display) {
            manualContainer.style.display = 'block';
            var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            if (welcomeMessage) welcomeMessage.style.display = 'none';
            if (pdfFrame) {
                pdfFrame.style.display = 'block';
                var viewerUrl = convertToGoogleDriveViewer(manualUrl);
                pdfFrame.src = viewerUrl;
            }
        } else {
            hideManual(lessonId);
        }
    }

    function hideManual(lessonId) {
        var manualContainer = document.getElementById('manual-container-' + lessonId);
        if (manualContainer) {
            manualContainer.style.display = 'none';
        }
    }

    function downloadManual(lessonId, manualUrl) {
        window.open(manualUrl, '_blank');
    }

    function printManual(lessonId) {
        var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
        if (pdfFrame && pdfFrame.contentWindow) {
            try {
                pdfFrame.contentWindow.print();
            } catch (e) {
                window.open(pdfFrame.src, '_blank');
            }
        }
    }

    function nextClass(lessonId, moduleId) {
        var currentModule = null;
        for (var i = 0; i < userModules.length; i++) {
            if (userModules[i].ID_MÃ³dulo === moduleId) {
                currentModule = userModules[i];
                break;
            }
        }
        
        if (!currentModule || !currentModule.Clases) return;
        
        var currentIndex = -1;
        for (var j = 0; j < currentModule.Clases.length; j++) {
            if (currentModule.Clases[j].ID_Clase === lessonId) {
                currentIndex = j;
                break;
            }
        }
        
        if (currentIndex === -1 || currentIndex >= currentModule.Clases.length - 1) {
            showNotification("No hay mÃ¡s clases en este mÃ³dulo", "info");
            return;
        }
        
        var nextLesson = currentModule.Clases[currentIndex + 1];
        hideVideoPlayer(lessonId);
        
        if (nextLesson['URL Video'] && nextLesson['URL Video'].trim() !== '') {
            setTimeout(function() {
                showVideoPlayer(nextLesson.ID_Clase, nextLesson['URL Video']);
            }, 300);
        }
        
        var nextLessonElement = document.querySelector(`.lesson-accordion[data-lesson="${nextLesson.ID_Clase}"]`);
        if (nextLessonElement) {
            nextLessonElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        showNotification("Avanzando a la siguiente clase: " + nextLesson['Nombre de la Clase'], "success");
    }

    // === FUNCIONES DE REGISTRO Y RECUPERACIÃ“N ===
    function showRegisterModal() {
        document.getElementById('registerModal').style.display = 'flex';
        clearRegisterForm();
    }
    
    function closeRegisterModal() {
        document.getElementById('registerModal').style.display = 'none';
    }
    
    function showForgotPasswordModal() {
        document.getElementById('forgotPasswordModal').style.display = 'flex';
        document.getElementById('forgotPasswordErrorMessage').innerHTML = '';
        document.getElementById('forgotPasswordEmail').value = '';
    }
    
    function closeForgotPasswordModal() {
        document.getElementById('forgotPasswordModal').style.display = 'none';
    }
    
    function clearRegisterForm() {
        document.getElementById('registerName').value = '';
        document.getElementById('registerLastName').value = '';
        document.getElementById('registerUser').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPhone').value = '';
        document.getElementById('registerErrorMessage').innerHTML = '';
    }
    
    async function registerUser() {
        const name = document.getElementById('registerName').value.trim();
        const lastName = document.getElementById('registerLastName').value.trim();
        const user = document.getElementById('registerUser').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const phone = document.getElementById('registerPhone').value.trim();
        
        if (!name || !lastName || !user || !password || !email) {
            document.getElementById('registerErrorMessage').innerHTML = "Todos los campos excepto telÃ©fono son obligatorios";
            return;
        }
        
        if (password.length < 6) {
            document.getElementById('registerErrorMessage').innerHTML = "La contraseÃ±a debe tener al menos 6 caracteres";
            return;
        }
        
        document.getElementById('registerErrorMessage').innerHTML = "ðŸ”„ Creando cuenta...";
        
        try {
            const response = await callJSONP('register', {
                nombre: name,
                apellido: lastName,
                usuario: user,
                contraseÃ±a: password,
                email: email,
                telefono: phone
            });
            
            if (response.success) {
                showNotification('âœ… Cuenta creada exitosamente. Ahora puedes iniciar sesiÃ³n.');
                closeRegisterModal();
                document.getElementById('username').value = user;
                document.getElementById('password').value = '';
            } else {
                document.getElementById('registerErrorMessage').innerHTML = "âŒ " + response.error;
            }
        } catch (error) {
            document.getElementById('registerErrorMessage').innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
        }
    }
    
    async function sendPasswordReset() {
        const email = document.getElementById('forgotPasswordEmail').value.trim();
        
        if (!email) {
            document.getElementById('forgotPasswordErrorMessage').innerHTML = "Por favor ingresa tu correo electrÃ³nico";
            return;
        }
        
        document.getElementById('forgotPasswordErrorMessage').innerHTML = "ðŸ”„ Enviando enlace de recuperaciÃ³n...";
        
        try {
            const response = await callJSONP('forgotPassword', { email });
            
            if (response.success) {
                showNotification('âœ… Se ha enviado un enlace de recuperaciÃ³n a tu correo electrÃ³nico.');
                closeForgotPasswordModal();
            } else {
                document.getElementById('forgotPasswordErrorMessage').innerHTML = "âŒ " + response.error;
            }
        } catch (error) {
            document.getElementById('forgotPasswordErrorMessage').innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
        }
    }

    // === FUNCIÃ“N DE LOGOUT ===
    function logout() {
        for (var lessonId in currentPlayers) {
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].destroy();
            }
        }
        currentPlayers = {};
        currentUser = null;
        userProgress = {};
        userModules = [];
        alumnoActual = null;
        currentCourseData = null;
        currentOpenAccordion = null;
        currentPreviewCurso = null;
        
        sessionStorage.clear();
        
        document.getElementById('courseHeader').style.display = 'none';
        document.getElementById("page4_id1").style.display = "none";
        document.getElementById("page1_id1").style.display = "flex";
        clearErrors();
        clearForms();
    }

    function clearErrors() {
        document.getElementById("errorMessage").innerHTML = "";
    }
    
    function clearForms() {
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
    }

    // === EVENT LISTENERS ===
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeManualViewer();
            closeSurveyModal();
            closeRegisterModal();
            closeForgotPasswordModal();
            closeCursoPreview();
        }
    });

    // Permitir Enter para login
    document.addEventListener('DOMContentLoaded', function() {
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        if (usernameInput) {
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    LoginUser();
                }
            });
        }
        
        if (passwordInput) {
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    LoginUser();
                }
            });
        }
    });

    // Ajustar tamaÃ±o de video en resize
    window.addEventListener('resize', function() {
        for (var lessonId in currentPlayers) {
            if (currentPlayers[lessonId]) {
                adjustPlayerSize(lessonId);
            }
        }
    });

    console.log('âœ… Sistema completo cargado correctamente - VersiÃ³n 3.2 Corregida');
    console.log('ðŸ”§ Correcciones aplicadas:');
    console.log('   âœ“ Manejo correcto de calificaciÃ³n 0 vs vacÃ­o');
    console.log('   âœ“ VerificaciÃ³n mejorada con hasOwnProperty y > 0');
    console.log('   âœ“ Frontend robusto contra envÃ­o de 0 desde backend');
</script>
</body>
</html>
