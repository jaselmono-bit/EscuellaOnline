<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - Dashboard</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* === SISTEMA DE DISEÑO UNIFICADO === */
        :root {
            --naranja: #fbbf24;
            --naranja-claro: #fdba74;
            --azul: #3b82f6;
            --azul-claro: #0ea5e9;
            --azul-oscuro: #1e3a8a;
            --azul-profundo: #1e293b;
            --neutro: #f1f5f9;
            --blanco: #ffffff;
            --success: #10B981;
            --error: #EF4444;
            --gray: #64748B;
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sombra-intensa: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(160deg, var(--azul) 0%, var(--naranja) 100%);
            min-height: 100vh;
            color: var(--azul-profundo);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px 5px;
            min-height: calc(100vh - 10px);
        }

        /* === COMPONENTES REUTILIZABLES === */
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-intensa);
        }

        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        /* === LAYOUT PRINCIPAL === */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
        }

        .school-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .school-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--neutro);
            padding: 4px;
        }

        .user-welcome {
            text-align: right;
            flex: 1;
            min-width: 180px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* === SISTEMA DE NAVEGACIÓN === */
        .dashboard {
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            margin-bottom: 5px;
        }

        .back-btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            margin-bottom: 15px;
        }

        .back-btn:hover {
            transform: scale(1.05);
        }

        /* === SISTEMA DE GRILLAS RESPONSIVO === */
        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-cursos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .grid-modulos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* === TARJETAS DE CONTENIDO MEJORADAS === */
        .curso-card, .module-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            cursor: pointer;
            border-left: 5px solid var(--azul);
            border-right: 5px solid var(--naranja);
            display: flex;
            flex-direction: column;
        }

        .curso-card:hover, .module-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-intensa);
        }

        .curso-imagen, .module-imagen {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 50px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .curso-imagen img, .module-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: 10px;
        }

        .curso-card:hover .curso-imagen img,
        .module-card:hover .module-imagen img {
            transform: scale(1.05);
        }

        .curso-titulo, .module-titulo {
            font-size: 16px;
            font-weight: 700;
            color: var(--azul-oscuro);
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid var(--azul);
            padding-bottom: 8px;
            word-wrap: break-word;
        }

        /* === SISTEMA DE PROGRESO UNIFICADO === */
        .progress-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--neutro);
            border-radius: 6px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
            margin-bottom: 4px;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 8px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--gray);
            font-weight: 600;
        }

        /* === SISTEMA DE LECCIONES MEJORADO === */
        .content-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--azul);
            cursor: default;
        }

        .content-item.completed {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--azul);
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .lesson-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--azul);
        }

        .lesson-title {
            color: var(--azul-profundo);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            word-wrap: break-word;
        }

        .content-item.completed .lesson-title {
            text-decoration: line-through;
            color: var(--gray);
        }

        .lesson-preview {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            margin-left: 26px;
            align-items: flex-start;
        }

        .lesson-thumbnail {
            flex-shrink: 0;
            width: 140px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .lesson-thumbnail:hover {
            transform: scale(1.05);
        }

        .lesson-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .content-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: 26px;
            align-items: flex-start;
        }

        .action-btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            padding: 6px 12px;
            font-size: 11px;
            color: white !important;
        }

        /* === REPRODUCTOR DE VIDEO AVANZADO === */
        .player-container {
            background: #000;
            border-radius: 10px;
            padding: 0;
            margin: 12px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 100%;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin: 0 auto;
            aspect-ratio: 16/9;
        }

        .video-container.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: #000;
            border-radius: 0;
            aspect-ratio: unset;
        }

        .video-controls-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 0 0 8px 8px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 50;
            transition: opacity 0.3s ease;
        }

        .fullscreen-mode .video-controls-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100vw;
            border-radius: 0;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9998;
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .progress-bar-container.video {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            transition: height 0.2s;
        }

        .progress-bar-container.video:hover {
            height: 6px;
        }

        .fullscreen-mode .progress-bar-container.video {
            height: 8px;
        }

        .progress-bar.video {
            height: 100%;
            background: var(--azul-claro);
            border-radius: 2px;
            width: 0%;
            position: relative;
        }

        .fullscreen-mode .progress-bar.video {
            background: var(--naranja);
        }

        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 8px;
        }

        .control-btn {
            background: transparent;
            color: #fff;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.9;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
            transform: scale(1.05);
        }

        /* === SISTEMA DE LOGIN OPTIMIZADO === */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            width: 320px;
            padding: 25px;
            text-align: center;
        }

        input[type=text], input[type=password] {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            outline: none;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            background: white;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        input[type=text]:focus, input[type=password]:focus {
            border-bottom: 2px solid var(--naranja);
        }

        /* === COMPONENTES DE INTERFAZ AVANZADOS === */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 13px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error);
        }

        /* === ESTILOS ADICIONALES DEL SEGUNDO DOCUMENTO === */
        .course-header {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
            display: none;
        }

        .course-title-section {
            margin-bottom: 15px;
        }

        .course-title-section h1 {
            color: var(--azul-oscuro);
            font-size: 24px;
            margin: 0;
        }

        .course-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .course-image-container {
            flex-shrink: 0;
        }

        .course-header-image {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .course-info {
            flex: 1;
        }

        .course-description {
            margin-bottom: 15px;
            color: var(--gray);
        }

        .cursos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .curso-grupo {
            font-size: 14px;
            color: var(--gray);
            margin: 5px 0;
        }

        .btn-acceder {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-acceder:hover {
            transform: scale(1.05);
        }

        .back-to-courses-btn {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .back-to-courses-btn:hover {
            transform: scale(1.05);
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .module-progress {
            margin-top: 10px;
        }

        .progress-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .module-progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .module-progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        .module-progress-text {
            font-size: 11px;
            color: var(--gray);
            text-align: center;
        }

        .expanded-module {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            margin-top: 20px;
        }

        .module-header-expanded {
            margin-bottom: 20px;
        }

        .module-title-section h2 {
            color: var(--azul-oscuro);
            margin-bottom: 15px;
        }

        .module-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .module-image-container {
            flex-shrink: 0;
        }

        .module-header-image {
            width: 140px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .module-info {
            flex: 1;
        }

        .module-description {
            margin-bottom: 15px;
            color: var(--gray);
        }

        .module-manual-btn {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .module-manual-btn:hover {
            transform: scale(1.05);
        }

        .module-header {
            margin-bottom: 15px;
        }

        .back-button {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .back-button:hover {
            transform: scale(1.05);
        }

        .module-progress-expanded {
            background: var(--neutro);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }

        .content-list-expanded {
            margin-top: 20px;
        }

        .lesson-description {
            flex: 1;
            color: var(--gray);
            font-size: 13px;
        }

        .video-link, .manual-link, .notes-link, .next-class-link {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            font-size: 11px;
        }

        .video-link:hover, .manual-link:hover, .notes-link:hover, .next-class-link:hover {
            transform: scale(1.05);
        }

        .notes-area {
            background: var(--neutro);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin: 10px 0;
            resize: vertical;
        }

        .save-notes-btn {
            background: linear-gradient(to right, var(--success), #059669);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .save-notes-btn:hover {
            transform: scale(1.05);
        }

        .manual-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .manual-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .manual-header h4 {
            color: var(--azul-oscuro);
            margin: 0 0 5px 0;
        }

        .manual-header p {
            color: var(--gray);
            font-size: 13px;
            margin: 0;
        }

        .manual-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn-manual {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 12px;
        }

        .btn-manual:hover {
            transform: scale(1.05);
        }

        .welcome-message {
            text-align: center;
            padding: 20px;
            background: var(--neutro);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .welcome-message h5 {
            color: var(--azul-oscuro);
            margin: 0 0 10px 0;
        }

        .welcome-message p {
            color: var(--gray);
            font-size: 13px;
            margin: 5px 0;
        }

        .pdf-frame {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
        }

        .logout-btn-header {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .logout-btn-header:hover {
            transform: scale(1.05);
        }

        .course-manual-btn, .course-whatsapp-btn, .course-calendar-btn, .course-message-btn {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .course-manual-btn:hover, .course-whatsapp-btn:hover, .course-calendar-btn:hover, .course-message-btn:hover {
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        .error {
            text-align: center;
            padding: 20px;
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
        }

        .no-content {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }

        .image-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        /* === MODAL UNIFICADO === */
        #universalManualModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--azul-oscuro);
        }

        .close-modal {
            background: var(--error);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        #manualModalFrame {
            flex: 1;
            border: none;
            border-radius: 0 0 10px 10px;
        }

        /* === ESTILOS PARA REPRODUCTOR DE VIDEO === */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        .corner-box {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .corner-box.has-logo {
            background: rgba(255, 255, 255, 0.9);
            padding: 2px;
        }

        .exit-fullscreen {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
        }

        .progress-thumb {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 2;
        }

        .time-display {
            color: white;
            font-size: 12px;
            margin-left: 10px;
            white-space: nowrap;
        }

        .control-buttons-left, .control-buttons-right {
            display: flex;
            gap: 5px;
        }

        .controls-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .controls-active {
            opacity: 1;
        }

        /* === SISTEMA RESPONSIVO MEJORADO === */
        @media (max-width: 768px) {
            .container {
                padding: 10px 10px 5px;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 12px 15px;
            }
            
            .school-brand, .user-welcome {
                justify-content: center;
                text-align: center;
                min-width: auto;
            }

            .grid-cursos, .grid-modulos {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .lesson-preview {
                flex-direction: column;
                margin-left: 0;
            }
            
            .lesson-thumbnail {
                width: 100%;
                height: 150px;
            }
            
            .content-links {
                margin-left: 0;
                justify-content: center;
            }

            .control-btn-text {
                display: none;
            }

            .course-content, .module-content {
                flex-direction: column;
                align-items: center;
            }

            .course-header-image, .module-header-image {
                width: 100%;
                max-width: 200px;
                height: auto;
            }

            .manual-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn-manual {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .form-container {
                width: 100%;
                max-width: 300px;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
                justify-content: center;
            }

            .course-manual-btn, .course-whatsapp-btn, .course-calendar-btn, .course-message-btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Página 1: Login -->
    <div class="login-container" id="page1_id1">
        <div class="form-container">
            <div class="school-header">
                <div id="defaultLogo" style="font-size: 40px; margin-bottom: 12px;">🎓</div>
                <h1 class="login-title" id="schoolTitle">Plataforma Educativa</h1>
            </div>
            <input type="text" id="username" placeholder="Usuario" />
            <input type="password" id="password" placeholder="Contraseña" />
            <div class="error-message" id="errorMessage"></div>
            <input type="submit" value="Ingresar" onclick="LoginUser()" class="btn btn-primary" style="width: 100%; margin: 5px 0;" />
        </div>
    </div>

    <!-- Página 4: Dashboard del usuario -->
    <div class="dashboard page4_class1-off" id="page4_id1" style="display: none;">
        <!-- Cabecera Superior -->
        <div class="header-container">
            <div class="school-brand">
                <img id="schoolLogo" class="school-logo" src="" alt="Logo Escuela" onerror="this.style.display='none'">
                <div class="school-name" id="headerSchoolName">Plataforma Educativa</div>
            </div>
            <div class="user-welcome">
                <h2>¡Hola <span id="displayusername" style="color:var(--azul);"></span>!</h2>
                <div class="status-badge">Estado: <span id="userStatus">Activo</span></div>
                <button class="logout-btn-header" onclick="logout()">🚪 Cerrar Sesión</button>
            </div>
        </div>

        <!-- Cabecera del Curso (se muestra al acceder a un curso) -->
        <div id="courseHeader" class="course-header">
            <div class="course-title-section">
                <h1 id="courseTitle">Nombre del Curso</h1>
            </div>
            <div class="course-content">
                <div class="course-image-container">
                    <img id="courseHeaderImage" class="course-header-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
                </div>
                <div class="course-info">
                    <p id="courseDescription" class="course-description">Descripción del curso...</p>
                    <div id="courseButtons">
                        <!-- Los botones se agregarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <h2 style="color: var(--azul-oscuro); margin-bottom: 12px;" id="mainTitle">Mis Cursos</h2>
        <div id="cursosContainer" class="cursos-grid">
            <div class="loading">Cargando cursos...</div>
        </div>
        
        <div id="modulesContainer">
            <!-- Los módulos se cargarán aquí dinámicamente -->
        </div>
    </div>

    <!-- Modal Unificado para Manuales -->
    <div id="universalManualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manualModalTitle">Manual</h3>
                <button class="close-modal" onclick="closeManualViewer()">✕</button>
            </div>
            <iframe id="manualModalFrame"></iframe>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN GITHUB ===
        const CONFIG = {
            API_BASE_URL: 'https://escuuelaapi1.jorge-altagracia.workers.dev/'
        };

        // === VARIABLES GLOBALES ===
        let currentUser = null;
        let userProgress = {};
        let userModules = [];
        let currentPlayers = {};
        let alumnoActual = null;
        let cursosCache = null;
        let currentCourseId = null;
        let currentGrupoId = null;
        let escuelaData = null;
        let currentCourseData = null;

        // === SISTEMA DE JSONP MEJORADO ===
        function callJSONP(action, data = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Construir URL con parámetros
                const params = new URLSearchParams();
                params.append('action', action);
                params.append('callback', callbackName);
                
                // Agregar datos específicos
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        params.append(key, String(data[key]));
                    }
                });
                
                const url = CONFIG.API_BASE_URL + '?' + params.toString();
                
                console.log('🔍 Llamando a:', url);
                
                const script = document.createElement('script');
                script.src = url;
                
                // Configurar callback global
                window[callbackName] = function(response) {
                    // Limpiar
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    console.log('📨 Respuesta recibida:', response);
                    
                    if (response && response.success !== undefined) {
                        resolve(response);
                    } else {
                        reject(new Error(response ? response.error : 'Error desconocido'));
                    }
                };
                
                // Manejar errores
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Error de red al conectar con el servidor'));
                };
                
                // Timeout después de 30 segundos
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Timeout de la solicitud después de 30 segundos'));
                    }
                }, 30000);
                
                // Limpiar timeout cuando se recibe respuesta
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeoutId);
                    originalCallback(response);
                };
                
                document.body.appendChild(script);
            });
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSchoolData().catch(error => {
                console.log('No se pudieron cargar los datos de la escuela:', error.message);
            });
        });

        // === FUNCIONES PARA DATOS DE LA ESCUELA ===
        async function loadSchoolData() {
            try {
                const response = await callJSONP('escuela', {});
                if (response.data && response.data.length > 0) {
                    escuelaData = response.data[0];
                    updateSchoolUI();
                } else {
                    setDefaultSchoolData();
                }
            } catch (error) {
                console.error('Error cargando datos de la escuela:', error);
                setDefaultSchoolData();
            }
        }

        function updateSchoolUI() {
            if (!escuelaData) return;
            
            // Actualizar título en login
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle && escuelaData['Nombre_Escuela ']) {
                loginTitle.innerHTML = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar nombre en cabecera del dashboard
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName && escuelaData['Nombre_Escuela ']) {
                headerSchoolName.textContent = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar logo si existe
            if (escuelaData['Logo_Escuela']) {
                const logoImg = document.getElementById('schoolLogo');
                logoImg.src = escuelaData['Logo_Escuela'];
                logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                logoImg.style.display = 'block';
            }

            // Actualizar logo en login si existe
            if (escuelaData['Logo_Escuela']) {
                const loginHeader = document.querySelector('.school-header');
                if (loginHeader) {
                    const defaultLogo = document.getElementById('defaultLogo');
                    defaultLogo.style.display = 'none';
                    
                    const logoImg = document.createElement('img');
                    logoImg.src = escuelaData['Logo_Escuela'];
                    logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                    logoImg.className = 'school-logo';
                    logoImg.style.cssText = 'width: 50px; height: 50px; object-fit: contain; border-radius: 8px; background: var(--neutro); padding: 4px; margin-bottom: 12px;';
                    logoImg.onerror = function() {
                        this.style.display = 'none';
                        defaultLogo.style.display = 'block';
                    };
                    
                    loginHeader.insertBefore(logoImg, defaultLogo);
                }
            }
        }

        function setDefaultSchoolData() {
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle) {
                loginTitle.innerHTML = 'Plataforma Educativa';
            }
            
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName) {
                headerSchoolName.textContent = 'Plataforma Educativa';
            }
        }

        // === FUNCIONES DE LOGIN ===
        async function LoginUser() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            
            if (!username || !password) {
                document.getElementById("errorMessage").innerHTML = "Complete todos los campos";
                return;
            }
            
            document.getElementById("errorMessage").innerHTML = "🔐 Verificando credenciales...";
            
            try {
                const response = await callJSONP('login', { username, password });
                
                if(response.success) {
                    handleSuccessfulLogin(response);
                } else {
                    document.getElementById("errorMessage").innerHTML = "❌ " + response.error;
                }
            } catch (error) {
                document.getElementById("errorMessage").innerHTML = "🔒 Error de conexión: " + error.message;
            }
        }

        function handleSuccessfulLogin(response) {
            currentUser = response.alumno;
            alumnoActual = response.alumno;
            document.getElementById("displayusername").innerHTML = currentUser.Nombre + " " + currentUser.Apellido;
            
            // Mostrar dashboard
            document.getElementById("page1_id1").style.display = "none";
            document.getElementById("page4_id1").style.display = "block";
            document.getElementById("errorMessage").innerHTML = "";
            
            // Cargar progreso del usuario
            loadUserProgress(currentUser.ID_Alumno);
            loadCursos();
        }

        // === FUNCIÓN PARA CARGAR PROGRESO CORREGIDA ===
        async function loadUserProgress(alumnoId) {
            try {
                const result = await callJSONP('getUserProgress', { alumnoId: String(alumnoId) });
                userProgress = {};
                if (result.data && result.data.length > 0) {
                    result.data.forEach(function(item) {
                        userProgress[item.ID_Clase] = {
                            completed: item.Completada === "Sí" || item.Completada === "TRUE" || item.Completada === "sí",
                            notes: item.Notas_Alumno || '',
                            lastUpdate: item.Fecha_Guardado || new Date()
                        };
                    });
                }
                console.log("Progreso cargado:", userProgress);
            } catch (error) {
                console.error("Error cargando progreso:", error);
                userProgress = {};
            }
        }

        // === FUNCIONES DE CURSOS CON CACHE FRONTEND ===
        async function loadCursos() {
            const container = document.getElementById('cursosContainer');
            const cacheKey = `cursos_${alumnoActual.ID_Alumno}`;
            
            // Verificar cache local
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                console.log('Cargando cursos desde cache frontend');
                displayCursos(JSON.parse(cached));
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando cursos...</div>';
            
            try {
                const result = await callJSONP('getCursosAlumno', { alumnoId: alumnoActual.ID_Alumno });
                // Guardar en cache local
                sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                displayCursos(result.data);
            } catch (error) {
                showCursosError(error);
            }
        }

        function displayCursos(cursos) {
            cursosCache = cursos;
            const container = document.getElementById('cursosContainer');
            
            if (!cursos || cursos.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">🎓</div>
                        <h3 style="color: var(--azul-oscuro); margin-bottom: 6px;">No estás inscrito en ningún curso visible</h3>
                        <p style="color: var(--gray); margin-bottom: 12px;">
                            Contacta al administrador para inscribirte en los cursos.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cursos.map(curso => {
                const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
                return `
                <div class="curso-card" onclick="accederAlCurso('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                    <div class="curso-imagen">
                        ${hasImage ? 
                            `<img src="${curso.Foto_Portada}" 
                                  alt="${curso.Nombre_Curso}" 
                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                  onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                            ''
                        }
                        <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">🎓</div>
                    </div>
                    <div class="curso-content">
                        <h3 class="curso-titulo">${curso.Nombre_Curso}</h3>
                        <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                        <p class="curso-grupo">Inicio: ${formatFecha(curso.Fecha_Inicio)}</p>
                        <button class="btn-acceder">Acceder al curso</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showCursosError(error) {
            const container = document.getElementById('cursosContainer');
            container.innerHTML = '<div class="error">Error al cargar los cursos: ' + error.message + '</div>';
        }

        async function accederAlCurso(cursoId, grupoId) {
            currentCourseId = cursoId;
            currentGrupoId = grupoId;
            
            // Encontrar los datos del curso actual
            currentCourseData = cursosCache.find(curso => 
                curso.ID_Curso === cursoId && curso.ID_Grupo === grupoId
            );
            
            // Mostrar cabecera del curso
            if (currentCourseData) {
                document.getElementById('courseTitle').textContent = currentCourseData.Nombre_Curso;
                document.getElementById('courseDescription').textContent = currentCourseData.Descripcion || 'No hay descripción disponible para este curso.';
                
                // Imagen de cabecera del curso
                if (currentCourseData.Foto_Cabecera) {
                    document.getElementById('courseHeaderImage').src = currentCourseData.Foto_Cabecera;
                    document.getElementById('courseHeaderImage').style.display = 'block';
                } else {
                    document.getElementById('courseHeaderImage').style.display = 'none';
                }
                
                // Actualizar botones del curso
                updateCourseButtons();
                
                document.getElementById('courseHeader').style.display = 'block';
            }
            
            // Ocultar cursos y mostrar módulos
            document.getElementById('cursosContainer').style.display = 'none';
            document.getElementById('mainTitle').textContent = 'Módulos del Curso';
            
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button><div class="loading">Cargando módulos...</div>';
            
            // Desplazar hacia el contenedor de módulos
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
            
            const cacheKey = `modulos_${alumnoActual.ID_Alumno}_${cursoId}_${grupoId}`;
            const cached = sessionStorage.getItem(cacheKey);
            
            if (cached) {
                console.log('Cargando módulos desde cache frontend');
                displayModulos(JSON.parse(cached), cursoId, grupoId);
            } else {
                try {
                    const result = await callJSONP('getModulosCurso', {
                        alumnoId: alumnoActual.ID_Alumno,
                        cursoId: cursoId,
                        grupoId: grupoId
                    });
                    sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                    displayModulos(result.data, cursoId, grupoId);
                } catch (error) {
                    container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button><div class="error">Error al cargar módulos: ' + error.message + '</div>';
                }
            }
        }

        function updateCourseButtons() {
            const buttonsContainer = document.getElementById('courseButtons');
            buttonsContainer.innerHTML = '';
            
            // Botón manual del curso
            if (currentCourseData.Manual_c) {
                const manualBtn = document.createElement('button');
                manualBtn.className = 'course-manual-btn';
                manualBtn.innerHTML = '📘 Manual del Curso';
                manualBtn.onclick = function() {
                    showCourseManual(currentCourseData.Manual_c);
                };
                buttonsContainer.appendChild(manualBtn);
            }
            
            // Botón WhatsApp
            if (currentCourseData.Whatsapp) {
                const whatsappBtn = document.createElement('button');
                whatsappBtn.className = 'course-whatsapp-btn';
                whatsappBtn.innerHTML = '📱 WhatsApp del Grupo';
                whatsappBtn.onclick = function() {
                    window.open(currentCourseData.Whatsapp, '_blank');
                };
                buttonsContainer.appendChild(whatsappBtn);
            }
            
            // Botón Calendario
            if (currentCourseData.Calendario) {
                const calendarBtn = document.createElement('button');
                calendarBtn.className = 'course-calendar-btn';
                calendarBtn.innerHTML = '📅 Calendario';
                calendarBtn.onclick = function() {
                    window.open(currentCourseData.Calendario, '_blank');
                };
                buttonsContainer.appendChild(calendarBtn);
            }
            
            // Botón Mensaje
            if (currentCourseData.Mensaje) {
                const messageBtn = document.createElement('button');
                messageBtn.className = 'course-message-btn';
                messageBtn.innerHTML = '📢 Mensaje Importante';
                messageBtn.onclick = function() {
                    alert(currentCourseData.Mensaje);
                };
                buttonsContainer.appendChild(messageBtn);
            }
        }

        function volverACursos() {
            // Limpiar reproductores
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            currentPlayers = {};
            
            // Ocultar cabecera del curso
            document.getElementById('courseHeader').style.display = 'none';
            
            // Mostrar cursos nuevamente
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';
            document.getElementById('cursosContainer').style.display = 'grid';
            document.getElementById('mainTitle').textContent = 'Mis Cursos';
        }

        // === SISTEMA DE MÓDULOS Y CLASES ===
        function displayModulos(modules, cursoId, grupoId) {
            const container = document.getElementById("modulesContainer");
            container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button>';
            
            if (!modules || modules.length === 0) {
                container.innerHTML += "<p class='no-content'>No tienes módulos disponibles en este momento.</p>";
                return;
            }
            
            userModules = modules;
            
            let modulesList = "<h3 style='color: var(--azul-oscuro); margin-bottom: 12px;'>Tus Módulos Disponibles:</h3><div class='modules-grid'>";
            
            modules.forEach(module => {
                const progressPercentage = module.Total_Clases > 0 ? 
                    Math.round((module.Clases_Completadas / module.Total_Clases) * 100) : 0;
                
                modulesList += `
                <div class='module-card' onclick='expandModule("${module.ID_Módulo}")'>
                    <h4>${module['Nombre del Módulo'] || module.Nombre_Modulo}</h4>
                    <div class='module-progress'>
                        <div class='progress-label'>Progreso del Módulo</div>
                        <div class='module-progress-bar-container'>
                            <div class='module-progress-bar' style='width: ${progressPercentage}%'></div>
                        </div>
                        <div class='module-progress-text'>${progressPercentage}% completado</div>
                    </div>
                </div>`;
            });
            
            modulesList += "</div>";
            container.innerHTML += modulesList;
        }

        function expandModule(moduleId) {
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'none';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'none';
            
            var selectedModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_Módulo === moduleId) {
                    selectedModule = userModules[i];
                    break;
                }
            }
            
            if (!selectedModule) return;
            
            var expandedContent = "<div class='expanded-module'>";
            
            // Cabecera del módulo
            expandedContent += `
            <div class='module-header-expanded'>
                <div class='module-title-section'>
                    <h2>${selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo}</h2>
                </div>
                <div class='module-content'>
                    <div class='module-image-container'>
                        ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 
                            `<img src="${selectedModule['imagen_m']}" class='module-header-image' alt='Imagen del módulo' onerror='this.style.display=\"none\"; this.nextElementSibling.style.display=\"flex\";' onload='this.style.display=\"block\"; this.nextElementSibling.style.display=\"none\";'>` : 
                            ''
                        }
                        <div style="width: 140px; height: 100px; background: linear-gradient(135deg, var(--azul), var(--naranja)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 'display: none;' : ''}">📚</div>
                    </div>
                    <div class='module-info'>
                        <p class='module-description'>${selectedModule['Descripción del Módulo'] || 'No hay descripción disponible para este módulo.'}</p>
                        ${selectedModule['Manual_m'] && selectedModule['Manual_m'].trim() !== '' ? 
                            `<button class='module-manual-btn' onclick='showModuleManual("${selectedModule['Manual_m']}")'>📘 Manual del Módulo</button>` : 
                            ''
                        }
                    </div>
                </div>
            </div>`;
            
            // Resto del contenido del módulo (clases)
            expandedContent += "<div class='module-header'>";
            expandedContent += "<button class='back-button' onclick='collapseModule()'>← Mis Módulos</button>";
            expandedContent += "</div>";
            
            var completedCount = selectedModule.Clases_Completadas || 0;
            var totalCount = selectedModule.Total_Clases || 0;
            
            var progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            expandedContent += "<div class='module-progress-expanded'>";
            expandedContent += "<div class='progress-label'>Progreso del Módulo</div>";
            expandedContent += "<div class='module-progress-bar-container'>";
            expandedContent += "<div class='module-progress-bar' style='width: " + progressPercentage + "%'></div>";
            expandedContent += "</div>";
            expandedContent += "<div class='module-progress-text'>" + completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)</div>";
            expandedContent += "</div>";
            
            if (selectedModule.Clases && selectedModule.Clases.length > 0) {
                expandedContent += "<div class='content-list-expanded'>";
                
                for (var j = 0; j < selectedModule.Clases.length; j++) {
                    var content = selectedModule.Clases[j];
                    var lessonId = content.ID_Clase;
                    var isCompleted = userProgress[lessonId] && userProgress[lessonId].completed;
                    var hasNotes = userProgress[lessonId] && userProgress[lessonId].notes && userProgress[lessonId].notes.trim() !== '';
                    
                    expandedContent += "<div class='content-item" + (isCompleted ? " completed" : "") + "'>";
                    
                    expandedContent += "<div class='lesson-header'>";
                    expandedContent += "<input type='checkbox' id='check_" + lessonId + "' class='lesson-checkbox' ";
                    expandedContent += "onchange='markAsViewed(\"" + lessonId + "\", \"" + moduleId + "\", \"" + (selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\", this)' ";
                    if (isCompleted) {
                        expandedContent += "checked ";
                    }
                    expandedContent += "/>";
                    expandedContent += "<label for='check_" + lessonId + "' class='lesson-title'>" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "</label>";
                    expandedContent += "</div>";
                    
                    // === MINIATURA Y DESCRIPCIÓN ===
                    var videoUrl = content['URL Video'] || '';
                    var videoId = extractVideoId(videoUrl);
                    var description = content['Descripción'] || '';
                    
                    if (videoId || description) {
                        expandedContent += "<div class='lesson-preview'>";
                        
                        // Miniatura del video (si existe)
                        if (videoId) {
                            var thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                            expandedContent += "<div class='lesson-thumbnail' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + videoUrl + "\")'>";
                            expandedContent += "<img src='" + thumbnailUrl + "' alt='Miniatura del video'>";
                            expandedContent += "<div class='play-icon'>▶</div>";
                            expandedContent += "</div>";
                        }
                        
                        // Descripción de la clase
                        if (description) {
                            expandedContent += "<div class='lesson-description'>" + description + "</div>";
                        }
                        
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div class='content-links'>";
                    
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<button id='show-player-" + lessonId + "' class='video-link' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + content['URL Video'] + "\")'>🎬 Ver Video</button>";
                        expandedContent += "<button id='hide-player-" + lessonId + "' class='video-link' onclick='hideVideoPlayer(\"" + lessonId + "\")' style='display: none;'>❌ Cerrar Video</button>";
                    }
                    
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<button id='show-manual-" + lessonId + "' class='manual-link' onclick='showManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>📄 Ver Manual</button>";
                        expandedContent += "<button id='hide-manual-" + lessonId + "' class='manual-link' onclick='hideManual(\"" + lessonId + "\")' style='display: none;'>❌ Cerrar Manual</button>";
                    }
                    
                    expandedContent += "<button id='notes-btn-" + lessonId + "' class='notes-link' onclick='toggleNotes(\"" + lessonId + "\")'>";
                    expandedContent += hasNotes ? "📝 Ver notas (" + (userProgress[lessonId].notes.length > 0 ? "1" : "0") + ")" : "📝 Agregar notas";
                    expandedContent += "</button>";
                    
                    // Botón Clase Siguiente (excepto para la última clase)
                    if (j < selectedModule.Clases.length - 1) {
                        expandedContent += "<button class='next-class-link' onclick='nextClass(\"" + lessonId + "\", \"" + moduleId + "\")'>➡️ Clase Siguiente</button>";
                    }
                    
                    expandedContent += "</div>";
                    
                    // === NUEVO REPRODUCTOR CON CONTROLES MEJORADOS ===
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<div id='player-container-" + lessonId + "' class='player-container' style='display: none;'>";
                        expandedContent += "<div class='video-container' id='videoContainer-" + lessonId + "'>";
                        expandedContent += "<div id='player-" + lessonId + "'></div>";
                        expandedContent += "<div class='overlay' id='overlay-" + lessonId + "'></div>";
                        expandedContent += "<div class='corner-box'></div>";
                        expandedContent += "<div class='exit-fullscreen' id='exitFullscreenBtn-" + lessonId + "'>✖</div>";
                        expandedContent += "</div>";
                        
                        // Panel de controles estilo YouTube
                        expandedContent += "<div class='video-controls-panel'>";
                        expandedContent += "<div class='progress-controls'>";
                        expandedContent += "<div class='progress-bar-container' id='progressBar-" + lessonId + "'>";
                        expandedContent += "<div class='progress-bar' id='progress-" + lessonId + "'>";
                        expandedContent += "<div class='progress-thumb' id='thumb-" + lessonId + "'></div>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                        expandedContent += "<div class='time-display' id='timeDisplay-" + lessonId + "'>0:00 / 0:00</div>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='control-buttons'>";
                        expandedContent += "<div class='control-buttons-left'>";
                        expandedContent += "<button class='control-btn play-pause' id='playPauseBtn-" + lessonId + "'>";
                        expandedContent += "<span class='control-btn-icon'>▶</span>";
                        expandedContent += "<span class='control-btn-text'>Play</span>";
                        expandedContent += "</button>";
                        expandedContent += "<button class='control-btn restart' id='restartBtn-" + lessonId + "'>";
                        expandedContent += "<span class='control-btn-icon'>⏮</span>";
                        expandedContent += "<span class='control-btn-text'>Reiniciar</span>";
                        expandedContent += "</button>";
                        expandedContent += "</div>";
                        expandedContent += "<div class='control-buttons-right'>";
                        expandedContent += "<button class='control-btn fullscreen' id='fullscreenBtn-" + lessonId + "'>";
                        expandedContent += "<span class='control-btn-icon'>⛶</span>";
                        expandedContent += "<span class='control-btn-text'>Pantalla completa</span>";
                        expandedContent += "</button>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                    }
                    
                    // Contenedor para el manual PDF
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<div id='manual-container-" + lessonId + "' class='manual-container' style='display: none; margin-top: 8px;'>";
                        expandedContent += "<div class='manual-header'>";
                        expandedContent += "<h4>📚 Material de Estudio</h4>";
                        expandedContent += "<p>Accede a tu contenido educativo</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='manual-controls'>";
                        expandedContent += "<button class='btn-manual btn-download' onclick='downloadManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>";
                        expandedContent += "<svg class='icon' viewBox='0 0 24 24'><path d='M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z'/></svg>";
                        expandedContent += "Descargar";
                        expandedContent += "</button>";
                        
                        expandedContent += "<button class='btn-manual btn-print' onclick='printManual(\"" + lessonId + "\")'>";
                        expandedContent += "<svg class='icon' viewBox='0 0 24 24'><path d='M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z'/></svg>";
                        expandedContent += "Imprimir";
                        expandedContent += "</button>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div id='welcome-message-" + lessonId + "' class='welcome-message'>";
                        expandedContent += "<h5>¡Bienvenido!</h5>";
                        expandedContent += "<p>Haz clic en \"Ver Manual\" para acceder al material de estudio.</p>";
                        expandedContent += "<p>Una vez abierto, podrás descargarlo o imprimirlo según necesites.</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<iframe id='pdf-frame-" + lessonId + "' class='pdf-frame' style='display: none;'></iframe>";
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div id='notes-area-" + lessonId + "' class='notes-area' style='display: none; margin-top: 8px;'>";
                    expandedContent += "<h4>Notas para esta lección:</h4>";
                    expandedContent += "<textarea id='notes-text-" + lessonId + "' class='notes-textarea' placeholder='Escribe tus notas aquí...'>";
                    if (hasNotes) {
                        expandedContent += userProgress[lessonId].notes;
                    }
                    expandedContent += "</textarea>";
                    expandedContent += "<button id='save-notes-btn-" + lessonId + "' class='save-notes-btn' onclick='saveNotes(\"" + lessonId + "\", \"" + (selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\")'>Guardar notas</button>";
                    expandedContent += "</div>";
                    
                    expandedContent += "</div>";
                }
                
                expandedContent += "</div>";
            } else {
                expandedContent += "<p class='no-content'>Contenido próximamente...</p>";
            }
            
            expandedContent += "</div>";
            
            var expandedContainer = document.createElement('div');
            expandedContainer.id = 'expanded-module-container';
            expandedContainer.innerHTML = expandedContent;
            
            document.getElementById('modulesContainer').appendChild(expandedContainer);
            
            // Desplazar hacia el módulo expandido
            setTimeout(() => {
                expandedContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            // Actualizar logos en los reproductores después de expandir el módulo
            setTimeout(updateVideoPlayersLogo, 100);
        }

        function collapseModule() {
            var expandedContainer = document.getElementById('expanded-module-container');
            if (expandedContainer) {
                expandedContainer.remove();
            }
            
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'block';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'block';
        }

        // === FUNCIÓN CORREGIDA PARA GUARDAR PROGRESO ===
        async function saveProgressToDatabase(lessonId, completed, notes) {
            try {
                console.log('💾 Guardando progreso:', { lessonId, completed, notes });
                
                // Enviar datos en el formato correcto que espera el backend
                const progressData = {
                    ID_Alumno: String(alumnoActual.ID_Alumno),
                    ID_Clase: String(lessonId),
                    Fecha_Guardado: new Date().toISOString().split('T')[0],
                    Completada: completed ? "Sí" : "No",
                    Notas_Alumno: notes || ''
                };
                
                console.log('📤 Enviando datos de progreso:', progressData);
                
                // Llamar a la acción 'progreso' con los datos correctos
                const response = await callJSONP('progreso', progressData);
                console.log('✅ Respuesta del servidor:', response);
                
                if (!response.success) {
                    throw new Error(response.error || 'Error al guardar el progreso');
                }
                return response;
            } catch (error) {
                console.error('❌ Error guardando progreso:', error);
                throw error;
            }
        }

        // === SISTEMA DE PROGRESO MEJORADO Y CORREGIDO ===
        async function markAsViewed(lessonId, moduleId, moduleName, lessonName, checkbox) {
            const completed = checkbox.checked;
            const notes = userProgress[lessonId] ? userProgress[lessonId].notes : '';
            
            const contentItem = checkbox.closest('.content-item');
            if (completed) {
                contentItem.classList.add('completed');
            } else {
                contentItem.classList.remove('completed');
            }
            
            try {
                // Guardar progreso en la base de datos
                await saveProgressToDatabase(lessonId, completed, notes);
                
                // Actualizar estado local
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                userProgress[lessonId].completed = completed;
                userProgress[lessonId].notes = notes;
                userProgress[lessonId].lastUpdate = new Date();
                
                // Actualizar cache local
                updateLocalCache();
                showNotification(completed ? '✅ Lección completada' : '📝 Progreso actualizado');
                
                // Actualizar progreso del módulo
                updateModuleProgress(moduleId);
                
            } catch (error) {
                console.error('Error en markAsViewed:', error);
                showNotification('❌ Error de conexión: ' + error.message, 'error');
                checkbox.checked = !completed; // Revertir cambio
                if (completed) {
                    contentItem.classList.remove('completed');
                } else {
                    contentItem.classList.add('completed');
                }
            }
        }

        // Función para actualizar el progreso del módulo
        function updateModuleProgress(moduleId) {
            const selectedModule = userModules.find(m => m.ID_Módulo === moduleId);
            if (!selectedModule) return;
            
            let completedCount = 0;
            selectedModule.Clases.forEach(content => {
                if (userProgress[content.ID_Clase] && userProgress[content.ID_Clase].completed) {
                    completedCount++;
                }
            });
            
            const totalCount = selectedModule.Clases.length;
            const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            // Actualizar la barra de progreso en la vista expandida
            const progressBar = document.querySelector('.module-progress-expanded .module-progress-bar');
            const progressText = document.querySelector('.module-progress-expanded .module-progress-text');
            
            if (progressBar) {
                progressBar.style.width = progressPercentage + '%';
            }
            
            if (progressText) {
                progressText.textContent = completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)";
            }
            
            // Actualizar la tarjeta del módulo
            const moduleCard = document.querySelector(`[onclick="expandModule('${moduleId}')"]`);
            if (moduleCard) {
                const cardProgressBar = moduleCard.querySelector('.module-progress-bar');
                const cardProgressText = moduleCard.querySelector('.module-progress-text');
                
                if (cardProgressBar) {
                    cardProgressBar.style.width = progressPercentage + '%';
                }
                
                if (cardProgressText) {
                    cardProgressText.textContent = progressPercentage + '% completado';
                }
            }
        }

        async function saveNotes(lessonId, moduleName, lessonName) {
            const notesText = document.getElementById('notes-text-' + lessonId).value;
            const saveButton = document.getElementById('save-notes-btn-' + lessonId);
            
            saveButton.textContent = 'Guardando...';
            saveButton.disabled = true;
            
            try {
                // Guardar notas en la base de datos
                await saveProgressToDatabase(lessonId, 
                    userProgress[lessonId] ? userProgress[lessonId].completed : false, 
                    notesText
                );
                
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                userProgress[lessonId].notes = notesText;
                
                // Actualizar cache local
                updateLocalCache();
                
                showNotification('✅ Notas guardadas correctamente');
                saveButton.textContent = 'Guardado ✓';
                
                const notesButton = document.getElementById('notes-btn-' + lessonId);
                notesButton.textContent = '📝 Ver notas (' + (notesText.length > 0 ? "1" : "0") + ')';
                
                setTimeout(() => {
                    saveButton.textContent = 'Guardar notas';
                    saveButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                showNotification('❌ Error: ' + error.message, 'error');
                saveButton.textContent = 'Guardar notas';
                saveButton.disabled = false;
            }
        }

        // === SISTEMA DE VIDEO MEJORADO ===
        function showVideoPlayer(lessonId, videoUrl) {
            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                showNotification("URL de video inválida", "error");
                return;
            }

            pauseAllVideos();
            
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            document.querySelectorAll('.player-container').forEach(container => {
                if (container.id !== 'player-container-' + lessonId) {
                    container.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="hide-player-"]').forEach(button => {
                if (button.id !== 'hide-player-' + lessonId) {
                    button.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="show-player-"]').forEach(button => {
                if (button.id !== 'show-player-' + lessonId && !button.closest('.player-container')) {
                    button.style.display = 'inline-block';
                }
            });
            
            playerContainer.style.display = 'block';
            showButton.style.display = 'none';
            hideButton.style.display = 'inline-block';
            
            // Desplazar la página para mostrar el reproductor
            playerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (!currentPlayers[lessonId] || currentPlayers[lessonId].getVideoData === undefined) {
                createPlayer(lessonId, videoId);
            } else {
                currentPlayers[lessonId].cueVideoById(videoId);
                setTimeout(function() {
                    adjustPlayerSize(lessonId);
                }, 100);
            }
        }

        function hideVideoPlayer(lessonId) {
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            playerContainer.style.display = 'none';
            showButton.style.display = 'inline-block';
            hideButton.style.display = 'none';
            
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].pauseVideo();
            }
        }

        function pauseAllVideos() {
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId] && typeof currentPlayers[lessonId].pauseVideo === 'function') {
                    currentPlayers[lessonId].pauseVideo();
                }
            }
        }

        function extractVideoId(url) {
            var regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            var match = url.match(regex);
            return match ? match[1] : null;
        }

        function adjustPlayerSize(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            var container = document.getElementById('videoContainer-' + lessonId);
            if (!container) return;
            
            var containerWidth = container.clientWidth;
            var containerHeight = containerWidth * 9 / 16;
            
            player.setSize(containerWidth, containerHeight);
        }

        function createPlayer(lessonId, videoId) {
            var playerId = 'player-' + lessonId;
            
            currentPlayers[lessonId] = new YT.Player(playerId, {
                videoId: videoId,
                playerVars: { 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    iv_load_policy: 3,
                    playsinline: 1
                },
                events: {
                    onReady: function() { onPlayerReady(lessonId); },
                    onStateChange: function(event) { onPlayerStateChange(lessonId, event); }
                }
            });
        }

        function onPlayerReady(lessonId) {
            var player = currentPlayers[lessonId];
            
            adjustPlayerSize(lessonId);
            
            setupCustomControls(lessonId);
            updateVideoPlayersLogo();
            
            setInterval(function() {
                updateProgress(lessonId);
            }, 500);
        }

        function onPlayerStateChange(lessonId, event) {
            var btn = document.getElementById("playPauseBtn-" + lessonId);
            if (btn) {
                btn.innerHTML = event.data === YT.PlayerState.PLAYING ? 
                    '<span class="control-btn-icon">⏸</span><span class="control-btn-text">Pausa</span>' : 
                    '<span class="control-btn-icon">▶</span><span class="control-btn-text">Play</span>';
            }
        }

        // === FUNCIÓN PARA ACTUALIZAR TIEMPO EN BARRA DE PROGRESO ===
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ":" + (secs < 10 ? "0" : "") + secs;
        }

        function updateProgress(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player || !player.getCurrentTime || window.dragging) return;

            var currentTime = player.getCurrentTime();
            var duration = player.getDuration();
            var percent = (currentTime / duration) * 100;
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var timeDisplay = document.getElementById("timeDisplay-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = percent + "%";
            }
            
            if (thumbElement) {
                var progressBarContainer = document.getElementById("progressBar-" + lessonId);
                if (progressBarContainer) {
                    thumbElement.style.left = (percent / 100 * progressBarContainer.offsetWidth) + "px";
                }
            }
            
            // ACTUALIZAR DISPLAY DE TIEMPO
            if (timeDisplay && duration) {
                timeDisplay.textContent = formatTime(currentTime) + " / " + formatTime(duration);
            }
        }

        function setupCustomControls(lessonId) {
            var overlay = document.getElementById("overlay-" + lessonId);
            var playPauseBtn = document.getElementById("playPauseBtn-" + lessonId);
            var restartBtn = document.getElementById("restartBtn-" + lessonId);
            var fullscreenBtn = document.getElementById("fullscreenBtn-" + lessonId);
            var exitFullscreenBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            var progressBarContainer = document.getElementById("progressBar-" + lessonId);
            var thumb = document.getElementById("thumb-" + lessonId);
            var controlsPanel = document.querySelector('#player-container-' + lessonId + ' .video-controls-panel');

            // Control de visibilidad de controles en fullscreen
            let controlsTimeout;
            
            function showControls() {
                if (controlsPanel) {
                    controlsPanel.classList.remove('controls-hidden');
                    controlsPanel.classList.add('controls-active');
                }
            }
            
            function hideControlsWithDelay() {
                if (controlsPanel) {
                    clearTimeout(controlsTimeout);
                    controlsTimeout = setTimeout(() => {
                        var container = document.getElementById("videoContainer-" + lessonId);
                        if (container && container.classList.contains('fullscreen-mode')) {
                            controlsPanel.classList.add('controls-hidden');
                            controlsPanel.classList.remove('controls-active');
                        }
                    }, 3000); // Ocultar después de 3 segundos de inactividad
                }
            }
            
            // Mostrar controles al mover el mouse o tocar
            if (overlay) {
                overlay.onclick = function(e) { 
                    if (!e.target.closest('.video-controls-panel')) {
                        togglePlayPause(lessonId);
                        showControls();
                        hideControlsWithDelay();
                    }
                };
                
                overlay.addEventListener('mousemove', function() {
                    showControls();
                    hideControlsWithDelay();
                });
                
                overlay.addEventListener('touchstart', function() {
                    showControls();
                    hideControlsWithDelay();
                });
            }
            
            // Mostrar controles al interactuar con ellos
            if (controlsPanel) {
                controlsPanel.addEventListener('mouseenter', showControls);
                controlsPanel.addEventListener('mousemove', showControls);
                controlsPanel.addEventListener('touchstart', showControls);
                controlsPanel.addEventListener('click', function() {
                    showControls();
                    hideControlsWithDelay();
                });
            }
            
            if (playPauseBtn) {
                playPauseBtn.onclick = function() { 
                    togglePlayPause(lessonId);
                    showControls();
                    hideControlsWithDelay();
                };
            }
            
            if (restartBtn) {
                restartBtn.onclick = function() { 
                    restartVideo(lessonId);
                    showControls();
                    hideControlsWithDelay();
                };
            }
            
            if (fullscreenBtn) {
                fullscreenBtn.onclick = function() { 
                    goFullScreen(lessonId);
                    showControls();
                    hideControlsWithDelay();
                };
            }
            
            if (exitFullscreenBtn) {
                exitFullscreenBtn.onclick = function() { 
                    exitFullScreen(lessonId);
                };
            }

            // Sistema de arrastre para la barra de progreso
            if (progressBarContainer) {
                progressBarContainer.addEventListener("click", function(e) {
                    if (!window.dragging) {
                        var rect = progressBarContainer.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        if (x < 0) x = 0;
                        if (x > rect.width) x = rect.width;
                        seekToPosition(lessonId, x / rect.width);
                        showControls();
                        hideControlsWithDelay();
                    }
                });

                // Mostrar controles al interactuar con la barra
                progressBarContainer.addEventListener("mouseenter", showControls);
                progressBarContainer.addEventListener("touchstart", showControls);
            }

            if (thumb) {
                thumb.addEventListener("mousedown", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId);
                    showControls();
                });
                thumb.addEventListener("touchstart", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId);
                    showControls();
                }, {passive: false});
            }

            // Eventos globales de arrastre
            document.addEventListener("mousemove", function(e) { 
                dragMove(e, lessonId);
            });
            document.addEventListener("mouseup", function(e) { 
                endDrag(e);
                hideControlsWithDelay();
            });
            document.addEventListener("touchmove", function(e) { 
                dragMove(e, lessonId);
            }, {passive: false});
            document.addEventListener("touchend", function(e) { 
                endDrag(e);
                hideControlsWithDelay();
            });
            document.addEventListener("touchcancel", function(e) { 
                endDrag(e);
            });

            // Eventos de pantalla completa
            document.addEventListener('fullscreenchange', function() { 
                fullscreenChange(lessonId);
                showControls();
                hideControlsWithDelay();
            });
            document.addEventListener('webkitfullscreenchange', function() { 
                fullscreenChange(lessonId);
                showControls();
                hideControlsWithDelay();
            });
            document.addEventListener('msfullscreenchange', function() { 
                fullscreenChange(lessonId);
                showControls();
                hideControlsWithDelay();
            });
            
            // Redimensionamiento
            window.addEventListener('resize', function() {
                if (currentPlayers[lessonId]) {
                    adjustPlayerSize(lessonId);
                }
            });
            
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    fullscreenChange(lessonId);
                    adjustPlayerSize(lessonId);
                    showControls();
                    hideControlsWithDelay();
                }, 300);
            });

            updateVideoPlayersLogo();
        }

        function togglePlayPause(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function restartVideo(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            player.seekTo(0, true);
            player.playVideo();
        }

        function startDrag(e, lessonId) {
            e.preventDefault();
            window.dragging = true;
            window.currentDragLessonId = lessonId;
        }

        function dragMove(e, lessonId) {
            if (window.dragging && window.currentDragLessonId === lessonId) {
                e.preventDefault();
                var progressBarContainer = document.getElementById("progressBar-" + lessonId);
                if (!progressBarContainer) return;

                var rect = progressBarContainer.getBoundingClientRect();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var x = clientX - rect.left;
                
                if (x < 0) x = 0;
                if (x > rect.width) x = rect.width;
                
                seekToPosition(lessonId, x / rect.width);
            }
        }

        function endDrag(e) {
            window.dragging = false;
            window.currentDragLessonId = null;
        }

        function seekToPosition(lessonId, percent) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var duration = player.getDuration();
            var newTime = duration * percent;
            player.seekTo(newTime, true);
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarContainer = document.getElementById("progressBar-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = (percent * 100) + "%";
            }
            
            if (thumbElement && progressBarContainer) {
                thumbElement.style.left = (percent * progressBarContainer.offsetWidth) + "px";
            }
        }

        function goFullScreen(lessonId) {
            var container = document.getElementById("videoContainer-" + lessonId);
            if (!container) return;

            container.classList.add('fullscreen-mode');
            
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
            
            setTimeout(function() {
                var player = currentPlayers[lessonId];
                if (player && typeof player.setSize === 'function') {
                    adjustPlayerSizeForFullscreen(lessonId);
                }
            }, 100);
        }

        function adjustPlayerSizeForFullscreen(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            player.setSize(window.innerWidth, window.innerHeight);
        }

        function exitFullScreen(lessonId) {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            
            if (lessonId) {
                var container = document.getElementById("videoContainer-" + lessonId);
                if (container) {
                    container.classList.remove('fullscreen-mode');
                    
                    setTimeout(function() {
                        var player = currentPlayers[lessonId];
                        if (player && typeof player.setSize === 'function') {
                            adjustPlayerSize(lessonId);
                        }
                    }, 100);
                }
            }
        }

        function fullscreenChange(lessonId) {
            var exitBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            
            var isFullscreen = document.fullscreenElement || 
                              document.webkitFullscreenElement || 
                              document.msFullscreenElement;
            
            if (exitBtn) {
                exitBtn.style.display = isFullscreen ? "flex" : "none";
            }
            
            var player = currentPlayers[lessonId];
            if (player && typeof player.setSize === 'function') {
                if (isFullscreen) {
                    setTimeout(function() {
                        adjustPlayerSizeForFullscreen(lessonId);
                    }, 100);
                } else {
                    setTimeout(function() {
                        adjustPlayerSize(lessonId);
                    }, 100);
                }
            }
        }

        // === ACTUALIZAR LOGO EN REPRODUCTOR ===
        function updateVideoPlayersLogo() {
            const cornerBoxes = document.querySelectorAll('.corner-box');
            cornerBoxes.forEach(box => {
                if (escuelaData && escuelaData.Logo_Escuela) {
                    let logoImg = box.querySelector('.school-logo-mini');
                    if (!logoImg) {
                        logoImg = document.createElement('img');
                        logoImg.className = 'school-logo-mini';
                        logoImg.style.cssText = 'width: 100%; height: 100%; object-fit: contain; border-radius: 2px;';
                        box.appendChild(logoImg);
                    }
                    logoImg.src = escuelaData.Logo_Escuela;
                    logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                    box.classList.add('has-logo');
                } else {
                    box.classList.remove('has-logo');
                    const logoImg = box.querySelector('.school-logo-mini');
                    if (logoImg) {
                        logoImg.remove();
                    }
                }
            });
        }

        // === SISTEMA UNIFICADO DE MANUALES ===
        function showCourseManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del Curso');
            }
        }

        function showModuleManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del Módulo');
            }
        }

        function openManualViewer(manualUrl, title) {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            const modalTitle = document.getElementById('manualModalTitle');
            
            if (modal && frame) {
                modalTitle.textContent = title;
                const viewerUrl = convertToGoogleDriveViewer(manualUrl);
                frame.src = viewerUrl;
                modal.style.display = 'flex';
            }
        }

        function closeManualViewer() {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            if (modal && frame) {
                modal.style.display = 'none';
                frame.src = '';
            }
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualViewer();
            }
        });

        function convertToGoogleDriveViewer(url) {
            var fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }
            return url;
        }

        function extractGoogleDriveFileId(url) {
            var match = url.match(/[-\w]{25,}/);
            return match ? match[0] : null;
        }

        function downloadManual(lessonId, manualUrl) {
            var fileId = extractGoogleDriveFileId(manualUrl);
            if (fileId) {
                var downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
                window.open(downloadUrl, '_blank');
            } else {
                window.open(manualUrl, '_blank');
            }
        }

        function printManual(lessonId) {
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            if (pdfFrame && pdfFrame.contentWindow) {
                try {
                    pdfFrame.contentWindow.print();
                } catch (e) {
                    var manualUrl = pdfFrame.src;
                    window.open(manualUrl, '_blank');
                    showNotification('Se abrió el manual en una nueva ventana para imprimir', 'info');
                }
            }
        }

        // === SISTEMA DE NOTAS ===
        function toggleNotes(lessonId) {
            var notesArea = document.getElementById('notes-area-' + lessonId);
            var notesButton = document.getElementById('notes-btn-' + lessonId);
            
            if (notesArea.style.display === 'none' || !notesArea.style.display) {
                notesArea.style.display = 'block';
                notesButton.textContent = 'Ocultar notas';
                
                var notesTextarea = document.getElementById('notes-text-' + lessonId);
                if (notesTextarea.value === '' && userProgress[lessonId] && userProgress[lessonId].notes) {
                    notesTextarea.value = userProgress[lessonId].notes;
                }
            } else {
                notesArea.style.display = 'none';
                notesButton.textContent = 'Ver/Editar notas';
            }
        }

        // === FUNCIÓN CLASE SIGUIENTE ===
        function nextClass(lessonId, moduleId) {
            var currentModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_Módulo === moduleId) {
                    currentModule = userModules[i];
                    break;
                }
            }
            
            if (!currentModule || !currentModule.Clases) return;
            
            var currentIndex = -1;
            for (var j = 0; j < currentModule.Clases.length; j++) {
                if (currentModule.Clases[j].ID_Clase === lessonId) {
                    currentIndex = j;
                    break;
                }
            }
            
            if (currentIndex === -1 || currentIndex >= currentModule.Clases.length - 1) {
                showNotification("No hay más clases en este módulo", "info");
                return;
            }
            
            var nextLesson = currentModule.Clases[currentIndex + 1];
            
            hideVideoPlayer(lessonId);
            hideManual(lessonId);
            
            var currentCheckbox = document.getElementById('check_' + lessonId);
            if (currentCheckbox && !currentCheckbox.checked) {
                currentCheckbox.checked = true;
                markAsViewed(lessonId, moduleId, currentModule['Nombre del Módulo'], currentModule.Clases[currentIndex]['Nombre de la Clase'], currentCheckbox);
            }
            
            if (nextLesson['URL Video'] && nextLesson['URL Video'].trim() !== '') {
                setTimeout(function() {
                    showVideoPlayer(nextLesson.ID_Clase, nextLesson['URL Video']);
                }, 300);
            }
            
            var nextLessonElement = document.getElementById('check_' + nextLesson.ID_Clase);
            if (nextLessonElement) {
                nextLessonElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            showNotification("Avanzando a la siguiente clase: " + nextLesson['Nombre de la Clase'], "success");
        }

        // === FUNCIONES UTILITARIAS ===
        function updateLocalCache() {
            // Invalidar cache local cuando hay cambios
            if (alumnoActual) {
                sessionStorage.removeItem(`cursos_${alumnoActual.ID_Alumno}`);
                if (currentCourseId && currentGrupoId) {
                    sessionStorage.removeItem(`modulos_${alumnoActual.ID_Alumno}_${currentCourseId}_${currentGrupoId}`);
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function formatFecha(fechaString) {
            if (!fechaString) return 'No especificada';
            try {
                const fecha = new Date(fechaString);
                return fecha.toLocaleDateString('es-ES');
            } catch (e) {
                return fechaString;
            }
        }

        function clearErrors() {
            document.getElementById("errorMessage").innerHTML = "";
        }
        
        function clearForms() {
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
        }

        function logout() {
            // Limpiar todo
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            
            currentPlayers = {};
            currentUser = null;
            userProgress = {};
            userModules = [];
            alumnoActual = null;
            currentCourseData = null;
            
            sessionStorage.clear();
            
            document.getElementById('courseHeader').style.display = 'none';
            document.getElementById("page4_id1").style.display = "none";
            document.getElementById("page1_id1").style.display = "flex";
            clearErrors();
            clearForms();
        }

        // Funciones auxiliares para manuales
        function showManual(lessonId, manualUrl) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            if (manualContainer.style.display === 'none' || !manualContainer.style.display) {
                manualContainer.style.display = 'block';
                showManualButton.style.display = 'none';
                hideManualButton.style.display = 'inline-block';
                
                var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
                var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
                
                if (welcomeMessage) welcomeMessage.style.display = 'none';
                if (pdfFrame) {
                    pdfFrame.style.display = 'block';
                    var viewerUrl = convertToGoogleDriveViewer(manualUrl);
                    pdfFrame.src = viewerUrl;
                }
                
                showManualButton.innerHTML = '📄 Ocultar Manual';
            } else {
                hideManual(lessonId);
            }
        }

        function hideManual(lessonId) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            manualContainer.style.display = 'none';
            showManualButton.style.display = 'inline-block';
            hideManualButton.style.display = 'none';
            
            var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            
            if (welcomeMessage) welcomeMessage.style.display = 'block';
            if (pdfFrame) {
                pdfFrame.style.display = 'none';
                pdfFrame.src = '';
            }
            
            showManualButton.innerHTML = '📄 Ver Manual';
        }

        // === FUNCIÓN DE DEPURACIÓN ===
        async function testConnection() {
            try {
                console.log('🧪 Probando conexión...');
                const response = await callJSONP('escuela', {});
                console.log('✅ Conexión exitosa:', response);
                return response;
            } catch (error) {
                console.error('❌ Error de conexión:', error);
                return {success: false, error: error.message};
            }
        }

        // Hacer la función accesible desde la consola
        window.testConnection = testConnection;
    </script>
</body>
</html>
