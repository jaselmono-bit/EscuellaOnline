<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - Dashboard</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* === SISTEMA DE DISEÃ‘O UNIFICADO === */
        :root {
            --naranja: #fbbf24;
            --naranja-claro: #fdba74;
            --azul: #3b82f6;
            --azul-claro: #0ea5e9;
            --azul-oscuro: #1e3a8a;
            --azul-profundo: #1e293b;
            --neutro: #f1f5f9;
            --blanco: #ffffff;
            --success: #10B981;
            --error: #EF4444;
            --gray: #64748B;
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sombra-intensa: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radio: 15px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(160deg, var(--azul) 0%, var(--naranja) 100%);
            min-height: 100vh;
            color: var(--azul-profundo);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px 5px;
            min-height: calc(100vh - 10px);
        }

        /* === COMPONENTES REUTILIZABLES === */
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radio);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-intensa);
        }

        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        /* === LAYOUT PRINCIPAL === */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .school-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .school-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--neutro);
            padding: 4px;
        }

        .school-name {
            color: var(--azul-oscuro);
            font-size: 18px;
            font-weight: 700;
        }

        .user-welcome {
            text-align: right;
            flex: 1;
            min-width: 180px;
        }

        .user-welcome h2 {
            color: var(--azul-oscuro);
            margin-bottom: 5px;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* === SISTEMA DE NAVEGACIÃ“N === */
        .dashboard {
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            margin-bottom: 5px;
        }

        .back-btn {
            margin-bottom: 15px;
        }

        /* === SISTEMA DE GRILLAS RESPONSIVO === */
        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-cursos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .grid-modulos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* === TARJETAS DE CONTENIDO MEJORADAS === */
        .curso-card, .module-card {
            cursor: pointer;
            border-left: 5px solid var(--azul);
            border-right: 5px solid var(--naranja);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .curso-imagen, .module-imagen {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 50px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .curso-imagen img, .module-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: 10px;
        }

        .curso-card:hover .curso-imagen img,
        .module-card:hover .module-imagen img {
            transform: scale(1.05);
        }

        .curso-titulo, .module-titulo {
            font-size: 16px;
            font-weight: 700;
            color: var(--azul-oscuro);
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid var(--azul);
            padding-bottom: 8px;
            word-wrap: break-word;
        }

        .curso-content {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .curso-grupo {
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }

        .btn-acceder {
            width: 100%;
            margin-top: auto;
        }

        /* === SISTEMA DE PROGRESO UNIFICADO === */
        .progress-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--neutro);
            border-radius: 6px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
            margin-bottom: 4px;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 8px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--gray);
            font-weight: 600;
        }

        .progress-label {
            font-size: 11px;
            color: var(--gray);
            margin-bottom: 4px;
            text-align: center;
            font-weight: 600;
        }

        /* === NUEVA ESTRUCTURA DE ACORDEÃ“N PARA CLASES - REORGANIZADA === */
        .lesson-accordion {
            background: var(--blanco);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: var(--sombra);
            border: 1px solid #e2e8f0;
        }

        .lesson-accordion.active {
            border-color: var(--azul);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .lesson-header {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            cursor: pointer;
            background: var(--blanco);
            transition: background 0.3s ease;
            position: relative;
        }

        .lesson-header:hover {
            background: #f8fafc;
        }

        .lesson-accordion.active .lesson-header {
            background: #f0f9ff;
        }

        .lesson-number-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .lesson-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--azul);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .lesson-accordion.completed .lesson-number {
            background: var(--success);
        }

        .lesson-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            color: var(--gray);
        }

        .lesson-accordion.active .lesson-arrow {
            transform: rotate(180deg);
            color: var(--azul);
        }

        .lesson-thumbnail {
            width: 120px;
            height: 70px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            margin-right: 12px;
        }

        .lesson-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lesson-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lesson-thumbnail:hover .play-icon {
            opacity: 1;
        }

        /* === NUEVA ESTRUCTURA REORGANIZADA === */
        .lesson-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrar el tÃ­tulo y la descripciÃ³n */
        }

        .lesson-title {
            font-weight: 600;
            color: var(--azul-profundo);
            font-size: 15px;
            text-align: center;
            margin-bottom: 8px;
            width: 100%;
        }

        .lesson-accordion.completed .lesson-title {
            text-decoration: line-through;
            color: var(--gray);
        }

        .lesson-description {
            color: var(--azul-profundo);
            font-size: 14px;
            line-height: 1.5;
            text-align: center;
            margin-bottom: 12px;
            width: 100%;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* === NUEVO BOTÃ“N VISTA === */
        .vista-button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 8px;
        }

        .btn-vista {
            background: var(--azul);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-vista:hover {
            background: var(--azul-oscuro);
            transform: scale(1.05);
        }

        .btn-vista.completed {
            background: var(--success);
        }

        .lesson-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: var(--blanco);
        }

        .lesson-accordion.active .lesson-content {
            max-height: 1000px;
            padding: 0 16px 16px;
        }

        .lesson-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-start;
            margin-top: 16px;
        }

        .lesson-actions .btn {
            margin: 0;
        }

        /* === NUEVO REPRODUCTOR DE VIDEO PERSONALIZADO - CORREGIDO === */
        .player-container {
            width: 100%;
            max-width: 800px;
            background: #000;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            margin: 12px 0;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 450px;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        .corner-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 40px;
            background: rgba(0,0,0,0.95);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 20;
            pointer-events: none;
            cursor: default;
            color: #fff;
            backdrop-filter: blur(5px);
            padding: 5px;
        }

        .corner-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .exit-fullscreen {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 30;
            cursor: pointer;
            display: none;
            color: #000;
            font-weight: bold;
        }

        .controls-panel {
            background: #000;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            margin-top: 0;
            transition: opacity 0.3s ease;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .progress-container-player {
            flex: 1;
            height: 20px;
            background: #444;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            z-index: 15;
        }

        .progress-player {
            height: 100%;
            background: #ff0000;
            border-radius: 10px;
            width: 0%;
            transform-origin: left center;
            position: absolute;
            left: 0;
            top: 0;
        }

        .thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            left: 0px;
        }

        .time-display {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            font-family: monospace;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 30;
            position: relative;
        }

        .video-controls button {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            flex: 1;
            max-width: 200px;
        }

        .video-controls button:hover {
            background: #cc0000;
        }

        /* === MODIFICACIONES PARA LANDSCAPE EN PANTALLA COMPLETA === */
        /* Pantalla completa CORREGIDA - Video centrado y completo */
        .player-container:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        .player-container:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        .player-container:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        :-webkit-full-screen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :-moz-full-screen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :fullscreen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :-webkit-full-screen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        :-moz-full-screen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        :fullscreen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Controles flotantes en pantalla completa - NO empujan el contenido */
        :-webkit-full-screen .controls-panel {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            border-radius: 0 !important;
            padding: 15px 20px !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        :-moz-full-screen .controls-panel {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            border-radius: 0 !important;
            padding: 15px 20px !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        :fullscreen .controls-panel {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            border-radius: 0 !important;
            padding: 15px 20px !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(100%);
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        /* Mostrar controles cuando tienen la clase 'show-controls' */
        :-webkit-full-screen .controls-panel.show-controls {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }
        
        :-moz-full-screen .controls-panel.show-controls {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }
        
        :fullscreen .controls-panel.show-controls {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }
        
        /* BotÃ³n de salir de pantalla completa siempre visible */
        :-webkit-full-screen .exit-fullscreen {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 50;
        }
        
        :-moz-full-screen .exit-fullscreen {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 50;
        }
        
        :fullscreen .exit-fullscreen {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 50;
        }
        
        /* Corner box siempre visible */
        :-webkit-full-screen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 45;
        }
        
        :-moz-full-screen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 45;
        }
        
        :fullscreen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 45;
        }

        /* === CORRECCIÃ“N DEFINITIVA PARA LANDSCAPE - PROPORCIÃ“N MANTENIDA === */
        @media (max-width: 926px) and (orientation: landscape) {
            
            /* ðŸ”¹ PLAYER-CONTAINER: estructura principal en landscape */
            :-webkit-full-screen .player-container,
            :-moz-full-screen .player-container,
            :fullscreen .player-container {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
                height: 100vh !important;
                background: #000 !important;
                justify-content: space-between !important;
            }

            /* ðŸ”¹ CONTENEDOR DE VIDEO: ocupa espacio disponible */
            :-webkit-full-screen .video-container,
            :-moz-full-screen .video-container,
            :fullscreen .video-container {
                flex: 1 !important; /* Ocupa todo el espacio disponible */
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                background: #000 !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
                position: relative !important;
                overflow: hidden !important;
            }

            /* ðŸ”¹ VIDEO DENTRO DEL CONTENEDOR: proporciÃ³n 16:9 centrado */
            :-webkit-full-screen .video-container div[id^="player-"],
            :-moz-full-screen .video-container div[id^="player-"],
            :fullscreen .video-container div[id^="player-"] {
                width: auto !important;
                height: auto !important;
                max-width: 100% !important;
                max-height: 100% !important;
                object-fit: contain !important;
                aspect-ratio: 16 / 9 !important;
                flex-shrink: 0;
            }

            /* ðŸ”¹ CONTROLES: flotantes en la parte inferior */
            :-webkit-full-screen .controls-panel,
            :-moz-full-screen .controls-panel,
            :fullscreen .controls-panel {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: auto !important;
                min-height: 80px !important;
                max-height: 80px !important;
                padding: 10px 15px !important;
                background: rgba(0, 0, 0, 0.8) !important;
                backdrop-filter: blur(5px);
                display: flex !important;
                align-items: center !important;
                justify-content: space-around !important;
                opacity: 0;
                visibility: hidden;
                transform: translateY(100%);
                transition: all 0.3s ease;
                z-index: 40;
            }

            /* Mostrar controles cuando tienen la clase 'show-controls' */
            :-webkit-full-screen .controls-panel.show-controls,
            :-moz-full-screen .controls-panel.show-controls,
            :fullscreen .controls-panel.show-controls {
                opacity: 1 !important;
                visibility: visible !important;
                transform: translateY(0) !important;
            }

            /* Ajuste de botones */
            :-webkit-full-screen .video-controls button,
            :-moz-full-screen .video-controls button,
            :fullscreen .video-controls button {
                font-size: 14px !important;
                padding: 8px 12px !important;
                min-width: 90px;
                margin: 0 5px !important;
            }
        }

        /* === MEJORAS EN BOTONES DE CABECERAS === */
        .course-buttons, .module-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .course-buttons .btn, .module-buttons .btn {
            margin: 0;
        }

        /* === NUEVOS ESTILOS PARA INFORMACIÃ“N DE CURSO === */
        .course-info-text {
            margin-top: 15px;
            padding: 12px;
            background: var(--neutro);
            border-radius: 8px;
            border-left: 4px solid var(--azul);
        }
        
        .course-info-item {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .course-info-item:last-child {
            margin-bottom: 0;
        }
        
        .course-info-icon {
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .course-info-content {
            flex: 1;
        }
        
        .course-info-label {
            font-weight: 600;
            color: var(--azul-oscuro);
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .course-info-value {
            color: var(--azul-profundo);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .course-info-value a {
            color: var(--azul);
            text-decoration: none;
        }
        
        .course-info-value a:hover {
            text-decoration: underline;
        }

        /* === RESPONSIVE PARA EL ACORDEÃ“N REORGANIZADO === */
        @media (max-width: 768px) {
            .lesson-header {
                padding: 12px;
                flex-direction: column;
            }
            
            .lesson-number-container {
                margin-bottom: 8px;
            }
            
            .lesson-thumbnail {
                width: 100%;
                height: 150px;
                margin-right: 0;
                margin-bottom: 12px;
            }
            
            .lesson-main-content {
                width: 100%;
            }
            
            .lesson-actions {
                gap: 6px;
            }
            
            .lesson-actions .btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 480px) {
            .lesson-header {
                padding: 10px;
            }
            
            .lesson-thumbnail {
                height: 120px;
            }
            
            .lesson-actions {
                gap: 4px;
            }
            
            .lesson-actions .btn {
                font-size: 10px;
                padding: 5px 8px;
            }
        }

        /* === MODAL PARA ENCUESTAS === */
        .survey-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .survey-modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            width: 100%;
            max-width: 900px;
            height: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .survey-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--azul-oscuro);
            color: white;
        }

        .survey-modal-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .close-survey-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-survey-modal:hover {
            background: rgba(255,255,255,0.2);
        }

        .survey-iframe-container {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
        }

        .survey-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* === SISTEMA DE LOGIN OPTIMIZADO === */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .form-container {
            width: 320px;
            padding: 25px;
            text-align: center;
        }

        .school-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .login-school-logo {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            margin: 0 auto 12px;
            display: block;
            border-radius: 8px;
            background: var(--neutro);
            padding: 8px;
        }

        .login-title {
            text-align: center;
            color: var(--azul-oscuro);
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 22px;
        }

        input[type=text], input[type=password], input[type=email], input[type=tel] {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            outline: none;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            background: white;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        input[type=text]:focus, input[type=password]:focus, input[type=email]:focus, input[type=tel]:focus {
            border-bottom: 2px solid var(--naranja);
        }

        input[type=submit], input[type=button] {
            width: 100%;
            margin: 5px 0;
        }

        .error-message {
            color: var(--error);
            font-size: 11px;
            text-align: center;
            margin: 8px 0;
            min-height: 18px;
        }

        .login-links {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .login-link {
            background: transparent;
            border: none;
            color: var(--azul);
            text-decoration: underline;
            font-size: 12px;
            cursor: pointer;
            padding: 5px;
        }
        
        .login-link:hover {
            color: var(--azul-oscuro);
        }

        /* === MODALES PARA REGISTRO Y RECUPERACIÃ“N === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--azul-oscuro);
            font-size: 13px;
        }

        /* === CABECERAS DE CURSO Y MÃ“DULO === */
        .course-header, .module-header-expanded {
            display: none;
        }

        .course-title-section, .module-title-section {
            text-align: center;
            margin-bottom: 15px;
        }

        .course-title-section h1 {
            color: var(--azul-oscuro);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .module-title-section h2 {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .course-content, .module-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .course-image-container, .module-image-container {
            flex: 0 0 150px;
        }

        .course-header-image, .module-header-image {
            width: 100%;
            max-height: 120px;
            object-fit: cover;
            border-radius: 10px;
        }

        .course-info, .module-info {
            flex: 1;
        }

        .course-description, .module-description {
            color: var(--azul-profundo);
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 14px;
        }

        /* === COMPONENTES DE INTERFAZ AVANZADOS === */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 13px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error);
        }

        /* === MODAL UNIFICADO PARA MANUALES Y CALENDARIO === */
        #universalManualModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #universalManualModal .modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            max-width: 900px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        #universalManualModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--azul-oscuro);
            color: white;
        }

        #universalManualModal .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        #universalManualModal .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        #universalManualModal iframe {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
        }

        /* === SISTEMA RESPONSIVO MEJORADO === */
        @media (max-width: 768px) {
            .container {
                padding: 10px 10px 5px;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 12px 15px;
            }
            
            .school-brand, .user-welcome {
                justify-content: center;
                text-align: center;
                min-width: auto;
            }

            .user-welcome {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .course-content, .module-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .course-image-container, .module-image-container {
                flex: 0 0 auto;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
            
            .grid-cursos, .grid-modulos {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .player-container {
                padding: 10px;
                margin: 10px 0;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .form-container {
                width: 100%;
                max-width: 300px;
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
                justify-content: center;
            }
            
            .modal-content {
                padding: 15px;
            }
        }

        /* === ESTILOS ADICIONALES PARA CONTENIDO EXPANDIDO === */
        .expanded-module {
            width: 100%;
            padding: 0;
            margin-bottom: 5px;
        }

        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
        }

        .module-progress-expanded {
            margin: 15px 0;
            padding: 12px;
            text-align: center;
        }

        .content-list-expanded {
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .notes-area {
            display: none;
            margin-top: 8px;
        }

        .notes-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
        }

        .save-notes-btn {
            margin-top: 8px;
        }

        .manual-container {
            display: none;
            margin-top: 8px;
        }

        .image-fallback {
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        .no-content {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- PÃ¡gina 1: Login -->
    <div class="login-container" id="page1_id1">
        <div class="form-container card">
            <div class="school-header">
                <div id="defaultLogo" style="font-size: 40px; margin-bottom: 12px;">ðŸŽ“</div>
                <h1 class="login-title" id="schoolTitle">Plataforma Educativa</h1>
            </div>
            <input type="text" id="username" placeholder="Usuario" />
            <input type="password" id="password" placeholder="ContraseÃ±a" />
            <div class="error-message" id="errorMessage"></div>
            <input type="submit" class="btn btn-primary" value="Ingresar" onclick="LoginUser()" />
            
            <div class="login-links">
                <button class="login-link" onclick="showRegisterModal()">Â¿No tienes cuenta? RegÃ­strate</button>
                <button class="login-link" onclick="showForgotPasswordModal()">Â¿Olvidaste tu contraseÃ±a?</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Crear Cuenta</h2>
                <button class="close-modal" onclick="closeRegisterModal()">âœ•</button>
            </div>
            <div class="form-group">
                <input type="text" id="registerName" placeholder="Nombre" />
            </div>
            <div class="form-group">
                <input type="text" id="registerLastName" placeholder="Apellido" />
            </div>
            <div class="form-group">
                <input type="text" id="registerUser" placeholder="Usuario" />
            </div>
            <div class="form-group">
                <input type="password" id="registerPassword" placeholder="ContraseÃ±a" />
            </div>
            <div class="form-group">
                <input type="email" id="registerEmail" placeholder="Correo electrÃ³nico" />
            </div>
            <div class="form-group">
                <input type="tel" id="registerPhone" placeholder="TelÃ©fono (opcional)" />
            </div>
            <div class="error-message" id="registerErrorMessage"></div>
            <button class="btn btn-primary" onclick="registerUser()">Registrarse</button>
        </div>
    </div>

    <!-- Modal de OlvidÃ© ContraseÃ±a -->
    <div id="forgotPasswordModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Recuperar ContraseÃ±a</h2>
                <button class="close-modal" onclick="closeForgotPasswordModal()">âœ•</button>
            </div>
            <p style="margin-bottom: 15px; text-align: center; color: var(--gray); font-size: 14px;">
                Ingresa tu correo electrÃ³nico y te enviaremos un enlace para restablecer tu contraseÃ±a.
            </p>
            <div class="form-group">
                <input type="email" id="forgotPasswordEmail" placeholder="Correo electrÃ³nico" />
            </div>
            <div class="error-message" id="forgotPasswordErrorMessage"></div>
            <button class="btn btn-primary" onclick="sendPasswordReset()">Enviar enlace</button>
        </div>
    </div>

    <!-- PÃ¡gina 4: Dashboard del usuario -->
    <div class="dashboard page4_class1-off" id="page4_id1" style="display: none;">
        <div class="container">
            <!-- Cabecera Superior -->
            <div class="header-container card">
                <div class="school-brand">
                    <img id="schoolLogo" class="school-logo" src="" alt="Logo Escuela" onerror="this.style.display='none'">
                    <div class="school-name" id="headerSchoolName">Plataforma Educativa</div>
                </div>
                <div class="user-welcome">
                    <h2>Â¡Hola <span id="displayusername" style="color:var(--azul);"></span>!</h2>
                    <div class="status-badge">Estado: <span id="userStatus">Activo</span></div>
                    <button class="btn btn-error" onclick="logout()">ðŸšª Cerrar SesiÃ³n</button>
                </div>
            </div>

            <!-- Cabecera del Curso (se muestra al acceder a un curso) -->
            <div id="courseHeader" class="course-header card">
                <div class="course-title-section">
                    <h1 id="courseTitle">Nombre del Curso</h1>
                </div>
                <div class="course-content">
                    <div class="course-image-container">
                        <img id="courseHeaderImage" class="course-header-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
                    </div>
                    <div class="course-info">
                        <p id="courseDescription" class="course-description">DescripciÃ³n del curso...</p>
                        
                        <!-- InformaciÃ³n del curso (calendario y mensaje) -->
                        <div id="courseInfoText" class="course-info-text" style="display: none;">
                            <!-- El contenido se agregarÃ¡ dinÃ¡micamente -->
                        </div>
                        
                        <div id="courseButtons" class="course-buttons">
                            <!-- Los botones se agregarÃ¡n dinÃ¡micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <h2 style="color: var(--azul-oscuro); margin-bottom: 12px;" id="mainTitle">Mis Cursos</h2>
            <div id="cursosContainer" class="grid grid-cursos">
                <div class="loading">Cargando cursos...</div>
            </div>
            
            <div id="modulesContainer">
                <!-- Los mÃ³dulos se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
            </div>
        </div>
    </div>

    <!-- Modal Unificado para Manuales y Calendario -->
    <div id="universalManualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manualModalTitle">Manual</h3>
                <button class="close-modal" onclick="closeManualViewer()">âœ•</button>
            </div>
            <iframe id="manualModalFrame"></iframe>
        </div>
    </div>

    <!-- Modal para Encuestas -->
    <div id="universalSurveyModal" class="survey-modal-overlay">
        <div class="survey-modal-content">
            <div class="survey-modal-header">
                <h3 class="survey-modal-title">Encuesta</h3>
                <button class="close-survey-modal" onclick="closeSurveyViewer()">âœ•</button>
            </div>
            <div class="survey-iframe-container">
                <iframe id="surveyModalFrame"></iframe>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURACIÃ“N GITHUB ===
        const CONFIG = {
            API_BASE_URL: 'https://escuuelaapi1.jorge-altagracia.workers.dev/'
        };

        // === VARIABLES GLOBALES ===
        let currentUser = null;
        let userProgress = {};
        let userModules = [];
        let currentPlayers = {};
        let alumnoActual = null;
        let cursosCache = null;
        let currentCourseId = null;
        let currentGrupoId = null;
        let escuelaData = null;
        let currentCourseData = null;
        let dragging = false;
        
        // === NUEVAS VARIABLES PARA CONTROL DE CONTROLES ===
        let hideControlsTimers = {};
        let isFullscreen = false;
        
        // === VARIABLES PARA EL ACORDEÃ“N ===
        let currentOpenAccordion = null;

        // === SISTEMA DE JSONP MEJORADO ===
        function callJSONP(action, data = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Construir URL con parÃ¡metros
                const params = new URLSearchParams();
                params.append('action', action);
                params.append('callback', callbackName);
                
                // Agregar datos especÃ­ficos
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        params.append(key, String(data[key]));
                    }
                });
                
                const url = CONFIG.API_BASE_URL + '?' + params.toString();
                
                console.log('ðŸ” Llamando a:', url);
                
                const script = document.createElement('script');
                script.src = url;
                
                // Configurar callback global
                window[callbackName] = function(response) {
                    // Limpiar
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    console.log('ðŸ“¨ Respuesta recibida:', response);
                    
                    if (response && response.success !== undefined) {
                        resolve(response);
                    } else {
                        reject(new Error(response ? response.error : 'Error desconocido'));
                    }
                };
                
                // Manejar errores
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Error de red al conectar con el servidor'));
                };
                
                // Timeout despuÃ©s de 30 segundos
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Timeout de la solicitud despuÃ©s de 30 segundos'));
                    }
                }, 30000);
                
                // Limpiar timeout cuando se recibe respuesta
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeoutId);
                    originalCallback(response);
                };
                
                document.body.appendChild(script);
            });
        }

        // === INICIALIZACIÃ“N ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSchoolData().catch(error => {
                console.log('No se pudieron cargar los datos de la escuela:', error.message);
            });
        });

        // === FUNCIONES PARA DATOS DE LA ESCUELA ===
        async function loadSchoolData() {
            try {
                const response = await callJSONP('escuela', {});
                if (response.data && response.data.length > 0) {
                    escuelaData = response.data[0];
                    updateSchoolUI();
                } else {
                    setDefaultSchoolData();
                }
            } catch (error) {
                console.error('Error cargando datos de la escuela:', error);
                setDefaultSchoolData();
            }
        }

        function updateSchoolUI() {
            if (!escuelaData) return;
            
            // Actualizar tÃ­tulo en login
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle && escuelaData['Nombre_Escuela ']) {
                loginTitle.innerHTML = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar nombre en cabecera del dashboard
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName && escuelaData['Nombre_Escuela ']) {
                headerSchoolName.textContent = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar logo si existe
            if (escuelaData['Logo_Escuela']) {
                const logoImg = document.getElementById('schoolLogo');
                logoImg.src = escuelaData['Logo_Escuela'];
                logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                logoImg.style.display = 'block';
            }

            // Actualizar logo en login si existe
            if (escuelaData['Logo_Escuela']) {
                const loginHeader = document.querySelector('.school-header');
                if (loginHeader) {
                    const defaultLogo = document.getElementById('defaultLogo');
                    defaultLogo.style.display = 'none';
                    
                    const logoImg = document.createElement('img');
                    logoImg.src = escuelaData['Logo_Escuela'];
                    logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                    logoImg.className = 'login-school-logo';
                    logoImg.onerror = function() {
                        this.style.display = 'none';
                        defaultLogo.style.display = 'block';
                    };
                    
                    loginHeader.insertBefore(logoImg, defaultLogo);
                }
            }
        }

        function setDefaultSchoolData() {
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle) {
                loginTitle.innerHTML = 'Plataforma Educativa';
            }
            
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName) {
                headerSchoolName.textContent = 'Plataforma Educativa';
            }
        }

        // === FUNCIONES DE LOGIN ===
        async function LoginUser() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            
            if (!username || !password) {
                document.getElementById("errorMessage").innerHTML = "Complete todos los campos";
                return;
            }
            
            document.getElementById("errorMessage").innerHTML = "ðŸ” Verificando credenciales...";
            
            try {
                const response = await callJSONP('login', { username, password });
                
                if(response.success) {
                    handleSuccessfulLogin(response);
                } else {
                    document.getElementById("errorMessage").innerHTML = "âŒ " + response.error;
                }
            } catch (error) {
                document.getElementById("errorMessage").innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
            }
        }

        function handleSuccessfulLogin(response) {
            currentUser = response.alumno;
            alumnoActual = response.alumno;
            document.getElementById("displayusername").innerHTML = currentUser.Nombre + " " + currentUser.Apellido;
            
            // Mostrar dashboard
            document.getElementById("page1_id1").style.display = "none";
            document.getElementById("page4_id1").style.display = "block";
            document.getElementById("errorMessage").innerHTML = "";
            
            // Cargar progreso del usuario
            loadUserProgress(currentUser.ID_Alumno);
            loadCursos();
        }

        // === NUEVAS FUNCIONES PARA REGISTRO Y RECUPERACIÃ“N ===
        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'flex';
            clearRegisterForm();
        }
        
        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }
        
        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotPasswordErrorMessage').innerHTML = '';
            document.getElementById('forgotPasswordEmail').value = '';
        }
        
        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }
        
        function clearRegisterForm() {
            document.getElementById('registerName').value = '';
            document.getElementById('registerLastName').value = '';
            document.getElementById('registerUser').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerErrorMessage').innerHTML = '';
        }
        
        async function registerUser() {
            const name = document.getElementById('registerName').value.trim();
            const lastName = document.getElementById('registerLastName').value.trim();
            const user = document.getElementById('registerUser').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            
            // Validaciones bÃ¡sicas
            if (!name || !lastName || !user || !password || !email) {
                document.getElementById('registerErrorMessage').innerHTML = "Todos los campos excepto telÃ©fono son obligatorios";
                return;
            }
            
            if (password.length < 6) {
                document.getElementById('registerErrorMessage').innerHTML = "La contraseÃ±a debe tener al menos 6 caracteres";
                return;
            }
            
            document.getElementById('registerErrorMessage').innerHTML = "ðŸ”„ Creando cuenta...";
            
            try {
                const response = await callJSONP('register', {
                    nombre: name,
                    apellido: lastName,
                    usuario: user,
                    contraseÃ±a: password,
                    email: email,
                    telefono: phone
                });
                
                if (response.success) {
                    showNotification('âœ… Cuenta creada exitosamente. Ahora puedes iniciar sesiÃ³n.');
                    closeRegisterModal();
                    document.getElementById('username').value = user;
                    document.getElementById('password').value = '';
                } else {
                    document.getElementById('registerErrorMessage').innerHTML = "âŒ " + response.error;
                }
            } catch (error) {
                document.getElementById('registerErrorMessage').innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
            }
        }
        
        async function sendPasswordReset() {
            const email = document.getElementById('forgotPasswordEmail').value.trim();
            
            if (!email) {
                document.getElementById('forgotPasswordErrorMessage').innerHTML = "Por favor ingresa tu correo electrÃ³nico";
                return;
            }
            
            document.getElementById('forgotPasswordErrorMessage').innerHTML = "ðŸ”„ Enviando enlace de recuperaciÃ³n...";
            
            try {
                const response = await callJSONP('forgotPassword', { email });
                
                if (response.success) {
                    showNotification('âœ… Se ha enviado un enlace de recuperaciÃ³n a tu correo electrÃ³nico.');
                    closeForgotPasswordModal();
                } else {
                    document.getElementById('forgotPasswordErrorMessage').innerHTML = "âŒ " + response.error;
                }
            } catch (error) {
                document.getElementById('forgotPasswordErrorMessage').innerHTML = "ðŸ”’ Error de conexiÃ³n: " + error.message;
            }
        }

        // === FUNCIÃ“N PARA CARGAR PROGRESO MEJORADA ===
        async function loadUserProgress(alumnoId) {
            try {
                console.log('ðŸ“Š Cargando progreso para alumno:', alumnoId);
                
                const result = await callJSONP('getUserProgress', { alumnoId });
                
                console.log('ðŸ“¥ Respuesta de getUserProgress:', result);
                
                userProgress = {};
                
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(function(item) {
                        if (item.ID_Clase) {
                            userProgress[item.ID_Clase] = {
                                completed: item.Completada === "SÃ­" || item.Completada === true,
                                notes: item.Notas_Alumno || '',
                                lastUpdate: item.Fecha_Guardado || new Date()
                            };
                        }
                    });
                    
                    console.log(`âœ… Progreso cargado: ${Object.keys(userProgress).length} clases`);
                    console.log('Detalle del progreso:', userProgress);
                } else {
                    console.log('â„¹ï¸ No se encontrÃ³ progreso previo para este alumno');
                }
                
            } catch (error) {
                console.error("ðŸ’¥ Error cargando progreso:", error);
                userProgress = {};
                showNotification('âš ï¸ No se pudo cargar el progreso previo', 'error');
            }
        }

        // === FUNCIONES DE CURSOS CON CACHE FRONTEND ===
        async function loadCursos() {
            const container = document.getElementById('cursosContainer');
            const cacheKey = `cursos_${alumnoActual.ID_Alumno}`;
            
            // Verificar cache local
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                console.log('Cargando cursos desde cache frontend');
                displayCursos(JSON.parse(cached));
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando cursos...</div>';
            
            try {
                const result = await callJSONP('getCursosAlumno', { alumnoId: alumnoActual.ID_Alumno });
                // Guardar en cache local
                sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                displayCursos(result.data);
            } catch (error) {
                showCursosError(error);
            }
        }

        function displayCursos(cursos) {
            cursosCache = cursos;
            const container = document.getElementById('cursosContainer');
            
            if (!cursos || cursos.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">ðŸŽ“</div>
                        <h3 style="color: var(--azul-oscuro); margin-bottom: 6px;">No estÃ¡s inscrito en ningÃºn curso visible</h3>
                        <p style="color: var(--gray); margin-bottom: 12px;">
                            Contacta al administrador para inscribirte en los cursos.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cursos.map(curso => {
                const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
                return `
                <div class="curso-card card" onclick="accederAlCurso('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                    <div class="curso-imagen">
                        ${hasImage ? 
                            `<img src="${curso.Foto_Portada}" 
                                  alt="${curso.Nombre_Curso}" 
                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                  onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                            ''
                        }
                        <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">ðŸŽ“</div>
                    </div>
                    <div class="curso-content">
                        <h3 class="curso-titulo">${curso.Nombre_Curso}</h3>
                        <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                        <p class="curso-grupo">Inicio: ${formatFecha(curso.Fecha_Inicio)}</p>
                        <button class="btn btn-primary btn-acceder">Acceder al curso</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showCursosError(error) {
            const container = document.getElementById('cursosContainer');
            container.innerHTML = '<div class="error">Error al cargar los cursos: ' + error.message + '</div>';
        }

        async function accederAlCurso(cursoId, grupoId) {
            currentCourseId = cursoId;
            currentGrupoId = grupoId;
            
            // Encontrar los datos del curso actual
            currentCourseData = cursosCache.find(curso => 
                curso.ID_Curso === cursoId && curso.ID_Grupo === grupoId
            );
            
            // Mostrar cabecera del curso
            if (currentCourseData) {
                document.getElementById('courseTitle').textContent = currentCourseData.Nombre_Curso;
                document.getElementById('courseDescription').textContent = currentCourseData.Descripcion || 'No hay descripciÃ³n disponible para este curso.';
                
                // Imagen de cabecera del curso
                if (currentCourseData.Foto_Cabecera) {
                    document.getElementById('courseHeaderImage').src = currentCourseData.Foto_Cabecera;
                    document.getElementById('courseHeaderImage').style.display = 'block';
                } else {
                    document.getElementById('courseHeaderImage').style.display = 'none';
                }
                
                // Actualizar informaciÃ³n del curso (calendario y mensaje)
                updateCourseInfo();
                
                // Actualizar botones del curso
                updateCourseButtons();
                
                document.getElementById('courseHeader').style.display = 'block';
            }
            
            // Ocultar cursos y mostrar mÃ³dulos
            document.getElementById('cursosContainer').style.display = 'none';
            document.getElementById('mainTitle').textContent = 'MÃ³dulos del Curso';
            
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button><div class="loading">Cargando mÃ³dulos...</div>';
            
            // Desplazar hacia el contenedor de mÃ³dulos
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
            
            const cacheKey = `modulos_${alumnoActual.ID_Alumno}_${cursoId}_${grupoId}`;
            const cached = sessionStorage.getItem(cacheKey);
            
            if (cached) {
                console.log('Cargando mÃ³dulos desde cache frontend');
                displayModulos(JSON.parse(cached), cursoId, grupoId);
            } else {
                try {
                    const result = await callJSONP('getModulosCurso', {
                        alumnoId: alumnoActual.ID_Alumno,
                        cursoId: cursoId,
                        grupoId: grupoId
                    });
                    sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                    displayModulos(result.data, cursoId, grupoId);
                } catch (error) {
                    container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button><div class="error">Error al cargar mÃ³dulos: ' + error.message + '</div>';
                }
            }
        }

        // === NUEVA FUNCIÃ“N PARA MOSTRAR INFORMACIÃ“N DEL CURSO - MODIFICADA ===
        function updateCourseInfo() {
            const infoContainer = document.getElementById('courseInfoText');
            infoContainer.innerHTML = '';
            
            let hasInfo = false;
            
            // Mostrar mensaje como texto
            if (currentCourseData.Mensaje) {
                hasInfo = true;
                const messageItem = document.createElement('div');
                messageItem.className = 'course-info-item';
                messageItem.innerHTML = `
                    <div class="course-info-icon">ðŸ“¢</div>
                    <div class="course-info-content">
                        <div class="course-info-label">Mensaje Importante</div>
                        <div class="course-info-value">${currentCourseData.Mensaje}</div>
                    </div>
                `;
                infoContainer.appendChild(messageItem);
            }
            
            // Mostrar el contenedor solo si hay informaciÃ³n
            infoContainer.style.display = hasInfo ? 'block' : 'none';
        }

        // === FUNCIÃ“N ACTUALIZADA PARA BOTONES DEL CURSO - CON CALENDARIO ===
        function updateCourseButtons() {
            const buttonsContainer = document.getElementById('courseButtons');
            buttonsContainer.innerHTML = '';
            
            // BotÃ³n manual del curso
            if (currentCourseData.Manual_c) {
                const manualBtn = document.createElement('button');
                manualBtn.className = 'btn btn-primary';
                manualBtn.innerHTML = 'ðŸ“˜ Manual del Curso';
                manualBtn.onclick = function() {
                    showCourseManual(currentCourseData.Manual_c);
                };
                buttonsContainer.appendChild(manualBtn);
            }
            
            // BotÃ³n calendario lectivo
            if (currentCourseData.Calendario) {
                const calendarBtn = document.createElement('button');
                calendarBtn.className = 'btn btn-secondary';
                calendarBtn.innerHTML = 'ðŸ“… Calendario Lectivo';
                calendarBtn.onclick = function() {
                    openManualViewer(currentCourseData.Calendario, 'Calendario Lectivo');
                };
                buttonsContainer.appendChild(calendarBtn);
            }
            
            // BotÃ³n WhatsApp
            if (currentCourseData.Whatsapp) {
                const whatsappBtn = document.createElement('button');
                whatsappBtn.className = 'btn btn-success';
                whatsappBtn.innerHTML = 'ðŸ“± WhatsApp del Grupo';
                whatsappBtn.onclick = function() {
                    window.open(currentCourseData.Whatsapp, '_blank');
                };
                buttonsContainer.appendChild(whatsappBtn);
            }
        }

        function volverACursos() {
            // Limpiar reproductores
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            currentPlayers = {};
            
            // Ocultar cabecera del curso
            document.getElementById('courseHeader').style.display = 'none';
            
            // Mostrar cursos nuevamente
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';
            document.getElementById('cursosContainer').style.display = 'grid';
            document.getElementById('mainTitle').textContent = 'Mis Cursos';
        }

        // === SISTEMA DE MÃ“DULOS Y CLASES - MODIFICADO ===
        function displayModulos(modules, cursoId, grupoId) {
            const container = document.getElementById("modulesContainer");
            container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">â† Volver a Mis Cursos</button>';
            
            if (!modules || modules.length === 0) {
                container.innerHTML += "<p class='no-content'>No tienes mÃ³dulos disponibles en este momento.</p>";
                return;
            }
            
            userModules = modules;
            
            let modulesList = "<h3 style='color: var(--azul-oscuro); margin-bottom: 12px;'>Tus MÃ³dulos Disponibles:</h3><div class='grid grid-modulos'>";
            
            modules.forEach(module => {
                const progressPercentage = module.Total_Clases > 0 ? 
                    Math.round((module.Clases_Completadas / module.Total_Clases) * 100) : 0;
                
                modulesList += `
                <div class='module-card card' onclick='expandModule("${module.ID_MÃ³dulo}")'>
                    <h4 class="module-titulo">${module['Nombre del MÃ³dulo'] || module.Nombre_Modulo}</h4>
                    <div class='progress-container'>
                        <div class='progress-label'>Progreso del MÃ³dulo</div>
                        <div class='progress-bar-container'>
                            <div class='progress-bar' style='width: ${progressPercentage}%'></div>
                        </div>
                        <div class='progress-text'>${progressPercentage}% completado</div>
                    </div>
                </div>`;
            });
            
            modulesList += "</div>";
            container.innerHTML += modulesList;
        }

        function expandModule(moduleId) {
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'none';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'none';
            
            var selectedModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_MÃ³dulo === moduleId) {
                    selectedModule = userModules[i];
                    break;
                }
            }
            
            if (!selectedModule) return;
            
            var expandedContent = "<div class='expanded-module'>";
            
            // Cabecera del mÃ³dulo
            expandedContent += `
            <div class='module-header-expanded card'>
                <div class='module-title-section'>
                    <h2>${selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo}</h2>
                </div>
                <div class='module-content'>
                    <div class='module-image-container'>
                        ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 
                            `<img src="${selectedModule['imagen_m']}" class='module-header-image' alt='Imagen del mÃ³dulo' onerror='this.style.display=\"none\"; this.nextElementSibling.style.display=\"flex\";' onload='this.style.display=\"block\"; this.nextElementSibling.style.display=\"none\";'>` : 
                            ''
                        }
                        <div style="width: 140px; height: 100px; background: linear-gradient(135deg, var(--azul), var(--naranja)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 'display: none;' : ''}">ðŸ“š</div>
                    </div>
                    <div class='module-info'>
                        <p class='module-description'>${selectedModule['DescripciÃ³n del MÃ³dulo'] || 'No hay descripciÃ³n disponible para este mÃ³dulo.'}</p>
                        <div class='module-buttons'>
                            ${selectedModule['Manual_m'] && selectedModule['Manual_m'].trim() !== '' ? 
                                `<button class='btn btn-secondary' onclick='showModuleManual("${selectedModule['Manual_m']}")'>ðŸ“˜ Manual del MÃ³dulo</button>` : 
                                ''
                            }
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Resto del contenido del mÃ³dulo (clases)
            expandedContent += "<div class='module-header'>";
            expandedContent += "<button class='btn btn-secondary back-button' onclick='collapseModule()'>â† Mis MÃ³dulos</button>";
            expandedContent += "</div>";
            
            var completedCount = selectedModule.Clases_Completadas || 0;
            var totalCount = selectedModule.Total_Clases || 0;
            
            var progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            expandedContent += "<div class='module-progress-expanded progress-container'>";
            expandedContent += "<div class='progress-label'>Progreso del MÃ³dulo</div>";
            expandedContent += "<div class='progress-bar-container'>";
            expandedContent += "<div class='progress-bar' style='width: " + progressPercentage + "%'></div>";
            expandedContent += "</div>";
            expandedContent += "<div class='progress-text'>" + completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)</div>";
            expandedContent += "</div>";
            
            if (selectedModule.Clases && selectedModule.Clases.length > 0) {
                expandedContent += "<div class='content-list-expanded'>";
                
                for (var j = 0; j < selectedModule.Clases.length; j++) {
                    var content = selectedModule.Clases[j];
                    var lessonId = content.ID_Clase;
                    var isCompleted = userProgress[lessonId] && userProgress[lessonId].completed;
                    var hasNotes = userProgress[lessonId] && userProgress[lessonId].notes && userProgress[lessonId].notes.trim() !== '';
                    
                    // === NUEVA ESTRUCTURA DE ACORDEÃ“N REORGANIZADA ===
                    expandedContent += `
                    <div class='lesson-accordion ${isCompleted ? 'completed' : ''}' data-lesson="${lessonId}">
                        <div class='lesson-header' onclick="toggleLessonAccordion('${lessonId}')">
                            <div class='lesson-number-container'>
                                <div class='lesson-number'>${j+1}</div>
                                <div class='lesson-arrow'>â–¼</div>
                            </div>
                            <div class='lesson-thumbnail' onclick="event.stopPropagation(); toggleVideoPlayer('${lessonId}', '${content['URL Video']}')">`;
                    
                    // Miniatura del video
                    var videoUrl = content['URL Video'] || '';
                    var videoId = extractVideoId(videoUrl);
                    if (videoId) {
                        var thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                        expandedContent += `
                                        <img src='${thumbnailUrl}' alt='Miniatura del video'>
                                        <div class='play-icon'>â–¶</div>`;
                    } else {
                        expandedContent += `
                                        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #64748b; font-size: 20px;">ðŸ“¹</div>`;
                    }
                    
                    expandedContent += `
                            </div>
                            <div class='lesson-main-content'>
                                <div class='lesson-title'>${content['Nombre de la Clase'] || content.Nombre_Clase}</div>
                                <div class='lesson-description'>${content['DescripciÃ³n'] || 'No hay descripciÃ³n disponible para esta clase.'}</div>
                                <div class='vista-button-container'>
                                    <button id='vista-btn-${lessonId}' class='btn-vista ${isCompleted ? 'completed' : ''}' 
                                            onclick="event.stopPropagation(); toggleVista('${lessonId}', '${moduleId}', '${(selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo)}', '${(content['Nombre de la Clase'] || content.Nombre_Clase)}')">
                                        ${isCompleted ? 'Vista âœ“' : 'Vista'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class='lesson-content'>
                            <div class='lesson-actions'>
                                <button id='video-btn-${lessonId}' class='btn btn-secondary action-btn' onclick='toggleVideoPlayer("${lessonId}", "${content['URL Video']}")'>ðŸŽ¬ Ver Video</button>`;
                    
                    // BotÃ³n de manual si existe
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += `<button class='btn btn-secondary action-btn' onclick='showManual("${lessonId}", "${content['URL Manual']}")'>ðŸ“„ Ver Manual</button>`;
                    }
                    
                    // BotÃ³n de preguntas (antes encuesta) si existe
                    if (content['URL Encuesta'] && content['URL Encuesta'].trim() !== '') {
                        expandedContent += `<button class='btn btn-primary action-btn' onclick='openSurvey("${content['URL Encuesta']}")'>â“ Preguntas</button>`;
                    }
                    
                    expandedContent += `<button id='notes-btn-${lessonId}' class='btn btn-primary action-btn' onclick='toggleNotes("${lessonId}")'>`;
                    expandedContent += hasNotes ? "ðŸ“ Ver notas (" + (userProgress[lessonId].notes.length > 0 ? "1" : "0") + ")" : "ðŸ“ Agregar notas";
                    expandedContent += `</button>`;
                    
                    // BotÃ³n Siguiente Clase (excepto para la Ãºltima clase)
                    if (j < selectedModule.Clases.length - 1) {
                        expandedContent += `<button class='btn btn-secondary action-btn' onclick='nextClass("${lessonId}", "${moduleId}")'>âž¡ï¸ Siguiente Clase</button>`;
                    }
                    
                    expandedContent += `</div>
                        </div>
                    </div>`;
                    
                    // === REPRODUCTOR DE VIDEO ===
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += `<div id='player-container-${lessonId}' class='player-container' style='display: none;'>
                            <div class='video-container' id='videoContainer-${lessonId}'>
                                <div id='player-${lessonId}'></div>
                                <div class='overlay' id='overlay-${lessonId}'></div>
                                <div class='corner-box'>`;
                        if (escuelaData && escuelaData.Logo_Escuela) {
                            expandedContent += `<img src='${escuelaData.Logo_Escuela}' alt='Logo' class='school-logo-mini'>`;
                        } else {
                            expandedContent += "ðŸŽ“";
                        }
                        expandedContent += `</div>
                                <div class='exit-fullscreen' id='exitFullscreenBtn-${lessonId}'>âœ–</div>
                            </div>
                            <div class='controls-panel'>
                                <div class='progress-row'>
                                    <div class='progress-container-player' id='progressBar-${lessonId}'>
                                        <div class='progress-player' id='progress-${lessonId}'></div>
                                        <div class='thumb' id='thumb-${lessonId}'></div>
                                    </div>
                                    <div class='time-display' id='timeDisplay-${lessonId}'>0:00 / 0:00</div>
                                </div>
                                <div class='video-controls'>
                                    <button id='playPauseBtn-${lessonId}'>â–¶ Play</button>
                                    <button id='restartBtn-${lessonId}'>â® Reiniciar</button>
                                    <button id='fullscreenBtn-${lessonId}'>â›¶ Pantalla completa</button>
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    // === CONTENEDOR PARA EL MANUAL ===
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += `<div id='manual-container-${lessonId}' class='manual-container card' style='display: none;'>
                            <div class='manual-header'>
                                <h4>ðŸ“š Material de Estudio</h4>
                                <p>Accede a tu contenido educativo</p>
                            </div>
                            <div class='content-links'>
                                <button class='btn btn-secondary action-btn' onclick='downloadManual("${lessonId}", "${content['URL Manual']}")'>ðŸ“¥ Descargar</button>
                                <button class='btn btn-secondary action-btn' onclick='printManual("${lessonId}")'>ðŸ–¨ï¸ Imprimir</button>
                            </div>
                            <div id='welcome-message-${lessonId}' class='welcome-message'>
                                <h5>Â¡Bienvenido!</h5>
                                <p>Haz clic en "Ver Manual" para acceder al material de estudio.</p>
                                <p>Una vez abierto, podrÃ¡s descargarlo o imprimirlo segÃºn necesites.</p>
                            </div>
                            <iframe id='pdf-frame-${lessonId}' class='pdf-frame' style='display: none; width: 100%; height: 500px; border: none;'></iframe>
                        </div>`;
                    }
                    
                    // === ÃREA DE NOTAS ===
                    expandedContent += `<div id='notes-area-${lessonId}' class='notes-area card' style='display: none;'>
                        <h4>Notas para esta lecciÃ³n:</h4>
                        <textarea id='notes-text-${lessonId}' class='notes-textarea' placeholder='Escribe tus notas aquÃ­...'>`;
                    if (hasNotes) {
                        expandedContent += userProgress[lessonId].notes;
                    }
                    expandedContent += `</textarea>
                        <button id='save-notes-btn-${lessonId}' class='btn btn-primary save-notes-btn' onclick='saveNotes("${lessonId}", "${(selectedModule['Nombre del MÃ³dulo'] || selectedModule.Nombre_Modulo)}", "${(content['Nombre de la Clase'] || content.Nombre_Clase)}")'>Guardar notas</button>
                    </div>`;
                }
                
                expandedContent += "</div>";
            } else {
                expandedContent += "<p class='no-content'>Contenido prÃ³ximamente...</p>";
            }
            
            expandedContent += "</div>";
            
            var expandedContainer = document.createElement('div');
            expandedContainer.id = 'expanded-module-container';
            expandedContainer.innerHTML = expandedContent;
            
            document.getElementById('modulesContainer').appendChild(expandedContainer);
            
            // Desplazar hacia el mÃ³dulo expandido
            setTimeout(() => {
                expandedContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // === NUEVA FUNCIÃ“N PARA EL BOTÃ“N VISTA ===
        function toggleVista(lessonId, moduleId, moduleName, lessonName) {
            const vistaBtn = document.getElementById('vista-btn-' + lessonId);
            const isCurrentlyCompleted = vistaBtn.classList.contains('completed');
            const newCompletedState = !isCurrentlyCompleted;
            
            // Actualizar visualmente el botÃ³n inmediatamente
            if (newCompletedState) {
                vistaBtn.classList.add('completed');
                vistaBtn.textContent = 'Vista âœ“';
            } else {
                vistaBtn.classList.remove('completed');
                vistaBtn.textContent = 'Vista';
            }
            
            // Llamar a la funciÃ³n existente para guardar el estado
            markAsViewed(lessonId, moduleId, moduleName, lessonName, {checked: newCompletedState});
        }

        // === FUNCIÃ“N PARA CONTROLAR EL ACORDEÃ“N ===
        function toggleLessonAccordion(lessonId) {
            const accordion = document.querySelector(`.lesson-accordion[data-lesson="${lessonId}"]`);
            
            // Si ya estÃ¡ abierto, cerrarlo y pausar video
            if (accordion.classList.contains('active')) {
                accordion.classList.remove('active');
                hideVideoPlayer(lessonId);
                currentOpenAccordion = null;
                return;
            }
            
            // Cerrar el acordeÃ³n abierto actualmente
            if (currentOpenAccordion && currentOpenAccordion !== accordion) {
                const previousLessonId = currentOpenAccordion.getAttribute('data-lesson');
                currentOpenAccordion.classList.remove('active');
                hideVideoPlayer(previousLessonId);
            }
            
            // Abrir el nuevo acordeÃ³n
            accordion.classList.add('active');
            currentOpenAccordion = accordion;
        }

        function collapseModule() {
            var expandedContainer = document.getElementById('expanded-module-container');
            if (expandedContainer) {
                expandedContainer.remove();
            }
            
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'block';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'block';
            
            // Resetear el acordeÃ³n abierto
            currentOpenAccordion = null;
        }

        // === NUEVA FUNCIÃ“N PARA ALTERNAR EL REPRODUCTOR DE VIDEO ===
        function toggleVideoPlayer(lessonId, videoUrl) {
            const playerContainer = document.getElementById('player-container-' + lessonId);
            const videoBtn = document.getElementById('video-btn-' + lessonId);
            
            if (playerContainer.style.display === 'none' || !playerContainer.style.display) {
                // Mostrar el video
                showVideoPlayer(lessonId, videoUrl);
                videoBtn.textContent = 'âŒ Cerrar Video';
            } else {
                // Ocultar el video
                hideVideoPlayer(lessonId);
                videoBtn.textContent = 'ðŸŽ¬ Ver Video';
            }
        }

        // === FUNCIÃ“N CORREGIDA PARA GUARDAR PROGRESO ===
        async function saveProgressToDatabase(lessonId, completed, notes) {
            try {
                console.log('ðŸ’¾ Intentando guardar progreso:', {
                    alumno: alumnoActual.ID_Alumno,
                    clase: lessonId,
                    completada: completed,
                    notasLength: notes ? notes.length : 0
                });
                
                const params = {
                    action: 'saveProgress',
                    ID_Alumno: alumnoActual.ID_Alumno,
                    ID_Clase: lessonId,
                    Fecha_Guardado: new Date().toISOString().split('T')[0],
                    Completada: completed ? "TRUE" : "FALSE",
                    Notas_Alumno: notes || ''
                };
                
                console.log('ðŸ“¤ ParÃ¡metros enviados:', params);
                
                const response = await callJSONP('saveProgress', params);
                
                console.log('ðŸ“¥ Respuesta recibida:', response);
                
                if (!response.success) {
                    throw new Error(response.error || 'Error al guardar el progreso');
                }
                
                return response;
                
            } catch (error) {
                console.error('ðŸ’¥ Error guardando progreso:', error);
                throw error;
            }
        }

        // === SISTEMA DE PROGRESO MEJORADO Y CORREGIDO ===
        async function markAsViewed(lessonId, moduleId, moduleName, lessonName, checkbox) {
            const completed = checkbox.checked;
            const notes = userProgress[lessonId] ? userProgress[lessonId].notes : '';
            
            console.log('ðŸ“Œ Marcando clase como vista:', {
                lessonId,
                moduleId,
                completed,
                hasNotes: !!notes
            });
            
            const contentItem = document.querySelector(`.lesson-accordion[data-lesson="${lessonId}"]`);
            if (completed) {
                contentItem.classList.add('completed');
            } else {
                contentItem.classList.remove('completed');
            }
            
            // Actualizar el botÃ³n Vista
            const vistaBtn = document.getElementById('vista-btn-' + lessonId);
            if (vistaBtn) {
                if (completed) {
                    vistaBtn.classList.add('completed');
                    vistaBtn.textContent = 'Vista âœ“';
                } else {
                    vistaBtn.classList.remove('completed');
                    vistaBtn.textContent = 'Vista';
                }
            }
            
            try {
                // Guardar progreso en la base de datos
                const saveResult = await saveProgressToDatabase(lessonId, completed, notes);
                
                console.log('âœ… Progreso guardado exitosamente:', saveResult);
                
                // Actualizar progreso local
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                
                userProgress[lessonId].completed = completed;
                userProgress[lessonId].notes = notes;
                userProgress[lessonId].lastUpdate = new Date();
                
                // Actualizar cache local
                updateLocalCache();
                
                // Mostrar notificaciÃ³n
                showNotification(completed ? 'âœ… LecciÃ³n completada' : 'ðŸ“ Progreso actualizado');
                
                // Actualizar progreso del mÃ³dulo
                updateModuleProgress(moduleId);
                
            } catch (error) {
                console.error('âŒ Error al guardar:', error);
                showNotification('âŒ Error al guardar: ' + error.message, 'error');
                
                // Revertir el estado
                checkbox.checked = !completed;
                
                if (completed) {
                    contentItem.classList.remove('completed');
                    if (vistaBtn) {
                        vistaBtn.classList.remove('completed');
                        vistaBtn.textContent = 'Vista';
                    }
                } else {
                    contentItem.classList.add('completed');
                    if (vistaBtn) {
                        vistaBtn.classList.add('completed');
                        vistaBtn.textContent = 'Vista âœ“';
                    }
                }
            }
        }

        // FunciÃ³n para actualizar el progreso del mÃ³dulo
        function updateModuleProgress(moduleId) {
            const selectedModule = userModules.find(m => m.ID_MÃ³dulo === moduleId);
            if (!selectedModule) return;
            
            let completedCount = 0;
            selectedModule.Clases.forEach(content => {
                if (userProgress[content.ID_Clase] && userProgress[content.ID_Clase].completed) {
                    completedCount++;
                }
            });
            
            const totalCount = selectedModule.Clases.length;
            const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            // Actualizar la barra de progreso en la vista expandida
            const progressBar = document.querySelector('.module-progress-expanded .progress-bar');
            const progressText = document.querySelector('.module-progress-expanded .progress-text');
            
            if (progressBar) {
                progressBar.style.width = progressPercentage + '%';
            }
            
            if (progressText) {
                progressText.textContent = completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)";
            }
            
            // Actualizar la tarjeta del mÃ³dulo
            const moduleCard = document.querySelector(`[onclick="expandModule('${moduleId}')"]`);
            if (moduleCard) {
                const cardProgressBar = moduleCard.querySelector('.progress-bar');
                const cardProgressText = moduleCard.querySelector('.progress-text');
                
                if (cardProgressBar) {
                    cardProgressBar.style.width = progressPercentage + '%';
                }
                
                if (cardProgressText) {
                    cardProgressText.textContent = progressPercentage + '% completado';
                }
            }
        }

        // === FUNCIÃ“N GUARDAR NOTAS MEJORADA ===
        async function saveNotes(lessonId, moduleName, lessonName) {
            const notesText = document.getElementById('notes-text-' + lessonId).value;
            const saveButton = document.getElementById('save-notes-btn-' + lessonId);
            
            console.log('ðŸ’¾ Guardando notas para clase:', lessonId, 'Longitud:', notesText.length);
            
            saveButton.textContent = 'Guardando...';
            saveButton.disabled = true;
            
            try {
                // Obtener estado de completado actual
                const isCompleted = userProgress[lessonId] ? userProgress[lessonId].completed : false;
                
                console.log('Estado actual de la clase:', {
                    lessonId,
                    isCompleted,
                    notesLength: notesText.length
                });
                
                // Guardar notas en la base de datos
                const saveResult = await saveProgressToDatabase(lessonId, isCompleted, notesText);
                
                console.log('âœ… Notas guardadas exitosamente:', saveResult);
                
                // Actualizar progreso local
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                userProgress[lessonId].notes = notesText;
                userProgress[lessonId].lastUpdate = new Date();
                
                // Actualizar cache local
                updateLocalCache();
                
                showNotification('âœ… Notas guardadas correctamente');
                saveButton.textContent = 'Guardado âœ“';
                
                // Actualizar el botÃ³n de notas
                const notesButton = document.getElementById('notes-btn-' + lessonId);
                if (notesButton) {
                    notesButton.textContent = 'ðŸ“ Ver notas (' + (notesText.length > 0 ? "1" : "0") + ')';
                }
                
                setTimeout(() => {
                    saveButton.textContent = 'Guardar notas';
                    saveButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Error guardando notas:', error);
                showNotification('âŒ Error: ' + error.message, 'error');
                saveButton.textContent = 'Guardar notas';
                saveButton.disabled = false;
            }
        }

        // === SISTEMA DE VIDEO MEJORADO Y CORREGIDO ===
        function showVideoPlayer(lessonId, videoUrl) {
            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                showNotification("URL de video invÃ¡lida", "error");
                return;
            }

            pauseAllVideos();
            
            var playerContainer = document.getElementById('player-container-' + lessonId);
            
            document.querySelectorAll('.player-container').forEach(container => {
                if (container.id !== 'player-container-' + lessonId) {
                    container.style.display = 'none';
                    // Restaurar el texto del botÃ³n de otros videos
                    const otherLessonId = container.id.replace('player-container-', '');
                    const otherVideoBtn = document.getElementById('video-btn-' + otherLessonId);
                    if (otherVideoBtn) {
                        otherVideoBtn.textContent = 'ðŸŽ¬ Ver Video';
                    }
                }
            });
            
            playerContainer.style.display = 'block';
            
            // Desplazar la pÃ¡gina para mostrar el reproductor
            playerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (!currentPlayers[lessonId] || currentPlayers[lessonId].getVideoData === undefined) {
                createPlayer(lessonId, videoId);
            } else {
                currentPlayers[lessonId].cueVideoById(videoId);
                setTimeout(function() {
                    adjustPlayerSize(lessonId);
                }, 100);
            }
        }

        function hideVideoPlayer(lessonId) {
            var playerContainer = document.getElementById('player-container-' + lessonId);
            playerContainer.style.display = 'none';
            
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].pauseVideo();
            }
            
            // Restaurar el texto del botÃ³n
            const videoBtn = document.getElementById('video-btn-' + lessonId);
            if (videoBtn) {
                videoBtn.textContent = 'ðŸŽ¬ Ver Video';
            }
        }

        function pauseAllVideos() {
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId] && typeof currentPlayers[lessonId].pauseVideo === 'function') {
                    currentPlayers[lessonId].pauseVideo();
                }
            }
        }

        function extractVideoId(url) {
            var regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            var match = url.match(regex);
            return match ? match[1] : null;
        }

        function adjustPlayerSize(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            var container = document.getElementById('videoContainer-' + lessonId);
            if (!container) return;
            
            var containerWidth = container.clientWidth;
            var containerHeight = containerWidth * 9 / 16;
            
            player.setSize(containerWidth, containerHeight);
        }

        function createPlayer(lessonId, videoId) {
            var playerId = 'player-' + lessonId;
            
            currentPlayers[lessonId] = new YT.Player(playerId, {
                videoId: videoId,
                playerVars: { 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    iv_load_policy: 3,
                    playsinline: 1
                },
                events: {
                    onReady: function() { onPlayerReady(lessonId); },
                    onStateChange: function(event) { onPlayerStateChange(lessonId, event); }
                }
            });
        }

        function onPlayerReady(lessonId) {
            var player = currentPlayers[lessonId];
            
            adjustPlayerSize(lessonId);
            
            setupCustomControls(lessonId);
            
            setInterval(function() {
                updateProgress(lessonId);
            }, 500);
        }

        function onPlayerStateChange(lessonId, event) {
            var btn = document.getElementById("playPauseBtn-" + lessonId);
            if (btn) {
                btn.textContent = event.data === YT.PlayerState.PLAYING ? "â¸ Pause" : "â–¶ Play";
            }
        }

        // === FUNCIÃ“N PARA ACTUALIZAR TIEMPO EN BARRA DE PROGRESO ===
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return "0:00";
            
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ":" + (secs < 10 ? "0" : "") + secs;
        }

        function updateProgress(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player || !player.getCurrentTime || dragging) return;

            var currentTime = player.getCurrentTime();
            var duration = player.getDuration();
            var percent = (currentTime / duration) * 100;
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            var timeDisplay = document.getElementById("timeDisplay-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = percent + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent / 100 * progressBarElement.offsetWidth) + "px";
            }
            
            // ACTUALIZAR DISPLAY DE TIEMPO
            if (timeDisplay && duration) {
                timeDisplay.textContent = formatTime(currentTime) + " / " + formatTime(duration);
            }
        }

        // === NUEVAS FUNCIONES PARA CONTROL DE CONTROLES EN PANTALLA COMPLETA ===
        function showControls(lessonId) {
            const controlsPanel = document.querySelector(`#player-container-${lessonId} .controls-panel`);
            if (controlsPanel) {
                controlsPanel.classList.add('show-controls');
            }
            
            // Cancelar temporizador anterior
            if (hideControlsTimers[lessonId]) {
                clearTimeout(hideControlsTimers[lessonId]);
            }
            
            // Establecer nuevo temporizador para ocultar controles despuÃ©s de 3 segundos
            hideControlsTimers[lessonId] = setTimeout(() => {
                hideControls(lessonId);
            }, 3000);
        }
        
        function hideControls(lessonId) {
            const controlsPanel = document.querySelector(`#player-container-${lessonId} .controls-panel`);
            if (controlsPanel) {
                controlsPanel.classList.remove('show-controls');
            }
        }
        
        function toggleControls(lessonId) {
            const controlsPanel = document.querySelector(`#player-container-${lessonId} .controls-panel`);
            if (controlsPanel && controlsPanel.classList.contains('show-controls')) {
                hideControls(lessonId);
            } else {
                showControls(lessonId);
            }
        }

        // === FUNCIÃ“N SETUP CUSTOM CONTROLS MEJORADA Y CORREGIDA ===
        function setupCustomControls(lessonId) {
            var overlay = document.getElementById("overlay-" + lessonId);
            var playPauseBtn = document.getElementById("playPauseBtn-" + lessonId);
            var restartBtn = document.getElementById("restartBtn-" + lessonId);
            var fullscreenBtn = document.getElementById("fullscreenBtn-" + lessonId);
            var exitFullscreenBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            var progressBar = document.getElementById("progressBar-" + lessonId);
            var thumb = document.getElementById("thumb-" + lessonId);

            // Configurar overlay para mostrar controles al tocar
            if (overlay) {
                overlay.onclick = function(e) { 
                    if (!e.target.closest('.video-controls') && !e.target.closest('.exit-fullscreen')) {
                        if (isFullscreen) {
                            toggleControls(lessonId);
                        }
                        togglePlayPause(lessonId); 
                    }
                };
            }
            
            if (playPauseBtn) playPauseBtn.onclick = function() { togglePlayPause(lessonId); };
            if (restartBtn) restartBtn.onclick = function() { restartVideo(lessonId); };
            if (fullscreenBtn) fullscreenBtn.onclick = function() { goFullScreen(lessonId); };
            if (exitFullscreenBtn) exitFullscreenBtn.onclick = function() { exitFullScreen(lessonId); };

            // Sistema de arrastre para la barra de progreso
            if (thumb) {
                thumb.addEventListener("mousedown", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId); 
                });
                thumb.addEventListener("touchstart", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId); 
                }, {passive: false});
            }

            if (progressBar) {
                progressBar.addEventListener("click", function(e) {
                    if (!dragging) {
                        var rect = progressBar.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        if (x < 0) x = 0;
                        if (x > rect.width) x = rect.width;
                        seekToPosition(lessonId, x / rect.width);
                    }
                });
            }

            // Eventos globales de arrastre
            document.addEventListener("mousemove", function(e) { 
                dragMove(e, lessonId);
            });
            document.addEventListener("mouseup", function(e) { 
                endDrag(e);
            });
            document.addEventListener("touchmove", function(e) { 
                dragMove(e, lessonId);
            }, {passive: false});
            document.addEventListener("touchend", function(e) { 
                endDrag(e);
            });
            document.addEventListener("touchcancel", function(e) { 
                endDrag(e);
            });

            // Eventos de pantalla completa
            document.addEventListener('fullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            document.addEventListener('webkitfullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            document.addEventListener('msfullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            
            // Redimensionamiento
            window.addEventListener('resize', function() {
                if (currentPlayers[lessonId]) {
                    adjustPlayerSize(lessonId);
                }
            });
            
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    fullscreenChange(lessonId);
                    adjustPlayerSize(lessonId);
                }, 300);
            });
        }

        function togglePlayPause(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function restartVideo(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            player.seekTo(0, true);
            player.playVideo();
        }

        function startDrag(e, lessonId) {
            e.preventDefault();
            dragging = true;
            window.currentDragLessonId = lessonId;
        }

        function dragMove(e, lessonId) {
            if (dragging && window.currentDragLessonId === lessonId) {
                e.preventDefault();
                var progressBar = document.getElementById("progressBar-" + lessonId);
                if (!progressBar) return;

                var rect = progressBar.getBoundingClientRect();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var x = clientX - rect.left;
                
                if (x < 0) x = 0;
                if (x > rect.width) x = rect.width;
                
                seekToPosition(lessonId, x / rect.width);
            }
        }

        function endDrag(e) {
            dragging = false;
            window.currentDragLessonId = null;
        }

        function seekToPosition(lessonId, percent) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var duration = player.getDuration();
            var newTime = duration * percent;
            player.seekTo(newTime, true);
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = (percent * 100) + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent * progressBarElement.offsetWidth) + "px";
            }
        }

        function goFullScreen(lessonId) {
            var container = document.getElementById("player-container-" + lessonId);
            if (!container) return;

            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
        }

        function exitFullScreen(lessonId) {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        function fullscreenChange(lessonId) {
            var exitBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            
            isFullscreen = document.fullscreenElement || 
                          document.webkitFullscreenElement || 
                          document.msFullscreenElement;
            
            if (exitBtn) {
                exitBtn.style.display = isFullscreen ? "flex" : "none";
            }
            
            // En pantalla completa, ocultar controles inicialmente
            if (isFullscreen) {
                hideControls(lessonId);
            } else {
                // Al salir de pantalla completa, mostrar controles
                showControls(lessonId);
            }
        }

        // === SISTEMA UNIFICADO DE MANUALES Y CALENDARIO ===
        function showCourseManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del Curso');
            }
        }

        function showModuleManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del MÃ³dulo');
            }
        }

        function openManualViewer(manualUrl, title) {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            const modalTitle = document.getElementById('manualModalTitle');
            
            if (modal && frame) {
                modalTitle.textContent = title;
                const viewerUrl = convertToGoogleDriveViewer(manualUrl);
                frame.src = viewerUrl;
                modal.style.display = 'flex';
            }
        }

        function closeManualViewer() {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            if (modal && frame) {
                modal.style.display = 'none';
                frame.src = '';
            }
        }

        // === NUEVAS FUNCIONES PARA ENCUESTAS ===
        function openSurvey(surveyUrl) {
            const modal = document.getElementById('universalSurveyModal');
            const frame = document.getElementById('surveyModalFrame');
            
            if (modal && frame) {
                frame.src = surveyUrl;
                modal.style.display = 'flex';
            }
        }

        function closeSurveyViewer() {
            const modal = document.getElementById('universalSurveyModal');
            const frame = document.getElementById('surveyModalFrame');
            if (modal && frame) {
                modal.style.display = 'none';
                frame.src = '';
            }
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualViewer();
                closeSurveyViewer();
                closeRegisterModal();
                closeForgotPasswordModal();
            }
        });

        function convertToGoogleDriveViewer(url) {
            var fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }
            return url;
        }

        function extractGoogleDriveFileId(url) {
            var match = url.match(/[-\w]{25,}/);
            return match ? match[0] : null;
        }

        function downloadManual(lessonId, manualUrl) {
            var fileId = extractGoogleDriveFileId(manualUrl);
            if (fileId) {
                var downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
                window.open(downloadUrl, '_blank');
            } else {
                window.open(manualUrl, '_blank');
            }
        }

        function printManual(lessonId) {
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            if (pdfFrame && pdfFrame.contentWindow) {
                try {
                    pdfFrame.contentWindow.print();
                } catch (e) {
                    var manualUrl = pdfFrame.src;
                    window.open(manualUrl, '_blank');
                    showNotification('Se abriÃ³ el manual en una nueva ventana para imprimir', 'info');
                }
            }
        }

        // === SISTEMA DE NOTAS ===
        function toggleNotes(lessonId) {
            var notesArea = document.getElementById('notes-area-' + lessonId);
            
            if (notesArea.style.display === 'none' || !notesArea.style.display) {
                notesArea.style.display = 'block';
                
                var notesTextarea = document.getElementById('notes-text-' + lessonId);
                if (notesTextarea.value === '' && userProgress[lessonId] && userProgress[lessonId].notes) {
                    notesTextarea.value = userProgress[lessonId].notes;
                }
            } else {
                notesArea.style.display = 'none';
            }
        }

        // === FUNCIÃ“N CLASE SIGUIENTE ===
        function nextClass(lessonId, moduleId) {
            var currentModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_MÃ³dulo === moduleId) {
                    currentModule = userModules[i];
                    break;
                }
            }
            
            if (!currentModule || !currentModule.Clases) return;
            
            var currentIndex = -1;
            for (var j = 0; j < currentModule.Clases.length; j++) {
                if (currentModule.Clases[j].ID_Clase === lessonId) {
                    currentIndex = j;
                    break;
                }
            }
            
            if (currentIndex === -1 || currentIndex >= currentModule.Clases.length - 1) {
                showNotification("No hay mÃ¡s clases en este mÃ³dulo", "info");
                return;
            }
            
            var nextLesson = currentModule.Clases[currentIndex + 1];
            
            hideVideoPlayer(lessonId);
            hideManual(lessonId);
            
            var currentCheckbox = document.getElementById('check_' + lessonId);
            if (currentCheckbox && !currentCheckbox.checked) {
                currentCheckbox.checked = true;
                markAsViewed(lessonId, moduleId, currentModule['Nombre del MÃ³dulo'], currentModule.Clases[currentIndex]['Nombre de la Clase'], currentCheckbox);
            }
            
            if (nextLesson['URL Video'] && nextLesson['URL Video'].trim() !== '') {
                setTimeout(function() {
                    showVideoPlayer(nextLesson.ID_Clase, nextLesson['URL Video']);
                }, 300);
            }
            
            var nextLessonElement = document.querySelector(`.lesson-accordion[data-lesson="${nextLesson.ID_Clase}"]`);
            if (nextLessonElement) {
                nextLessonElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            showNotification("Avanzando a la siguiente clase: " + nextLesson['Nombre de la Clase'], "success");
        }

        // === FUNCIONES UTILITARIAS ===
        function updateLocalCache() {
            // Invalidar cache local cuando hay cambios
            if (alumnoActual) {
                sessionStorage.removeItem(`cursos_${alumnoActual.ID_Alumno}`);
                if (currentCourseId && currentGrupoId) {
                    sessionStorage.removeItem(`modulos_${alumnoActual.ID_Alumno}_${currentCourseId}_${currentGrupoId}`);
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function formatFecha(fechaString) {
            if (!fechaString) return 'No especificada';
            try {
                const fecha = new Date(fechaString);
                return fecha.toLocaleDateString('es-ES');
            } catch (e) {
                return fechaString;
            }
        }

        function clearErrors() {
            document.getElementById("errorMessage").innerHTML = "";
        }
        
        function clearForms() {
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
        }

        function logout() {
            // Limpiar todo
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            
            currentPlayers = {};
            currentUser = null;
            userProgress = {};
            userModules = [];
            alumnoActual = null;
            currentCourseData = null;
            currentOpenAccordion = null;
            
            sessionStorage.clear();
            
            document.getElementById('courseHeader').style.display = 'none';
            document.getElementById("page4_id1").style.display = "none";
            document.getElementById("page1_id1").style.display = "flex";
            clearErrors();
            clearForms();
        }

        // Funciones auxiliares para manuales
        function showManual(lessonId, manualUrl) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            
            if (manualContainer.style.display === 'none' || !manualContainer.style.display) {
                manualContainer.style.display = 'block';
                
                var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
                var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
                
                if (welcomeMessage) welcomeMessage.style.display = 'none';
                if (pdfFrame) {
                    pdfFrame.style.display = 'block';
                    var viewerUrl = convertToGoogleDriveViewer(manualUrl);
                    pdfFrame.src = viewerUrl;
                }
            } else {
                hideManual(lessonId);
            }
        }

        function hideManual(lessonId) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            
            manualContainer.style.display = 'none';
            
            var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            
            if (welcomeMessage) welcomeMessage.style.display = 'block';
            if (pdfFrame) {
                pdfFrame.style.display = 'none';
                pdfFrame.src = '';
            }
        }

        // === FUNCIÃ“N DE DEPURACIÃ“N ===
        async function testConnection() {
            try {
                console.log('ðŸ§ª Probando conexiÃ³n...');
                const response = await callJSONP('escuela', {});
                console.log('âœ… ConexiÃ³n exitosa:', response);
                return response;
            } catch (error) {
                console.error('âŒ Error de conexiÃ³n:', error);
                return {success: false, error: error.message};
            }
        }

        // === ðŸ§ª FUNCIONES DE DEPURACIÃ“N ===
        window.debugProgress = function() {
            console.log('=== DEBUG: ESTADO DEL PROGRESO ===');
            console.log('Usuario actual:', alumnoActual);
            console.log('Progreso cargado:', userProgress);
            console.log('Total de clases con progreso:', Object.keys(userProgress).length);
            console.log('Curso actual:', currentCourseId);
            console.log('Grupo actual:', currentGrupoId);
            console.log('MÃ³dulos cargados:', userModules.length);
            console.log('===================================');
            
            return {
                usuario: alumnoActual,
                progreso: userProgress,
                totalClasesConProgreso: Object.keys(userProgress).length,
                cursoActual: currentCourseId,
                grupoActual: currentGrupoId,
                totalModulos: userModules.length
            };
        };

        window.testSaveProgress = async function(lessonId) {
            console.log('ðŸ§ª Probando guardado de progreso para clase:', lessonId);
            
            try {
                const result = await saveProgressToDatabase(lessonId, true, 'Nota de prueba desde el frontend');
                console.log('âœ… Resultado:', result);
                return result;
            } catch (error) {
                console.error('âŒ Error:', error);
                return { success: false, error: error.message };
            }
        };

        console.log('ðŸ”§ Funciones de debug disponibles:');
        console.log('  - window.debugProgress() : Ver estado actual');
        console.log('  - window.testSaveProgress("ID_CLASE") : Probar guardado');

        // Hacer la funciÃ³n accesible desde la consola
        window.testConnection = testConnection;
    </script>
</body>
</html>
