<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - Dashboard</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* === SISTEMA DE DISE√ëO UNIFICADO === */
        :root {
            --naranja: #fbbf24;
            --naranja-claro: #fdba74;
            --azul: #3b82f6;
            --azul-claro: #0ea5e9;
            --azul-oscuro: #1e3a8a;
            --azul-profundo: #1e293b;
            --neutro: #f1f5f9;
            --blanco: #ffffff;
            --success: #10B981;
            --error: #EF4444;
            --gray: #64748B;
            --sombra: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sombra-intensa: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radio: 15px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(160deg, var(--azul) 0%, var(--naranja) 100%);
            min-height: 100vh;
            color: var(--azul-profundo);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px 5px;
            min-height: calc(100vh - 10px);
        }

        /* === COMPONENTES REUTILIZABLES === */
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radio);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-intensa);
        }

        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
        }

        .btn-success {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        /* === LAYOUT PRINCIPAL === */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .school-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .school-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: var(--neutro);
            padding: 4px;
        }

        .school-name {
            color: var(--azul-oscuro);
            font-size: 18px;
            font-weight: 700;
        }

        .user-welcome {
            text-align: right;
            flex: 1;
            min-width: 180px;
        }

        .user-welcome h2 {
            color: var(--azul-oscuro);
            margin-bottom: 5px;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* === SISTEMA DE NAVEGACI√ìN === */
        .dashboard {
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            margin-bottom: 5px;
        }

        .back-btn {
            margin-bottom: 15px;
        }

        /* === SISTEMA DE GRILLAS RESPONSIVO === */
        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-cursos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .grid-modulos {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* === TARJETAS DE CONTENIDO MEJORADAS === */
        .curso-card, .module-card {
            cursor: pointer;
            border-left: 5px solid var(--azul);
            border-right: 5px solid var(--naranja);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .curso-imagen, .module-imagen {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 50px;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .curso-imagen img, .module-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: 10px;
        }

        .curso-card:hover .curso-imagen img,
        .module-card:hover .module-imagen img {
            transform: scale(1.05);
        }

        .curso-titulo, .module-titulo {
            font-size: 16px;
            font-weight: 700;
            color: var(--azul-oscuro);
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid var(--azul);
            padding-bottom: 8px;
            word-wrap: break-word;
        }

        .curso-content {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .curso-grupo {
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }

        .btn-acceder {
            width: 100%;
            margin-top: auto;
        }

        /* === SISTEMA DE PROGRESO UNIFICADO === */
        .progress-container {
            margin: 12px 0;
            padding: 8px;
            background: var(--neutro);
            border-radius: 6px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
            margin-bottom: 4px;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 8px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--gray);
            font-weight: 600;
        }

        .progress-label {
            font-size: 11px;
            color: var(--gray);
            margin-bottom: 4px;
            text-align: center;
            font-weight: 600;
        }

        /* === SISTEMA DE LECCIONES MEJORADO === */
        .content-item {
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--azul);
            cursor: default;
        }

        .content-item.completed {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--azul);
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .lesson-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--azul);
        }

        .lesson-title {
            color: var(--azul-profundo);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            word-wrap: break-word;
        }

        .content-item.completed .lesson-title {
            text-decoration: line-through;
            color: var(--gray);
        }

        .lesson-preview {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            margin-left: 26px;
            align-items: flex-start;
        }

        .lesson-thumbnail {
            flex-shrink: 0;
            width: 140px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .lesson-thumbnail:hover {
            transform: scale(1.05);
        }

        .lesson-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lesson-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-description {
            flex: 1;
            color: var(--azul-profundo);
            font-size: 13px;
            line-height: 1.4;
            max-height: 80px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .content-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: 26px;
            align-items: flex-start;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 11px;
            color: white !important;
        }

        /* === NUEVO REPRODUCTOR DE VIDEO PERSONALIZADO - CORREGIDO === */
        .player-container {
            width: 100%;
            max-width: 800px;
            background: #000;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            margin: 12px 0;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 450px;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        .corner-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 40px;
            background: rgba(0,0,0,0.95);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 20;
            pointer-events: none;
            cursor: default;
            color: #fff;
            backdrop-filter: blur(5px);
            padding: 5px;
        }

        .corner-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .exit-fullscreen {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 30;
            cursor: pointer;
            display: none;
            color: #000;
            font-weight: bold;
        }

        .controls-panel {
            background: #000;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            margin-top: 0;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .progress-container-player {
            flex: 1;
            height: 20px;
            background: #444;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            z-index: 15;
        }

        .progress-player {
            height: 100%;
            background: #ff0000;
            border-radius: 10px;
            width: 0%;
            transform-origin: left center;
            position: absolute;
            left: 0;
            top: 0;
        }

        .thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            left: 0px;
        }

        .time-display {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            font-family: monospace;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 30;
            position: relative;
        }

        .video-controls button {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            flex: 1;
            max-width: 200px;
        }

        .video-controls button:hover {
            background: #cc0000;
        }

        /* Pantalla completa CORREGIDA - Video centrado y completo */
        .player-container:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        .player-container:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        .player-container:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            background: #000 !important;
        }
        
        :-webkit-full-screen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :-moz-full-screen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :fullscreen .video-container {
            flex: 1;
            border-radius: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        :-webkit-full-screen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        :-moz-full-screen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        :fullscreen .video-container div[id^="player-"] {
            width: 100% !important;
            aspect-ratio: 16 / 9;
            height: auto !important;
            max-height: 100%;
            object-fit: contain;
        }
        
        :-webkit-full-screen .controls-panel {
            border-radius: 0 !important;
            padding: 15px 20px !important;
            flex-shrink: 0;
        }
        
        :-moz-full-screen .controls-panel {
            border-radius: 0 !important;
            padding: 15px 20px !important;
            flex-shrink: 0;
        }
        
        :fullscreen .controls-panel {
            border-radius: 0 !important;
            padding: 15px 20px !important;
            flex-shrink: 0;
        }
        
        :-webkit-full-screen .exit-fullscreen {
            display: flex !important;
        }
        
        :-moz-full-screen .exit-fullscreen {
            display: flex !important;
        }
        
        :fullscreen .exit-fullscreen {
            display: flex !important;
        }
        
        :-webkit-full-screen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
        }
        
        :-moz-full-screen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
        }
        
        :fullscreen .corner-box {
            bottom: 10px !important;
            right: 10px !important;
        }
        
        /* === MEJORAS EN BOTONES DE CABECERAS === */
        .course-buttons, .module-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .course-buttons .btn, .module-buttons .btn {
            margin: 0;
        }

/* === CORRECCI√ìN DEFINITIVA PARA LANDSCAPE - PROPORCI√ìN MANTENIDA === */
@media (max-width: 926px) and (orientation: landscape) {
    
    /* üîß CONTENEDOR PRINCIPAL: ocupa 70% de altura pero contenido centrado */
    :-webkit-full-screen .video-container,
    :-moz-full-screen .video-container,
    :fullscreen .video-container {
        width: 100% !important;
        height: 70vh !important;       /* 70% de altura */
        max-height: 70vh !important;
        background: #000 !important;   /* Fondo negro para bordes */
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        margin: 0 auto !important;
        position: relative !important;
        overflow: hidden !important;
    }

    /* üîß CONTROLES: 30% restante */
    :-webkit-full-screen .controls-panel,
    :-moz-full-screen .controls-panel,
    :fullscreen .controls-panel {
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start;
        padding: 15px 20px !important;
        background: #000 !important;
        border-radius: 0 !important;
        flex-shrink: 0;
        height: 30vh !important;       /* 30% fijo de altura */
        min-height: 100px !important;
        box-sizing: border-box !important;
    }

    /* Ajuste de botones */
    :-webkit-full-screen .video-controls button,
    :-moz-full-screen .video-controls button,
    :fullscreen .video-controls button {
        font-size: 14px !important;
        padding: 10px 15px !important;
        flex: 1;
        min-width: 90px;
        margin: 5px !important;
    }

  /* üîß ELEMENTO DEL REPRODUCTOR: video reducido y centrado */
:-webkit-full-screen .video-container div[id^="player-"],
:-moz-full-screen .video-container div[id^="player-"],
:fullscreen .video-container div[id^="player-"] {
    aspect-ratio: 16 / 9 !important;
    width: 93.3% !important;         /* Reducido un 25% respecto al ancho anterior */
    height: auto !important;
    max-height: 52.5% !important;    /* Reducido un 25% respecto al alto anterior */
    object-fit: contain !important;
    margin: 0 auto !important;
    display: block !important;
    position: relative !important;
}

            
            /* Ajustes para controles en landscape */
            :-webkit-full-screen .progress-row {
                margin-bottom: 8px !important;
            }
            
            :-moz-full-screen .progress-row {
                margin-bottom: 8px !important;
            }
            
            :fullscreen .progress-row {
                margin-bottom: 8px !important;
            }
            
            :-webkit-full-screen .video-controls button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            
            :-moz-full-screen .video-controls button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            
            :fullscreen .video-controls button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            
            :-webkit-full-screen .progress-container-player {
                height: 15px !important;
            }
            
            :-moz-full-screen .progress-container-player {
                height: 15px !important;
            }
            
            :fullscreen .progress-container-player {
                height: 15px !important;
            }
            
            :-webkit-full-screen .time-display {
                font-size: 11px !important;
                min-width: 85px !important;
            }
            
            :-moz-full-screen .time-display {
                font-size: 11px !important;
                min-width: 85px !important;
            }
            
            :fullscreen .time-display {
                font-size: 11px !important;
                min-width: 85px !important;
            }
        }
        
        /* Ajuste adicional para pantallas landscape muy peque√±as */
        @media (max-width: 926px) and (orientation: landscape) and (max-height: 450px) {
            /* M√ÅXIMO 40vh PARA PANTALLAS MUY PEQUE√ëAS */
            :-webkit-full-screen .video-container {
                max-height: 40vh !important;
            }
            
            :-moz-full-screen .video-container {
                max-height: 40vh !important;
            }
            
            :fullscreen .video-container {
                max-height: 40vh !important;
            }
            
            :-webkit-full-screen .video-container div[id^="player-"] {
                max-height: 40vh !important;
            }
            
            :-moz-full-screen .video-container div[id^="player-"] {
                max-height: 40vh !important;
            }
            
            :fullscreen .video-container div[id^="player-"] {
                max-height: 40vh !important;
            }
            
            :-webkit-full-screen .controls-panel {
                padding: 5px 10px !important;
            }
            
            :-moz-full-screen .controls-panel {
                padding: 5px 10px !important;
            }
            
            :fullscreen .controls-panel {
                padding: 5px 10px !important;
            }
            
            :-webkit-full-screen .video-controls button {
                padding: 5px 8px !important;
                font-size: 10px !important;
            }
            
            :-moz-full-screen .video-controls button {
                padding: 5px 8px !important;
                font-size: 10px !important;
            }
            
            :fullscreen .video-controls button {
                padding: 5px 8px !important;
                font-size: 10px !important;
            }
        }
        
        /* Nueva media query para pantallas landscape de altura media */
        @media (max-width: 926px) and (orientation: landscape) and (min-height: 451px) and (max-height: 600px) {
            /* 45vh PARA PANTALLAS CON ALTURA MEDIA */
            :-webkit-full-screen .video-container {
                max-height: 45vh !important;
            }
            
            :-moz-full-screen .video-container {
                max-height: 45vh !important;
            }
            
            :fullscreen .video-container {
                max-height: 45vh !important;
            }
            
            :-webkit-full-screen .video-container div[id^="player-"] {
                max-height: 45vh !important;
            }
            
            :-moz-full-screen .video-container div[id^="player-"] {
                max-height: 45vh !important;
            }
            
            :fullscreen .video-container div[id^="player-"] {
                max-height: 45vh !important;
            }
        }

        /* Responsive para el reproductor normal */
        @media (max-width: 768px) {
            .video-container div[id^="player-"] {
                max-height: 300px;
            }
            
            .video-controls button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .time-display {
                font-size: 12px;
                min-width: 90px;
            }

            .corner-box {
                width: 80px;
                height: 35px;
                font-size: 20px;
                bottom: 8px;
                right: 8px;
            }
            
            /* Ajustes para botones en m√≥vil */
            .course-buttons, .module-buttons {
                gap: 8px;
            }
            
            .course-buttons .btn, .module-buttons .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .video-container div[id^="player-"] {
                max-height: 250px;
            }
            
            .player-container {
                padding: 10px;
            }
            
            .video-controls {
                gap: 8px;
            }
            
            .video-controls button {
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .time-display {
                font-size: 11px;
                min-width: 80px;
            }
            
            .controls-panel {
                padding: 10px;
            }
            
            .progress-row {
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .corner-box {
                width: 70px;
                height: 30px;
                font-size: 18px;
                bottom: 6px;
                right: 6px;
            }
            
            /* Ajustes para botones en m√≥vil peque√±o */
            .course-buttons, .module-buttons {
                gap: 6px;
            }
            
            .course-buttons .btn, .module-buttons .btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }

        /* === SISTEMA DE LOGIN OPTIMIZADO === */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .form-container {
            width: 320px;
            padding: 25px;
            text-align: center;
        }

        .school-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .login-school-logo {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            margin: 0 auto 12px;
            display: block;
            border-radius: 8px;
            background: var(--neutro);
            padding: 8px;
        }

        .login-title {
            text-align: center;
            color: var(--azul-oscuro);
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 22px;
        }

        input[type=text], input[type=password] {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            outline: none;
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            background: white;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        input[type=text]:focus, input[type=password]:focus {
            border-bottom: 2px solid var(--naranja);
        }

        input[type=submit], input[type=button] {
            width: 100%;
            margin: 5px 0;
        }

        .error-message {
            color: var(--error);
            font-size: 11px;
            text-align: center;
            margin: 8px 0;
            min-height: 18px;
        }

        /* === CABECERAS DE CURSO Y M√ìDULO === */
        .course-header, .module-header-expanded {
            display: none;
        }

        .course-title-section, .module-title-section {
            text-align: center;
            margin-bottom: 15px;
        }

        .course-title-section h1 {
            color: var(--azul-oscuro);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .module-title-section h2 {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .course-content, .module-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .course-image-container, .module-image-container {
            flex: 0 0 150px;
        }

        .course-header-image, .module-header-image {
            width: 100%;
            max-height: 120px;
            object-fit: cover;
            border-radius: 10px;
        }

        .course-info, .module-info {
            flex: 1;
        }

        .course-description, .module-description {
            color: var(--azul-profundo);
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 14px;
        }

        /* === COMPONENTES DE INTERFAZ AVANZADOS === */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 13px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error);
        }

        /* === MODAL UNIFICADO PARA MANUALES === */
        #universalManualModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #universalManualModal .modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            max-width: 900px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        #universalManualModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--azul-oscuro);
            color: white;
        }

        #universalManualModal .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        #universalManualModal .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        #universalManualModal iframe {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
        }

        /* === SISTEMA RESPONSIVO MEJORADO === */
        @media (max-width: 768px) {
            .container {
                padding: 10px 10px 5px;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 12px 15px;
            }
            
            .school-brand, .user-welcome {
                justify-content: center;
                text-align: center;
                min-width: auto;
            }

            .user-welcome {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .course-content, .module-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .course-image-container, .module-image-container {
                flex: 0 0 auto;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
            
            .grid-cursos, .grid-modulos {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .lesson-preview {
                flex-direction: column;
                margin-left: 0;
            }
            
            .lesson-thumbnail {
                width: 100%;
                height: 150px;
            }
            
            .content-links {
                margin-left: 0;
                justify-content: center;
            }
            
            .player-container {
                padding: 10px;
                margin: 10px 0;
            }
        }
        
        @media (max-width: 480px) {
            .form-container {
                width: 100%;
                max-width: 300px;
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
                justify-content: center;
            }
        }

        /* === ESTILOS ADICIONALES PARA CONTENIDO EXPANDIDO === */
        .expanded-module {
            width: 100%;
            padding: 0;
            margin-bottom: 5px;
        }

        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
        }

        .module-progress-expanded {
            margin: 15px 0;
            padding: 12px;
            text-align: center;
        }

        .content-list-expanded {
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .notes-area {
            display: none;
            margin-top: 8px;
        }

        .notes-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
        }

        .save-notes-btn {
            margin-top: 8px;
        }

        .manual-container {
            display: none;
            margin-top: 8px;
        }

        .image-fallback {
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        .no-content {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- P√°gina 1: Login -->
    <div class="login-container" id="page1_id1">
        <div class="form-container card">
            <div class="school-header">
                <div id="defaultLogo" style="font-size: 40px; margin-bottom: 12px;">üéì</div>
                <h1 class="login-title" id="schoolTitle">Plataforma Educativa</h1>
            </div>
            <input type="text" id="username" placeholder="Usuario" />
            <input type="password" id="password" placeholder="Contrase√±a" />
            <div class="error-message" id="errorMessage"></div>
            <input type="submit" class="btn btn-primary" value="Ingresar" onclick="LoginUser()" />
        </div>
    </div>

    <!-- P√°gina 4: Dashboard del usuario -->
    <div class="dashboard page4_class1-off" id="page4_id1" style="display: none;">
        <div class="container">
            <!-- Cabecera Superior -->
            <div class="header-container card">
                <div class="school-brand">
                    <img id="schoolLogo" class="school-logo" src="" alt="Logo Escuela" onerror="this.style.display='none'">
                    <div class="school-name" id="headerSchoolName">Plataforma Educativa</div>
                </div>
                <div class="user-welcome">
                    <h2>¬°Hola <span id="displayusername" style="color:var(--azul);"></span>!</h2>
                    <div class="status-badge">Estado: <span id="userStatus">Activo</span></div>
                    <button class="btn btn-error" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Cabecera del Curso (se muestra al acceder a un curso) -->
            <div id="courseHeader" class="course-header card">
                <div class="course-title-section">
                    <h1 id="courseTitle">Nombre del Curso</h1>
                </div>
                <div class="course-content">
                    <div class="course-image-container">
                        <img id="courseHeaderImage" class="course-header-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
                    </div>
                    <div class="course-info">
                        <p id="courseDescription" class="course-description">Descripci√≥n del curso...</p>
                        <div id="courseButtons" class="course-buttons">
                            <!-- Los botones se agregar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <h2 style="color: var(--azul-oscuro); margin-bottom: 12px;" id="mainTitle">Mis Cursos</h2>
            <div id="cursosContainer" class="grid grid-cursos">
                <div class="loading">Cargando cursos...</div>
            </div>
            
            <div id="modulesContainer">
                <!-- Los m√≥dulos se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal Unificado para Manuales -->
    <div id="universalManualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manualModalTitle">Manual</h3>
                <button class="close-modal" onclick="closeManualViewer()">‚úï</button>
            </div>
            <iframe id="manualModalFrame"></iframe>
        </div>
    </div>

    <script>
        // === CONFIGURACI√ìN GITHUB ===
        const CONFIG = {
            API_BASE_URL: 'https://escuuelaapi1.jorge-altagracia.workers.dev/'
        };

        // === VARIABLES GLOBALES ===
        let currentUser = null;
        let userProgress = {};
        let userModules = [];
        let currentPlayers = {};
        let alumnoActual = null;
        let cursosCache = null;
        let currentCourseId = null;
        let currentGrupoId = null;
        let escuelaData = null;
        let currentCourseData = null;
        let dragging = false;

        // === SISTEMA DE JSONP MEJORADO ===
        function callJSONP(action, data = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Construir URL con par√°metros
                const params = new URLSearchParams();
                params.append('action', action);
                params.append('callback', callbackName);
                
                // Agregar datos espec√≠ficos
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        params.append(key, String(data[key]));
                    }
                });
                
                const url = CONFIG.API_BASE_URL + '?' + params.toString();
                
                console.log('üîç Llamando a:', url);
                
                const script = document.createElement('script');
                script.src = url;
                
                // Configurar callback global
                window[callbackName] = function(response) {
                    // Limpiar
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    console.log('üì® Respuesta recibida:', response);
                    
                    if (response && response.success !== undefined) {
                        resolve(response);
                    } else {
                        reject(new Error(response ? response.error : 'Error desconocido'));
                    }
                };
                
                // Manejar errores
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Error de red al conectar con el servidor'));
                };
                
                // Timeout despu√©s de 30 segundos
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Timeout de la solicitud despu√©s de 30 segundos'));
                    }
                }, 30000);
                
                // Limpiar timeout cuando se recibe respuesta
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeoutId);
                    originalCallback(response);
                };
                
                document.body.appendChild(script);
            });
        }

        // === INICIALIZACI√ìN ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSchoolData().catch(error => {
                console.log('No se pudieron cargar los datos de la escuela:', error.message);
            });
        });

        // === FUNCIONES PARA DATOS DE LA ESCUELA ===
        async function loadSchoolData() {
            try {
                const response = await callJSONP('escuela', {});
                if (response.data && response.data.length > 0) {
                    escuelaData = response.data[0];
                    updateSchoolUI();
                } else {
                    setDefaultSchoolData();
                }
            } catch (error) {
                console.error('Error cargando datos de la escuela:', error);
                setDefaultSchoolData();
            }
        }

        function updateSchoolUI() {
            if (!escuelaData) return;
            
            // Actualizar t√≠tulo en login
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle && escuelaData['Nombre_Escuela ']) {
                loginTitle.innerHTML = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar nombre en cabecera del dashboard
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName && escuelaData['Nombre_Escuela ']) {
                headerSchoolName.textContent = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar logo si existe
            if (escuelaData['Logo_Escuela']) {
                const logoImg = document.getElementById('schoolLogo');
                logoImg.src = escuelaData['Logo_Escuela'];
                logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                logoImg.style.display = 'block';
            }

            // Actualizar logo en login si existe
            if (escuelaData['Logo_Escuela']) {
                const loginHeader = document.querySelector('.school-header');
                if (loginHeader) {
                    const defaultLogo = document.getElementById('defaultLogo');
                    defaultLogo.style.display = 'none';
                    
                    const logoImg = document.createElement('img');
                    logoImg.src = escuelaData['Logo_Escuela'];
                    logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                    logoImg.className = 'login-school-logo';
                    logoImg.onerror = function() {
                        this.style.display = 'none';
                        defaultLogo.style.display = 'block';
                    };
                    
                    loginHeader.insertBefore(logoImg, defaultLogo);
                }
            }
        }

        function setDefaultSchoolData() {
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle) {
                loginTitle.innerHTML = 'Plataforma Educativa';
            }
            
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName) {
                headerSchoolName.textContent = 'Plataforma Educativa';
            }
        }

        // === FUNCIONES DE LOGIN ===
        async function LoginUser() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            
            if (!username || !password) {
                document.getElementById("errorMessage").innerHTML = "Complete todos los campos";
                return;
            }
            
            document.getElementById("errorMessage").innerHTML = "üîê Verificando credenciales...";
            
            try {
                const response = await callJSONP('login', { username, password });
                
                if(response.success) {
                    handleSuccessfulLogin(response);
                } else {
                    document.getElementById("errorMessage").innerHTML = "‚ùå " + response.error;
                }
            } catch (error) {
                document.getElementById("errorMessage").innerHTML = "üîí Error de conexi√≥n: " + error.message;
            }
        }

        function handleSuccessfulLogin(response) {
            currentUser = response.alumno;
            alumnoActual = response.alumno;
            document.getElementById("displayusername").innerHTML = currentUser.Nombre + " " + currentUser.Apellido;
            
            // Mostrar dashboard
            document.getElementById("page1_id1").style.display = "none";
            document.getElementById("page4_id1").style.display = "block";
            document.getElementById("errorMessage").innerHTML = "";
            
            // Cargar progreso del usuario
            loadUserProgress(currentUser.ID_Alumno);
            loadCursos();
        }

        // === FUNCI√ìN PARA CARGAR PROGRESO CORREGIDA ===
        async function loadUserProgress(alumnoId) {
            try {
                const result = await callJSONP('getUserProgress', { alumnoId: String(alumnoId) });
                userProgress = {};
                if (result.data && result.data.length > 0) {
                    result.data.forEach(function(item) {
                        userProgress[item.ID_Clase] = {
                            completed: item.Completada === "S√≠" || item.Completada === "TRUE" || item.Completada === "s√≠",
                            notes: item.Notas_Alumno || '',
                            lastUpdate: item.Fecha_Guardado || new Date()
                        };
                    });
                }
                console.log("Progreso cargado:", userProgress);
            } catch (error) {
                console.error("Error cargando progreso:", error);
                userProgress = {};
            }
        }

        // === FUNCIONES DE CURSOS CON CACHE FRONTEND ===
        async function loadCursos() {
            const container = document.getElementById('cursosContainer');
            const cacheKey = `cursos_${alumnoActual.ID_Alumno}`;
            
            // Verificar cache local
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                console.log('Cargando cursos desde cache frontend');
                displayCursos(JSON.parse(cached));
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando cursos...</div>';
            
            try {
                const result = await callJSONP('getCursosAlumno', { alumnoId: alumnoActual.ID_Alumno });
                // Guardar en cache local
                sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                displayCursos(result.data);
            } catch (error) {
                showCursosError(error);
            }
        }

        function displayCursos(cursos) {
            cursosCache = cursos;
            const container = document.getElementById('cursosContainer');
            
            if (!cursos || cursos.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">üéì</div>
                        <h3 style="color: var(--azul-oscuro); margin-bottom: 6px;">No est√°s inscrito en ning√∫n curso visible</h3>
                        <p style="color: var(--gray); margin-bottom: 12px;">
                            Contacta al administrador para inscribirte en los cursos.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cursos.map(curso => {
                const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
                return `
                <div class="curso-card card" onclick="accederAlCurso('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                    <div class="curso-imagen">
                        ${hasImage ? 
                            `<img src="${curso.Foto_Portada}" 
                                  alt="${curso.Nombre_Curso}" 
                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                  onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                            ''
                        }
                        <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">üéì</div>
                    </div>
                    <div class="curso-content">
                        <h3 class="curso-titulo">${curso.Nombre_Curso}</h3>
                        <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                        <p class="curso-grupo">Inicio: ${formatFecha(curso.Fecha_Inicio)}</p>
                        <button class="btn btn-primary btn-acceder">Acceder al curso</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showCursosError(error) {
            const container = document.getElementById('cursosContainer');
            container.innerHTML = '<div class="error">Error al cargar los cursos: ' + error.message + '</div>';
        }

        async function accederAlCurso(cursoId, grupoId) {
            currentCourseId = cursoId;
            currentGrupoId = grupoId;
            
            // Encontrar los datos del curso actual
            currentCourseData = cursosCache.find(curso => 
                curso.ID_Curso === cursoId && curso.ID_Grupo === grupoId
            );
            
            // Mostrar cabecera del curso
            if (currentCourseData) {
                document.getElementById('courseTitle').textContent = currentCourseData.Nombre_Curso;
                document.getElementById('courseDescription').textContent = currentCourseData.Descripcion || 'No hay descripci√≥n disponible para este curso.';
                
                // Imagen de cabecera del curso
                if (currentCourseData.Foto_Cabecera) {
                    document.getElementById('courseHeaderImage').src = currentCourseData.Foto_Cabecera;
                    document.getElementById('courseHeaderImage').style.display = 'block';
                } else {
                    document.getElementById('courseHeaderImage').style.display = 'none';
                }
                
                // Actualizar botones del curso
                updateCourseButtons();
                
                document.getElementById('courseHeader').style.display = 'block';
            }
            
            // Ocultar cursos y mostrar m√≥dulos
            document.getElementById('cursosContainer').style.display = 'none';
            document.getElementById('mainTitle').textContent = 'M√≥dulos del Curso';
            
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">‚Üê Volver a Mis Cursos</button><div class="loading">Cargando m√≥dulos...</div>';
            
            // Desplazar hacia el contenedor de m√≥dulos
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
            
            const cacheKey = `modulos_${alumnoActual.ID_Alumno}_${cursoId}_${grupoId}`;
            const cached = sessionStorage.getItem(cacheKey);
            
            if (cached) {
                console.log('Cargando m√≥dulos desde cache frontend');
                displayModulos(JSON.parse(cached), cursoId, grupoId);
            } else {
                try {
                    const result = await callJSONP('getModulosCurso', {
                        alumnoId: alumnoActual.ID_Alumno,
                        cursoId: cursoId,
                        grupoId: grupoId
                    });
                    sessionStorage.setItem(cacheKey, JSON.stringify(result.data));
                    displayModulos(result.data, cursoId, grupoId);
                } catch (error) {
                    container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">‚Üê Volver a Mis Cursos</button><div class="error">Error al cargar m√≥dulos: ' + error.message + '</div>';
                }
            }
        }

        function updateCourseButtons() {
            const buttonsContainer = document.getElementById('courseButtons');
            buttonsContainer.innerHTML = '';
            
            // Bot√≥n manual del curso
            if (currentCourseData.Manual_c) {
                const manualBtn = document.createElement('button');
                manualBtn.className = 'btn btn-primary';
                manualBtn.innerHTML = 'üìò Manual del Curso';
                manualBtn.onclick = function() {
                    showCourseManual(currentCourseData.Manual_c);
                };
                buttonsContainer.appendChild(manualBtn);
            }
            
            // Bot√≥n WhatsApp
            if (currentCourseData.Whatsapp) {
                const whatsappBtn = document.createElement('button');
                whatsappBtn.className = 'btn btn-success';
                whatsappBtn.innerHTML = 'üì± WhatsApp del Grupo';
                whatsappBtn.onclick = function() {
                    window.open(currentCourseData.Whatsapp, '_blank');
                };
                buttonsContainer.appendChild(whatsappBtn);
            }
            
            // Bot√≥n Calendario
            if (currentCourseData.Calendario) {
                const calendarBtn = document.createElement('button');
                calendarBtn.className = 'btn btn-secondary';
                calendarBtn.innerHTML = 'üìÖ Calendario';
                calendarBtn.onclick = function() {
                    window.open(currentCourseData.Calendario, '_blank');
                };
                buttonsContainer.appendChild(calendarBtn);
            }
            
            // Bot√≥n Mensaje
            if (currentCourseData.Mensaje) {
                const messageBtn = document.createElement('button');
                messageBtn.className = 'btn btn-primary';
                messageBtn.innerHTML = 'üì¢ Mensaje Importante';
                messageBtn.onclick = function() {
                    alert(currentCourseData.Mensaje);
                };
                buttonsContainer.appendChild(messageBtn);
            }
        }

        function volverACursos() {
            // Limpiar reproductores
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            currentPlayers = {};
            
            // Ocultar cabecera del curso
            document.getElementById('courseHeader').style.display = 'none';
            
            // Mostrar cursos nuevamente
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';
            document.getElementById('cursosContainer').style.display = 'grid';
            document.getElementById('mainTitle').textContent = 'Mis Cursos';
        }

        // === SISTEMA DE M√ìDULOS Y CLASES ===
        function displayModulos(modules, cursoId, grupoId) {
            const container = document.getElementById("modulesContainer");
            container.innerHTML = '<button class="btn btn-secondary back-btn" onclick="volverACursos()">‚Üê Volver a Mis Cursos</button>';
            
            if (!modules || modules.length === 0) {
                container.innerHTML += "<p class='no-content'>No tienes m√≥dulos disponibles en este momento.</p>";
                return;
            }
            
            userModules = modules;
            
            let modulesList = "<h3 style='color: var(--azul-oscuro); margin-bottom: 12px;'>Tus M√≥dulos Disponibles:</h3><div class='grid grid-modulos'>";
            
            modules.forEach(module => {
                const progressPercentage = module.Total_Clases > 0 ? 
                    Math.round((module.Clases_Completadas / module.Total_Clases) * 100) : 0;
                
                modulesList += `
                <div class='module-card card' onclick='expandModule("${module.ID_M√≥dulo}")'>
                    <h4 class="module-titulo">${module['Nombre del M√≥dulo'] || module.Nombre_Modulo}</h4>
                    <div class='progress-container'>
                        <div class='progress-label'>Progreso del M√≥dulo</div>
                        <div class='progress-bar-container'>
                            <div class='progress-bar' style='width: ${progressPercentage}%'></div>
                        </div>
                        <div class='progress-text'>${progressPercentage}% completado</div>
                    </div>
                </div>`;
            });
            
            modulesList += "</div>";
            container.innerHTML += modulesList;
        }

        function expandModule(moduleId) {
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'none';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'none';
            
            var selectedModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_M√≥dulo === moduleId) {
                    selectedModule = userModules[i];
                    break;
                }
            }
            
            if (!selectedModule) return;
            
            var expandedContent = "<div class='expanded-module'>";
            
            // Cabecera del m√≥dulo
            expandedContent += `
            <div class='module-header-expanded card'>
                <div class='module-title-section'>
                    <h2>${selectedModule['Nombre del M√≥dulo'] || selectedModule.Nombre_Modulo}</h2>
                </div>
                <div class='module-content'>
                    <div class='module-image-container'>
                        ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 
                            `<img src="${selectedModule['imagen_m']}" class='module-header-image' alt='Imagen del m√≥dulo' onerror='this.style.display=\"none\"; this.nextElementSibling.style.display=\"flex\";' onload='this.style.display=\"block\"; this.nextElementSibling.style.display=\"none\";'>` : 
                            ''
                        }
                        <div style="width: 140px; height: 100px; background: linear-gradient(135deg, var(--azul), var(--naranja)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; ${selectedModule['imagen_m'] && selectedModule['imagen_m'].trim() !== '' ? 'display: none;' : ''}">üìö</div>
                    </div>
                    <div class='module-info'>
                        <p class='module-description'>${selectedModule['Descripci√≥n del M√≥dulo'] || 'No hay descripci√≥n disponible para este m√≥dulo.'}</p>
                        <div class='module-buttons'>
                            ${selectedModule['Manual_m'] && selectedModule['Manual_m'].trim() !== '' ? 
                                `<button class='btn btn-secondary' onclick='showModuleManual("${selectedModule['Manual_m']}")'>üìò Manual del M√≥dulo</button>` : 
                                ''
                            }
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Resto del contenido del m√≥dulo (clases)
            expandedContent += "<div class='module-header'>";
            expandedContent += "<button class='btn btn-secondary back-button' onclick='collapseModule()'>‚Üê Mis M√≥dulos</button>";
            expandedContent += "</div>";
            
            var completedCount = selectedModule.Clases_Completadas || 0;
            var totalCount = selectedModule.Total_Clases || 0;
            
            var progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            expandedContent += "<div class='module-progress-expanded progress-container'>";
            expandedContent += "<div class='progress-label'>Progreso del M√≥dulo</div>";
            expandedContent += "<div class='progress-bar-container'>";
            expandedContent += "<div class='progress-bar' style='width: " + progressPercentage + "%'></div>";
            expandedContent += "</div>";
            expandedContent += "<div class='progress-text'>" + completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)</div>";
            expandedContent += "</div>";
            
            if (selectedModule.Clases && selectedModule.Clases.length > 0) {
                expandedContent += "<div class='content-list-expanded'>";
                
                for (var j = 0; j < selectedModule.Clases.length; j++) {
                    var content = selectedModule.Clases[j];
                    var lessonId = content.ID_Clase;
                    var isCompleted = userProgress[lessonId] && userProgress[lessonId].completed;
                    var hasNotes = userProgress[lessonId] && userProgress[lessonId].notes && userProgress[lessonId].notes.trim() !== '';
                    
                    expandedContent += "<div class='content-item card" + (isCompleted ? " completed" : "") + "'>";
                    
                    expandedContent += "<div class='lesson-header'>";
                    expandedContent += "<input type='checkbox' id='check_" + lessonId + "' class='lesson-checkbox' ";
                    expandedContent += "onchange='markAsViewed(\"" + lessonId + "\", \"" + moduleId + "\", \"" + (selectedModule['Nombre del M√≥dulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\", this)' ";
                    if (isCompleted) {
                        expandedContent += "checked ";
                    }
                    expandedContent += "/>";
                    expandedContent += "<label for='check_" + lessonId + "' class='lesson-title'>" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "</label>";
                    expandedContent += "</div>";
                    
                    // === MINIATURA Y DESCRIPCI√ìN ===
                    var videoUrl = content['URL Video'] || '';
                    var videoId = extractVideoId(videoUrl);
                    var description = content['Descripci√≥n'] || '';
                    
                    if (videoId || description) {
                        expandedContent += "<div class='lesson-preview'>";
                        
                        // Miniatura del video (si existe)
                        if (videoId) {
                            var thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                            expandedContent += "<div class='lesson-thumbnail' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + videoUrl + "\")'>";
                            expandedContent += "<img src='" + thumbnailUrl + "' alt='Miniatura del video'>";
                            expandedContent += "<div class='play-icon'>‚ñ∂</div>";
                            expandedContent += "</div>";
                        }
                        
                        // Descripci√≥n de la clase
                        if (description) {
                            expandedContent += "<div class='lesson-description'>" + description + "</div>";
                        }
                        
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div class='content-links'>";
                    
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<button id='show-player-" + lessonId + "' class='btn btn-secondary action-btn' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + content['URL Video'] + "\")'>üé¨ Ver Video</button>";
                        expandedContent += "<button id='hide-player-" + lessonId + "' class='btn btn-secondary action-btn' onclick='hideVideoPlayer(\"" + lessonId + "\")' style='display: none;'>‚ùå Cerrar Video</button>";
                    }
                    
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<button id='show-manual-" + lessonId + "' class='btn btn-secondary action-btn' onclick='showManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>üìÑ Ver Manual</button>";
                        expandedContent += "<button id='hide-manual-" + lessonId + "' class='btn btn-secondary action-btn' onclick='hideManual(\"" + lessonId + "\")' style='display: none;'>‚ùå Cerrar Manual</button>";
                    }
                    
                    expandedContent += "<button id='notes-btn-" + lessonId + "' class='btn btn-primary action-btn' onclick='toggleNotes(\"" + lessonId + "\")'>";
                    expandedContent += hasNotes ? "üìù Ver notas (" + (userProgress[lessonId].notes.length > 0 ? "1" : "0") + ")" : "üìù Agregar notas";
                    expandedContent += "</button>";
                    
                    // Bot√≥n Clase Siguiente (excepto para la √∫ltima clase)
                    if (j < selectedModule.Clases.length - 1) {
                        expandedContent += "<button class='btn btn-secondary action-btn' onclick='nextClass(\"" + lessonId + "\", \"" + moduleId + "\")'>‚û°Ô∏è Clase Siguiente</button>";
                    }
                    
                    expandedContent += "</div>";
                    
                    // === NUEVO REPRODUCTOR CORREGIDO ===
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<div id='player-container-" + lessonId + "' class='player-container' style='display: none;'>";
                        expandedContent += "<div class='video-container' id='videoContainer-" + lessonId + "'>";
                        expandedContent += "<div id='player-" + lessonId + "'></div>";
                        expandedContent += "<div class='overlay' id='overlay-" + lessonId + "'></div>";
                        expandedContent += "<div class='corner-box'>";
                        if (escuelaData && escuelaData.Logo_Escuela) {
                            expandedContent += "<img src='" + escuelaData.Logo_Escuela + "' alt='Logo' class='school-logo-mini'>";
                        } else {
                            expandedContent += "üéì";
                        }
                        expandedContent += "</div>";
                        expandedContent += "<div class='exit-fullscreen' id='exitFullscreenBtn-" + lessonId + "'>‚úñ</div>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='controls-panel'>";
                        expandedContent += "<div class='progress-row'>";
                        expandedContent += "<div class='progress-container-player' id='progressBar-" + lessonId + "'>";
                        expandedContent += "<div class='progress-player' id='progress-" + lessonId + "'></div>";
                        expandedContent += "<div class='thumb' id='thumb-" + lessonId + "'></div>";
                        expandedContent += "</div>";
                        expandedContent += "<div class='time-display' id='timeDisplay-" + lessonId + "'>0:00 / 0:00</div>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='video-controls'>";
                        expandedContent += "<button id='playPauseBtn-" + lessonId + "'>‚ñ∂ Play</button>";
                        expandedContent += "<button id='restartBtn-" + lessonId + "'>‚èÆ Reiniciar</button>";
                        expandedContent += "<button id='fullscreenBtn-" + lessonId + "'>‚õ∂ Pantalla completa</button>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                    }
                    
                    // Contenedor para el manual PDF
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<div id='manual-container-" + lessonId + "' class='manual-container card' style='display: none;'>";
                        expandedContent += "<div class='manual-header'>";
                        expandedContent += "<h4>üìö Material de Estudio</h4>";
                        expandedContent += "<p>Accede a tu contenido educativo</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='content-links'>";
                        expandedContent += "<button class='btn btn-secondary action-btn' onclick='downloadManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>";
                        expandedContent += "üì• Descargar";
                        expandedContent += "</button>";
                        
                        expandedContent += "<button class='btn btn-secondary action-btn' onclick='printManual(\"" + lessonId + "\")'>";
                        expandedContent += "üñ®Ô∏è Imprimir";
                        expandedContent += "</button>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div id='welcome-message-" + lessonId + "' class='welcome-message'>";
                        expandedContent += "<h5>¬°Bienvenido!</h5>";
                        expandedContent += "<p>Haz clic en \"Ver Manual\" para acceder al material de estudio.</p>";
                        expandedContent += "<p>Una vez abierto, podr√°s descargarlo o imprimirlo seg√∫n necesites.</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<iframe id='pdf-frame-" + lessonId + "' class='pdf-frame' style='display: none; width: 100%; height: 500px; border: none;'></iframe>";
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div id='notes-area-" + lessonId + "' class='notes-area card' style='display: none;'>";
                    expandedContent += "<h4>Notas para esta lecci√≥n:</h4>";
                    expandedContent += "<textarea id='notes-text-" + lessonId + "' class='notes-textarea' placeholder='Escribe tus notas aqu√≠...'>";
                    if (hasNotes) {
                        expandedContent += userProgress[lessonId].notes;
                    }
                    expandedContent += "</textarea>";
                    expandedContent += "<button id='save-notes-btn-" + lessonId + "' class='btn btn-primary save-notes-btn' onclick='saveNotes(\"" + lessonId + "\", \"" + (selectedModule['Nombre del M√≥dulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\")'>Guardar notas</button>";
                    expandedContent += "</div>";
                    
                    expandedContent += "</div>";
                }
                
                expandedContent += "</div>";
            } else {
                expandedContent += "<p class='no-content'>Contenido pr√≥ximamente...</p>";
            }
            
            expandedContent += "</div>";
            
            var expandedContainer = document.createElement('div');
            expandedContainer.id = 'expanded-module-container';
            expandedContainer.innerHTML = expandedContent;
            
            document.getElementById('modulesContainer').appendChild(expandedContainer);
            
            // Desplazar hacia el m√≥dulo expandido
            setTimeout(() => {
                expandedContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function collapseModule() {
            var expandedContainer = document.getElementById('expanded-module-container');
            if (expandedContainer) {
                expandedContainer.remove();
            }
            
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'block';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'block';
        }

        // === FUNCI√ìN CORREGIDA PARA GUARDAR PROGRESO ===
        async function saveProgressToDatabase(lessonId, completed, notes) {
            try {
                console.log('üíæ Guardando progreso:', { lessonId, completed, notes });
                
                // Enviar datos en el formato correcto que espera el backend
                const progressData = {
                    ID_Alumno: String(alumnoActual.ID_Alumno),
                    ID_Clase: String(lessonId),
                    Fecha_Guardado: new Date().toISOString().split('T')[0],
                    Completada: completed ? "S√≠" : "No",
                    Notas_Alumno: notes || ''
                };
                
                console.log('üì§ Enviando datos de progreso:', progressData);
                
                // Llamar a la acci√≥n 'progreso' con los datos correctos
                const response = await callJSONP('progreso', progressData);
                console.log('‚úÖ Respuesta del servidor:', response);
                
                if (!response.success) {
                    throw new Error(response.error || 'Error al guardar el progreso');
                }
                return response;
            } catch (error) {
                console.error('‚ùå Error guardando progreso:', error);
                throw error;
            }
        }

        // === SISTEMA DE PROGRESO MEJORADO Y CORREGIDO ===
        async function markAsViewed(lessonId, moduleId, moduleName, lessonName, checkbox) {
            const completed = checkbox.checked;
            const notes = userProgress[lessonId] ? userProgress[lessonId].notes : '';
            
            const contentItem = checkbox.closest('.content-item');
            if (completed) {
                contentItem.classList.add('completed');
            } else {
                contentItem.classList.remove('completed');
            }
            
            try {
                // Guardar progreso en la base de datos
                await saveProgressToDatabase(lessonId, completed, notes);
                
                // Actualizar estado local
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                userProgress[lessonId].completed = completed;
                userProgress[lessonId].notes = notes;
                userProgress[lessonId].lastUpdate = new Date();
                
                // Actualizar cache local
                updateLocalCache();
                showNotification(completed ? '‚úÖ Lecci√≥n completada' : 'üìù Progreso actualizado');
                
                // Actualizar progreso del m√≥dulo
                updateModuleProgress(moduleId);
                
            } catch (error) {
                console.error('Error en markAsViewed:', error);
                showNotification('‚ùå Error de conexi√≥n: ' + error.message, 'error');
                checkbox.checked = !completed; // Revertir cambio
                if (completed) {
                    contentItem.classList.remove('completed');
                } else {
                    contentItem.classList.add('completed');
                }
            }
        }

        // Funci√≥n para actualizar el progreso del m√≥dulo
        function updateModuleProgress(moduleId) {
            const selectedModule = userModules.find(m => m.ID_M√≥dulo === moduleId);
            if (!selectedModule) return;
            
            let completedCount = 0;
            selectedModule.Clases.forEach(content => {
                if (userProgress[content.ID_Clase] && userProgress[content.ID_Clase].completed) {
                    completedCount++;
                }
            });
            
            const totalCount = selectedModule.Clases.length;
            const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            // Actualizar la barra de progreso en la vista expandida
            const progressBar = document.querySelector('.module-progress-expanded .progress-bar');
            const progressText = document.querySelector('.module-progress-expanded .progress-text');
            
            if (progressBar) {
                progressBar.style.width = progressPercentage + '%';
            }
            
            if (progressText) {
                progressText.textContent = completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)";
            }
            
            // Actualizar la tarjeta del m√≥dulo
            const moduleCard = document.querySelector(`[onclick="expandModule('${moduleId}')"]`);
            if (moduleCard) {
                const cardProgressBar = moduleCard.querySelector('.progress-bar');
                const cardProgressText = moduleCard.querySelector('.progress-text');
                
                if (cardProgressBar) {
                    cardProgressBar.style.width = progressPercentage + '%';
                }
                
                if (cardProgressText) {
                    cardProgressText.textContent = progressPercentage + '% completado';
                }
            }
        }

        async function saveNotes(lessonId, moduleName, lessonName) {
            const notesText = document.getElementById('notes-text-' + lessonId).value;
            const saveButton = document.getElementById('save-notes-btn-' + lessonId);
            
            saveButton.textContent = 'Guardando...';
            saveButton.disabled = true;
            
            try {
                // Guardar notas en la base de datos
                await saveProgressToDatabase(lessonId, 
                    userProgress[lessonId] ? userProgress[lessonId].completed : false, 
                    notesText
                );
                
                if (!userProgress[lessonId]) {
                    userProgress[lessonId] = {};
                }
                userProgress[lessonId].notes = notesText;
                
                // Actualizar cache local
                updateLocalCache();
                
                showNotification('‚úÖ Notas guardadas correctamente');
                saveButton.textContent = 'Guardado ‚úì';
                
                const notesButton = document.getElementById('notes-btn-' + lessonId);
                notesButton.textContent = 'üìù Ver notas (' + (notesText.length > 0 ? "1" : "0") + ')';
                
                setTimeout(() => {
                    saveButton.textContent = 'Guardar notas';
                    saveButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                showNotification('‚ùå Error: ' + error.message, 'error');
                saveButton.textContent = 'Guardar notas';
                saveButton.disabled = false;
            }
        }

        // === SISTEMA DE VIDEO MEJORADO Y CORREGIDO ===
        function showVideoPlayer(lessonId, videoUrl) {
            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                showNotification("URL de video inv√°lida", "error");
                return;
            }

            pauseAllVideos();
            
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            document.querySelectorAll('.player-container').forEach(container => {
                if (container.id !== 'player-container-' + lessonId) {
                    container.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="hide-player-"]').forEach(button => {
                if (button.id !== 'hide-player-' + lessonId) {
                    button.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="show-player-"]').forEach(button => {
                if (button.id !== 'show-player-' + lessonId && !button.closest('.player-container')) {
                    button.style.display = 'inline-flex';
                }
            });
            
            playerContainer.style.display = 'block';
            showButton.style.display = 'none';
            hideButton.style.display = 'inline-flex';
            
            // Desplazar la p√°gina para mostrar el reproductor
            playerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (!currentPlayers[lessonId] || currentPlayers[lessonId].getVideoData === undefined) {
                createPlayer(lessonId, videoId);
            } else {
                currentPlayers[lessonId].cueVideoById(videoId);
                setTimeout(function() {
                    adjustPlayerSize(lessonId);
                }, 100);
            }
        }

        function hideVideoPlayer(lessonId) {
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            playerContainer.style.display = 'none';
            showButton.style.display = 'inline-flex';
            hideButton.style.display = 'none';
            
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].pauseVideo();
            }
        }

        function pauseAllVideos() {
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId] && typeof currentPlayers[lessonId].pauseVideo === 'function') {
                    currentPlayers[lessonId].pauseVideo();
                }
            }
        }

        function extractVideoId(url) {
            var regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            var match = url.match(regex);
            return match ? match[1] : null;
        }

        function adjustPlayerSize(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            var container = document.getElementById('videoContainer-' + lessonId);
            if (!container) return;
            
            var containerWidth = container.clientWidth;
            var containerHeight = containerWidth * 9 / 16;
            
            player.setSize(containerWidth, containerHeight);
        }

        function createPlayer(lessonId, videoId) {
            var playerId = 'player-' + lessonId;
            
            currentPlayers[lessonId] = new YT.Player(playerId, {
                videoId: videoId,
                playerVars: { 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    iv_load_policy: 3,
                    playsinline: 1
                },
                events: {
                    onReady: function() { onPlayerReady(lessonId); },
                    onStateChange: function(event) { onPlayerStateChange(lessonId, event); }
                }
            });
        }

        function onPlayerReady(lessonId) {
            var player = currentPlayers[lessonId];
            
            adjustPlayerSize(lessonId);
            
            setupCustomControls(lessonId);
            
            setInterval(function() {
                updateProgress(lessonId);
            }, 500);
        }

        function onPlayerStateChange(lessonId, event) {
            var btn = document.getElementById("playPauseBtn-" + lessonId);
            if (btn) {
                btn.textContent = event.data === YT.PlayerState.PLAYING ? "‚è∏ Pause" : "‚ñ∂ Play";
            }
        }

        // === FUNCI√ìN PARA ACTUALIZAR TIEMPO EN BARRA DE PROGRESO ===
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return "0:00";
            
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ":" + (secs < 10 ? "0" : "") + secs;
        }

        function updateProgress(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player || !player.getCurrentTime || dragging) return;

            var currentTime = player.getCurrentTime();
            var duration = player.getDuration();
            var percent = (currentTime / duration) * 100;
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            var timeDisplay = document.getElementById("timeDisplay-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = percent + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent / 100 * progressBarElement.offsetWidth) + "px";
            }
            
            // ACTUALIZAR DISPLAY DE TIEMPO
            if (timeDisplay && duration) {
                timeDisplay.textContent = formatTime(currentTime) + " / " + formatTime(duration);
            }
        }

        // === FUNCI√ìN SETUP CUSTOM CONTROLS MEJORADA Y CORREGIDA ===
        function setupCustomControls(lessonId) {
            var overlay = document.getElementById("overlay-" + lessonId);
            var playPauseBtn = document.getElementById("playPauseBtn-" + lessonId);
            var restartBtn = document.getElementById("restartBtn-" + lessonId);
            var fullscreenBtn = document.getElementById("fullscreenBtn-" + lessonId);
            var exitFullscreenBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            var progressBar = document.getElementById("progressBar-" + lessonId);
            var thumb = document.getElementById("thumb-" + lessonId);

            if (overlay) {
                overlay.onclick = function(e) { 
                    if (!e.target.closest('.video-controls') && !e.target.closest('.exit-fullscreen')) {
                        togglePlayPause(lessonId); 
                    }
                };
            }
            
            if (playPauseBtn) playPauseBtn.onclick = function() { togglePlayPause(lessonId); };
            if (restartBtn) restartBtn.onclick = function() { restartVideo(lessonId); };
            if (fullscreenBtn) fullscreenBtn.onclick = function() { goFullScreen(lessonId); };
            if (exitFullscreenBtn) exitFullscreenBtn.onclick = function() { exitFullScreen(lessonId); };

            // Sistema de arrastre para la barra de progreso
            if (thumb) {
                thumb.addEventListener("mousedown", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId); 
                });
                thumb.addEventListener("touchstart", function(e) { 
                    e.preventDefault();
                    startDrag(e, lessonId); 
                }, {passive: false});
            }

            if (progressBar) {
                progressBar.addEventListener("click", function(e) {
                    if (!dragging) {
                        var rect = progressBar.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        if (x < 0) x = 0;
                        if (x > rect.width) x = rect.width;
                        seekToPosition(lessonId, x / rect.width);
                    }
                });
            }

            // Eventos globales de arrastre
            document.addEventListener("mousemove", function(e) { 
                dragMove(e, lessonId);
            });
            document.addEventListener("mouseup", function(e) { 
                endDrag(e);
            });
            document.addEventListener("touchmove", function(e) { 
                dragMove(e, lessonId);
            }, {passive: false});
            document.addEventListener("touchend", function(e) { 
                endDrag(e);
            });
            document.addEventListener("touchcancel", function(e) { 
                endDrag(e);
            });

            // Eventos de pantalla completa
            document.addEventListener('fullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            document.addEventListener('webkitfullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            document.addEventListener('msfullscreenchange', function() { 
                fullscreenChange(lessonId);
            });
            
            // Redimensionamiento
            window.addEventListener('resize', function() {
                if (currentPlayers[lessonId]) {
                    adjustPlayerSize(lessonId);
                }
            });
            
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    fullscreenChange(lessonId);
                    adjustPlayerSize(lessonId);
                }, 300);
            });
        }

        function togglePlayPause(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function restartVideo(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            player.seekTo(0, true);
            player.playVideo();
        }

        function startDrag(e, lessonId) {
            e.preventDefault();
            dragging = true;
            window.currentDragLessonId = lessonId;
        }

        function dragMove(e, lessonId) {
            if (dragging && window.currentDragLessonId === lessonId) {
                e.preventDefault();
                var progressBar = document.getElementById("progressBar-" + lessonId);
                if (!progressBar) return;

                var rect = progressBar.getBoundingClientRect();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var x = clientX - rect.left;
                
                if (x < 0) x = 0;
                if (x > rect.width) x = rect.width;
                
                seekToPosition(lessonId, x / rect.width);
            }
        }

        function endDrag(e) {
            dragging = false;
            window.currentDragLessonId = null;
        }

        function seekToPosition(lessonId, percent) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var duration = player.getDuration();
            var newTime = duration * percent;
            player.seekTo(newTime, true);
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = (percent * 100) + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent * progressBarElement.offsetWidth) + "px";
            }
        }

        function goFullScreen(lessonId) {
            var container = document.getElementById("player-container-" + lessonId);
            if (!container) return;

            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
        }

        function exitFullScreen(lessonId) {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        function fullscreenChange(lessonId) {
            var exitBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            
            var isFullscreen = document.fullscreenElement || 
                              document.webkitFullscreenElement || 
                              document.msFullscreenElement;
            
            if (exitBtn) {
                exitBtn.style.display = isFullscreen ? "flex" : "none";
            }
        }

        // === SISTEMA UNIFICADO DE MANUALES ===
        function showCourseManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del Curso');
            }
        }

        function showModuleManual(manualUrl) {
            if (manualUrl) {
                openManualViewer(manualUrl, 'Manual del M√≥dulo');
            }
        }

        function openManualViewer(manualUrl, title) {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            const modalTitle = document.getElementById('manualModalTitle');
            
            if (modal && frame) {
                modalTitle.textContent = title;
                const viewerUrl = convertToGoogleDriveViewer(manualUrl);
                frame.src = viewerUrl;
                modal.style.display = 'flex';
            }
        }

        function closeManualViewer() {
            const modal = document.getElementById('universalManualModal');
            const frame = document.getElementById('manualModalFrame');
            if (modal && frame) {
                modal.style.display = 'none';
                frame.src = '';
            }
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualViewer();
            }
        });

        function convertToGoogleDriveViewer(url) {
            var fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }
            return url;
        }

        function extractGoogleDriveFileId(url) {
            var match = url.match(/[-\w]{25,}/);
            return match ? match[0] : null;
        }

        function downloadManual(lessonId, manualUrl) {
            var fileId = extractGoogleDriveFileId(manualUrl);
            if (fileId) {
                var downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
                window.open(downloadUrl, '_blank');
            } else {
                window.open(manualUrl, '_blank');
            }
        }

        function printManual(lessonId) {
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            if (pdfFrame && pdfFrame.contentWindow) {
                try {
                    pdfFrame.contentWindow.print();
                } catch (e) {
                    var manualUrl = pdfFrame.src;
                    window.open(manualUrl, '_blank');
                    showNotification('Se abri√≥ el manual en una nueva ventana para imprimir', 'info');
                }
            }
        }

        // === SISTEMA DE NOTAS ===
        function toggleNotes(lessonId) {
            var notesArea = document.getElementById('notes-area-' + lessonId);
            var notesButton = document.getElementById('notes-btn-' + lessonId);
            
            if (notesArea.style.display === 'none' || !notesArea.style.display) {
                notesArea.style.display = 'block';
                notesButton.textContent = 'Ocultar notas';
                
                var notesTextarea = document.getElementById('notes-text-' + lessonId);
                if (notesTextarea.value === '' && userProgress[lessonId] && userProgress[lessonId].notes) {
                    notesTextarea.value = userProgress[lessonId].notes;
                }
            } else {
                notesArea.style.display = 'none';
                notesButton.textContent = 'Ver/Editar notas';
            }
        }

        // === FUNCI√ìN CLASE SIGUIENTE ===
        function nextClass(lessonId, moduleId) {
            var currentModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_M√≥dulo === moduleId) {
                    currentModule = userModules[i];
                    break;
                }
            }
            
            if (!currentModule || !currentModule.Clases) return;
            
            var currentIndex = -1;
            for (var j = 0; j < currentModule.Clases.length; j++) {
                if (currentModule.Clases[j].ID_Clase === lessonId) {
                    currentIndex = j;
                    break;
                }
            }
            
            if (currentIndex === -1 || currentIndex >= currentModule.Clases.length - 1) {
                showNotification("No hay m√°s clases en este m√≥dulo", "info");
                return;
            }
            
            var nextLesson = currentModule.Clases[currentIndex + 1];
            
            hideVideoPlayer(lessonId);
            hideManual(lessonId);
            
            var currentCheckbox = document.getElementById('check_' + lessonId);
            if (currentCheckbox && !currentCheckbox.checked) {
                currentCheckbox.checked = true;
                markAsViewed(lessonId, moduleId, currentModule['Nombre del M√≥dulo'], currentModule.Clases[currentIndex]['Nombre de la Clase'], currentCheckbox);
            }
            
            if (nextLesson['URL Video'] && nextLesson['URL Video'].trim() !== '') {
                setTimeout(function() {
                    showVideoPlayer(nextLesson.ID_Clase, nextLesson['URL Video']);
                }, 300);
            }
            
            var nextLessonElement = document.getElementById('check_' + nextLesson.ID_Clase);
            if (nextLessonElement) {
                nextLessonElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            showNotification("Avanzando a la siguiente clase: " + nextLesson['Nombre de la Clase'], "success");
        }

        // === FUNCIONES UTILITARIAS ===
        function updateLocalCache() {
            // Invalidar cache local cuando hay cambios
            if (alumnoActual) {
                sessionStorage.removeItem(`cursos_${alumnoActual.ID_Alumno}`);
                if (currentCourseId && currentGrupoId) {
                    sessionStorage.removeItem(`modulos_${alumnoActual.ID_Alumno}_${currentCourseId}_${currentGrupoId}`);
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function formatFecha(fechaString) {
            if (!fechaString) return 'No especificada';
            try {
                const fecha = new Date(fechaString);
                return fecha.toLocaleDateString('es-ES');
            } catch (e) {
                return fechaString;
            }
        }

        function clearErrors() {
            document.getElementById("errorMessage").innerHTML = "";
        }
        
        function clearForms() {
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
        }

        function logout() {
            // Limpiar todo
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            
            currentPlayers = {};
            currentUser = null;
            userProgress = {};
            userModules = [];
            alumnoActual = null;
            currentCourseData = null;
            
            sessionStorage.clear();
            
            document.getElementById('courseHeader').style.display = 'none';
            document.getElementById("page4_id1").style.display = "none";
            document.getElementById("page1_id1").style.display = "flex";
            clearErrors();
            clearForms();
        }

        // Funciones auxiliares para manuales
        function showManual(lessonId, manualUrl) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            if (manualContainer.style.display === 'none' || !manualContainer.style.display) {
                manualContainer.style.display = 'block';
                showManualButton.style.display = 'none';
                hideManualButton.style.display = 'inline-flex';
                
                var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
                var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
                
                if (welcomeMessage) welcomeMessage.style.display = 'none';
                if (pdfFrame) {
                    pdfFrame.style.display = 'block';
                    var viewerUrl = convertToGoogleDriveViewer(manualUrl);
                    pdfFrame.src = viewerUrl;
                }
                
                showManualButton.innerHTML = 'üìÑ Ocultar Manual';
            } else {
                hideManual(lessonId);
            }
        }

        function hideManual(lessonId) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            manualContainer.style.display = 'none';
            showManualButton.style.display = 'inline-flex';
            hideManualButton.style.display = 'none';
            
            var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            
            if (welcomeMessage) welcomeMessage.style.display = 'block';
            if (pdfFrame) {
                pdfFrame.style.display = 'none';
                pdfFrame.src = '';
            }
            
            showManualButton.innerHTML = 'üìÑ Ver Manual';
        }

        // === FUNCI√ìN DE DEPURACI√ìN ===
        async function testConnection() {
            try {
                console.log('üß™ Probando conexi√≥n...');
                const response = await callJSONP('escuela', {});
                console.log('‚úÖ Conexi√≥n exitosa:', response);
                return response;
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                return {success: false, error: error.message};
            }
        }

        // Hacer la funci√≥n accesible desde la consola
        window.testConnection = testConnection;
    </script>
</body>
</html>
