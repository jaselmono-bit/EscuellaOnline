<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Path - Dashboard</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* === ESTILOS GENERALES - TEMA NARANJA Y AZUL === */
        :root {
            --naranja: #fbbf24;
            --naranja-claro: #fdba74;
            --azul: #3b82f6;
            --azul-claro: #0ea5e9;
            --azul-oscuro: #1e3a8a;
            --azul-profundo: #1e293b;
            --neutro: #f1f5f9;
            --blanco: #ffffff;
            --success: #10B981;
            --error: #EF4444;
            --gray: #64748B;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(160deg, var(--azul) 0%, var(--naranja) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--azul-profundo);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* === NUEVA ESTRUCTURA DE CABECERA === */
        .header-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(14px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .school-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 300px;
        }

        .school-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 10px;
            background: var(--neutro);
            padding: 5px;
        }

        .school-name {
            color: var(--azul-oscuro);
            font-size: 20px;
            font-weight: 700;
        }

        .user-welcome {
            text-align: right;
            flex: 1;
            min-width: 200px;
        }

        .user-welcome h2 {
            color: var(--azul-oscuro);
            margin-bottom: 5px;
            font-size: 18px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--success);
            color: white;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }

        /* === CABECERA DE CURSO === */
        .course-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(14px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .course-title-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .course-title-section h1 {
            color: var(--azul-oscuro);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .course-content {
            display: flex;
            gap: 25px;
            align-items: flex-start;
        }

        .course-image-container {
            flex: 0 0 200px;
        }

        .course-header-image {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .course-info {
            flex: 1;
        }

        .course-description {
            color: var(--azul-profundo);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .course-manual-btn {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .course-manual-btn:hover {
            transform: scale(1.05);
        }

        /* === CABECERA DE MÓDULO === */
        .module-header-expanded {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(14px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .module-title-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .module-title-section h2 {
            color: var(--azul-oscuro);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .module-content {
            display: flex;
            gap: 25px;
            align-items: flex-start;
        }

        .module-image-container {
            flex: 0 0 180px;
        }

        .module-header-image {
            width: 100%;
            max-height: 120px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .module-info {
            flex: 1;
        }

        .module-description {
            color: var(--azul-profundo);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .module-manual-btn {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .module-manual-btn:hover {
            transform: scale(1.05);
        }

        /* === ESTILOS DE PÁGINAS === */
        .page1_class1-off, .page2_id1-off, .page3_id1-off, .page4_id1-off {
            display: none;
        }

        .page2_class1, .page3_class1, .page4_class1 {
            display: none;
        }

        /* === LOGIN === */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(14px);
            border-radius: 30px;
            width: 350px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease;
        }

        .school-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-school-logo {
            max-width: 100px;
            max-height: 70px;
            object-fit: contain;
            margin: 0 auto 15px;
            display: block;
            border-radius: 10px;
            background: var(--neutro);
            padding: 10px;
        }

        .login-title {
            text-align: center;
            color: var(--azul-oscuro);
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 24px;
        }

        input[type=text], input[type=password] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            outline: none;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            box-sizing: border-box;
            background: white;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type=text]:hover, input[type=password]:hover {
            border-bottom: 2px solid var(--azul);
        }

        input[type=text]:focus, input[type=password]:focus {
            border-bottom: 2px solid var(--naranja);
        }

        input[type=submit], input[type=button] {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.3s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            width: 100%;
        }

        input[type=submit]:hover, input[type=button]:hover {
            transform: scale(1.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
            min-height: 20px;
        }

        /* === DASHBOARD === */
        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(14px);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* === GRID DE CURSOS === */
        .cursos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .curso-card {
            background: var(--blanco);
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s;
            cursor: pointer;
            border-left: 8px solid var(--azul);
            border-right: 8px solid var(--naranja);
        }
        
        .curso-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.1);
        }
        
        .curso-imagen {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            overflow: hidden;
            position: relative;
        }

        .curso-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .curso-card:hover .curso-imagen img {
            transform: scale(1.05);
        }

        .curso-imagen .image-fallback {
            font-size: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .curso-content {
            padding: 20px;
        }
        
        .curso-titulo {
            font-size: 18px;
            font-weight: 600;
            color: var(--azul-oscuro);
            margin-bottom: 8px;
        }
        
        .curso-grupo {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .btn-acceder {
            background: linear-gradient(to right, var(--naranja), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        /* === BOTÓN VOLVER === */
        .back-to-courses-btn {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-to-courses-btn:hover {
            transform: scale(1.05);
        }

        /* === VISTA MÓDULOS === */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .module-card {
            background: var(--blanco);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border-left: 8px solid var(--azul);
            border-right: 8px solid var(--naranja);
            cursor: pointer;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 30px rgba(0,0,0,0.08);
        }

        .module-card h4 {
            color: var(--azul-oscuro);
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid var(--azul);
            padding-bottom: 10px;
            word-wrap: break-word;
        }

        .module-progress {
            margin: 15px 0;
            padding: 10px;
            background: var(--neutro);
            border-radius: 8px;
        }

        .module-progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 5px;
            position: relative;
        }

        .module-progress-bar {
            background: linear-gradient(to right, var(--azul), var(--naranja));
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
            transform-origin: left center;
            position: absolute;
            left: 0;
            top: 0;
        }

        .module-progress-text {
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            font-weight: 600;
        }

        .progress-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
            text-align: center;
            font-weight: 600;
        }

        .expanded-module {
            width: 100%;
            background: var(--blanco);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-left: 8px solid var(--azul);
            border-right: 8px solid var(--naranja);
        }

        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--neutro);
        }

        .back-button {
            background: linear-gradient(to right, var(--azul), var(--azul-claro));
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 15px;
            transition: transform 0.3s;
            font-weight: bold;
        }

        .back-button:hover {
            transform: scale(1.05);
        }

        .module-header h3 {
            color: var(--azul-oscuro);
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }

        .module-progress-expanded {
            margin: 20px 0;
            padding: 15px;
            background: var(--neutro);
            border-radius: 10px;
            text-align: center;
        }

        .content-list-expanded {
            margin-top: 25px;
        }

        .content-item {
            background: var(--blanco);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--azul);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .content-item.completed {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--azul);
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .lesson-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--azul);
        }

        .lesson-title {
            color: var(--azul-profundo);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            word-wrap: break-word;
        }

        .content-item.completed .lesson-title {
            text-decoration: line-through;
            color: var(--gray);
        }

        /* === MEJORAS PARA IMÁGENES Y CONTENIDO === */
        .lesson-preview {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            margin-left: 30px;
            align-items: flex-start;
        }

        .lesson-thumbnail {
            flex-shrink: 0;
            width: 160px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--azul), var(--naranja));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .lesson-thumbnail:hover {
            transform: scale(1.05);
        }

        .lesson-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lesson-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-description {
            flex: 1;
            color: var(--azul-profundo);
            font-size: 14px;
            line-height: 1.5;
            max-height: 90px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .content-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-left: 30px;
            align-items: flex-start;
        }

        .video-link, .manual-link, .notes-link, .next-class-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            transition: transform 0.3s;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            height: auto;
            min-height: 36px;
            box-sizing: border-box;
            flex-shrink: 0;
            color: white !important;
        }

        .video-link {
            background: var(--azul-claro);
        }

        .manual-link {
            background: var(--azul);
        }

        .notes-link {
            background: var(--naranja) !important;
        }

        .next-class-link {
            background: var(--azul-oscuro) !important;
        }

        .video-link:hover, .manual-link:hover, .notes-link:hover, .next-class-link:hover {
            transform: scale(1.05);
            text-decoration: none;
        }

        /* === REPRODUCTOR PERSONALIZADO MEJORADO - RESPONSIVE === */
        .player-container {
            background: #000;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 100%;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto;
            aspect-ratio: 16/9;
        }

        .video-container div[id^="player-"] {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            border-radius: 10px;
        }

        .video-container.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            z-index: 9999;
            background: #000;
            border-radius: 0;
            padding: 0;
            aspect-ratio: unset;
        }

        .video-container.fullscreen-mode div[id^="player-"] {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        .corner-box {
            position: absolute;
            bottom: 60px;
            right: 10px;
            width: 120px;
            height: 50px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            z-index: 20;
            pointer-events: auto;
            cursor: default;
            color: #fff;
            backdrop-filter: blur(5px);
        }

        .exit-fullscreen {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 30;
            cursor: pointer;
            display: none;
            color: #000;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            height: 20px;
            background: #444;
            border-radius: 10px;
            margin-top: 15px;
            position: relative;
            cursor: pointer;
            display: block;
            z-index: 15;
        }

        .progress-container.fullscreen {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            width: calc(100% - 40px);
            margin-top: 0;
            z-index: 25;
            background: rgba(255, 255, 255, 0.2);
        }

        .progress {
            height: 100%;
            background: var(--azul);
            border-radius: 10px;
            width: 0%;
            transform-origin: left center;
            position: absolute;
            left: 0;
            top: 0;
        }

        .thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            left: 0px;
        }

        .video-controls {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            z-index: 30;
            position: relative;
        }

        .video-controls button {
            background: var(--azul);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .video-controls button:hover {
            background: var(--azul-oscuro);
        }

        /* === VISOR DE PDF === */
        .manual-container {
            background: var(--neutro);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--azul);
            display: none;
        }

        .manual-header {
            background-color: var(--azul-profundo);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .manual-header h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .manual-header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .manual-controls {
            background-color: var(--azul-oscuro);
            padding: 15px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .btn-manual {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-download {
            background-color: var(--success);
        }

        .btn-download:hover {
            background-color: #229954;
            transform: translateY(-2px);
        }

        .btn-print {
            background-color: var(--naranja);
        }

        .btn-print:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }

        .welcome-message {
            padding: 20px;
            text-align: center;
            color: var(--gray);
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .welcome-message h5 {
            margin-bottom: 10px;
            color: var(--azul-profundo);
            font-size: 16px;
        }

        .welcome-message p {
            margin: 5px 0;
            font-size: 14px;
        }

        .pdf-frame {
            width: 100%;
            height: 70vh;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            display: none;
        }

        .icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* === SISTEMA DE NOTAS === */
        .notes-area {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--naranja);
            display: none;
        }

        .notes-area h4 {
            margin: 0 0 10px 0;
            color: var(--azul-profundo);
            font-size: 14px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: Arial, sans-serif;
            font-size: 14px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .save-notes-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .save-notes-btn:hover {
            background: #219653;
            transform: translateY(-2px);
        }

        .save-notes-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* === SISTEMA DE NOTIFICACIONES === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background: var(--success);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .notification.error {
            background: var(--error);
        }

        /* === BOTÓN LOGOUT === */
        .logout-btn {
            background: var(--error) !important;
            float: right;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: #c0392b !important;
            transform: translateY(-2px);
        }

        .no-content {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .error {
            background: #FEE2E2;
            color: #DC2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 900px) {
            .header-container {
                flex-direction: column;
                text-align: center;
            }
            
            .school-brand, .user-welcome {
                justify-content: center;
                text-align: center;
            }

            .course-content, .module-content {
                flex-direction: column;
            }

            .course-image-container, .module-image-container {
                align-self: center;
            }

            .manual-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-manual {
                width: 200px;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .lesson-preview {
                flex-direction: column;
            }
            
            .lesson-thumbnail {
                width: 100%;
                height: 180px;
            }
            
            .video-container {
                aspect-ratio: 16/9;
            }
            
            .video-container div[id^="player-"] {
                width: 100% !important;
                height: 100% !important;
            }
        }

        @media (max-width: 600px) {
            .form-container, .dashboard {
                width: 90%;
                min-width: unset;
                padding: 20px;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
            }

            .content-links {
                flex-direction: column;
                align-items: flex-start;
            }

            .video-link, .manual-link, .notes-link, .next-class-link {
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }

            .notification {
                right: 10px;
                left: 10px;
                width: auto;
            }
            
            .course-image {
                max-height: 120px;
            }

            .module-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .back-button {
                margin-bottom: 10px;
                width: 100%;
                text-align: center;
            }
            
            .lesson-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .lesson-checkbox {
                margin-bottom: 8px;
            }
            
            .pdf-frame {
                height: 50vh;
            }
        }

        @media (orientation: landscape) and (max-width: 900px) {
            .video-container.fullscreen-mode div[id^="player-"] {
                width: 100% !important;
                height: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Página 1: Login -->
        <div class="login-container" id="page1_id1">
            <div class="form-container">
                <div class="school-header">
                    <div id="defaultLogo" style="font-size: 48px; margin-bottom: 15px;">🎓</div>
                    <h1 class="login-title" id="schoolTitle">Plataforma Educativa</h1>
                </div>
                <input type="text" id="username" placeholder="Usuario" />
                <input type="password" id="password" placeholder="Contraseña" />
                <div class="error-message" id="errorMessage"></div>
                <input type="submit" value="Ingresar" onclick="LoginUser()" />
            </div>
        </div>

        <!-- Página 4: Dashboard del usuario -->
        <div class="dashboard page4_class1" id="page4_id1">
            <!-- Cabecera Superior -->
            <div class="header-container">
                <div class="school-brand">
                    <img id="schoolLogo" class="school-logo" src="" alt="Logo Escuela" onerror="this.style.display='none'">
                    <div class="school-name" id="headerSchoolName">Plataforma Educativa</div>
                </div>
                <div class="user-welcome">
                    <h2>¡Hola <span id="displayusername" style="color:var(--azul);"></span>!</h2>
                    <div class="status-badge">Estado: <span id="userStatus">Activo</span></div>
                </div>
            </div>

            <!-- Cabecera del Curso (se muestra al acceder a un curso) -->
            <div id="courseHeader" class="course-header">
                <div class="course-title-section">
                    <h1 id="courseTitle">Nombre del Curso</h1>
                </div>
                <div class="course-content">
                    <div class="course-image-container">
                        <img id="courseHeaderImage" class="course-header-image" src="" alt="Imagen del curso" onerror="this.style.display='none'">
                    </div>
                    <div class="course-info">
                        <p id="courseDescription" class="course-description">Descripción del curso...</p>
                        <button id="courseManualBtn" class="course-manual-btn" style="display: none;">
                            📘 Manual del Curso
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <h2 style="color: var(--azul-oscuro); margin-bottom: 16px;" id="mainTitle">Mis Cursos</h2>
            <div id="cursosContainer" class="cursos-grid">
                <div class="loading">Cargando cursos...</div>
            </div>
            
            <div id="modulesContainer">
                <!-- Los módulos se cargarán aquí dinámicamente -->
            </div>
            
            <input type="button" class="logout-btn" value="🚪 Cerrar Sesión" onclick="logout()" />
        </div>
    </div>

    <script>
        // === VARIABLES GLOBALES ===
        let currentUser = null;
        let userProgress = {};
        let userModules = [];
        let currentPlayers = {};
        let alumnoActual = null;
        let cursosCache = null;
        let currentCourseId = null;
        let currentGrupoId = null;
        let escuelaData = null;
        let currentCourseData = null;

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSchoolData();
        });

        // === FUNCIONES PARA DATOS DE LA ESCUELA ===
        function loadSchoolData() {
            const apiUrl = 'https://script.google.com/macros/s/AKfycbwXraaEyvKUe7GW3yBn2T1mwa1L8C43wnGajTCKYWFGol_ATkiKvTBbxAgjZ4-lPVT1yQ/exec?action=escuela';
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        escuelaData = data[0];
                        updateSchoolUI();
                    } else {
                        setDefaultSchoolData();
                    }
                })
                .catch(error => {
                    console.error('Error cargando datos de la escuela:', error);
                    setDefaultSchoolData();
                });
        }

        function updateSchoolUI() {
            if (!escuelaData) return;
            
            // Actualizar título en login
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle && escuelaData['Nombre_Escuela ']) {
                loginTitle.innerHTML = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar nombre en cabecera del dashboard
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName && escuelaData['Nombre_Escuela ']) {
                headerSchoolName.textContent = escuelaData['Nombre_Escuela '];
            }
            
            // Actualizar logo si existe
            if (escuelaData['Logo_Escuela']) {
                const logoImg = document.getElementById('schoolLogo');
                logoImg.src = escuelaData['Logo_Escuela'];
                logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                logoImg.style.display = 'block';
            }

            // Actualizar logo en login si existe
            if (escuelaData['Logo_Escuela']) {
                const loginHeader = document.querySelector('.school-header');
                if (loginHeader) {
                    const defaultLogo = document.getElementById('defaultLogo');
                    defaultLogo.style.display = 'none';
                    
                    const logoImg = document.createElement('img');
                    logoImg.src = escuelaData['Logo_Escuela'];
                    logoImg.alt = escuelaData['Nombre_Escuela '] || 'Escuela';
                    logoImg.className = 'login-school-logo';
                    logoImg.onerror = function() {
                        this.style.display = 'none';
                        defaultLogo.style.display = 'block';
                    };
                    
                    loginHeader.insertBefore(logoImg, defaultLogo);
                }
            }
        }

        function setDefaultSchoolData() {
            const loginTitle = document.getElementById('schoolTitle');
            if (loginTitle) {
                loginTitle.innerHTML = 'Plataforma Educativa';
            }
            
            const headerSchoolName = document.getElementById('headerSchoolName');
            if (headerSchoolName) {
                headerSchoolName.textContent = 'Plataforma Educativa';
            }
        }

        // === FUNCIONES DE LOGIN Y NAVEGACIÓN ===
        function LoginUser() {
            var username = document.getElementById("username").value.trim();
            var password = document.getElementById("password").value.trim();
            
            if (username == "" || password == "") {
                document.getElementById("errorMessage").innerHTML = "Complete todos los campos";
                return;
            }
            
            document.getElementById("errorMessage").innerHTML = "🔐 Verificando credenciales...";
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if(response.success) {
                        handleSuccessfulLogin(response);
                    } else {
                        document.getElementById("errorMessage").innerHTML = "❌ " + response.error;
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById("errorMessage").innerHTML = "🔒 Error de conexión segura";
                })
                .login(username, password);
        }

        function handleSuccessfulLogin(response) {
            currentUser = response.alumno;
            alumnoActual = response.alumno;
            document.getElementById("displayusername").innerHTML = currentUser.Nombre + " " + currentUser.Apellido;
            
            // Mostrar dashboard
            document.getElementById("page1_id1").className = "page1_class1-off";
            document.getElementById("page4_id1").className = "page4_id1";
            document.getElementById("errorMessage").innerHTML = "";
            
            // Cargar progreso del usuario
            loadUserProgress(currentUser.ID_Alumno);
            loadCursos();
        }

        // === FUNCIÓN PARA CARGAR PROGRESO ===
        function loadUserProgress(alumnoId) {
            google.script.run
                .withSuccessHandler(function(progresoData) {
                    userProgress = {};
                    if (progresoData && progresoData.length > 0) {
                        progresoData.forEach(function(item) {
                            userProgress[item.ID_Clase] = {
                                completed: item.Completada === "Sí",
                                notes: item.Notas_Alumno || '',
                                lastUpdate: item.Fecha_Guardado || new Date()
                            };
                        });
                    }
                    console.log("Progreso cargado:", userProgress);
                })
                .withFailureHandler(function(error) {
                    console.error("Error cargando progreso:", error);
                    userProgress = {};
                })
                .getUserProgress(alumnoId);
        }

        function logout() {
            // Limpiar reproductores
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].pauseVideo();
                }
            }
            currentPlayers = {};
            
            // Limpiar datos
            currentUser = null;
            userProgress = {};
            userModules = [];
            alumnoActual = null;
            currentCourseData = null;
            
            // Limpiar cache local
            sessionStorage.clear();
            
            // Ocultar cabecera del curso
            document.getElementById('courseHeader').style.display = 'none';
            
            // Volver a login
            document.getElementById("page4_id1").className = "page4_id1-off";
            document.getElementById("page1_id1").className = "page1_id1";
            clearErrors();
            clearForms();
        }

        // === FUNCIONES DE CURSOS CON CACHE FRONTEND ===
        function loadCursos() {
            const container = document.getElementById('cursosContainer');
            const cacheKey = `cursos_${alumnoActual.ID_Alumno}`;
            
            // Verificar cache local
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                console.log('Cargando cursos desde cache frontend');
                displayCursos(JSON.parse(cached));
                return;
            }
            
            container.innerHTML = '<div class="loading">Cargando cursos...</div>';
            
            google.script.run
                .withSuccessHandler(function(cursos) {
                    // Guardar en cache local
                    sessionStorage.setItem(cacheKey, JSON.stringify(cursos));
                    displayCursos(cursos);
                })
                .withFailureHandler(showCursosError)
                .getCursosAlumno(alumnoActual.ID_Alumno);
        }

        function displayCursos(cursos) {
            cursosCache = cursos;
            const container = document.getElementById('cursosContainer');
            
            if (cursos.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🎓</div>
                        <h3 style="color: var(--azul-oscuro); margin-bottom: 8px;">No estás inscrito en ningún curso visible</h3>
                        <p style="color: var(--gray); margin-bottom: 16px;">
                            Contacta al administrador para inscribirte en los cursos.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cursos.map(curso => {
                const hasImage = curso.Foto_Portada && curso.Foto_Portada.trim() !== '';
                return `
                <div class="curso-card" onclick="accederAlCurso('${curso.ID_Curso}', '${curso.ID_Grupo}')">
                    <div class="curso-imagen">
                        ${hasImage ? 
                            `<img src="${curso.Foto_Portada}" 
                                  alt="${curso.Nombre_Curso}" 
                                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                  onload="this.style.display='block'; this.nextElementSibling.style.display='none';">` : 
                            ''
                        }
                        <div class="image-fallback" style="${hasImage ? 'display: none;' : ''}">🎓</div>
                    </div>
                    <div class="curso-content">
                        <h3 class="curso-titulo">${curso.Nombre_Curso}</h3>
                        <p class="curso-grupo">Grupo: ${curso.Nombre_Grupo}</p>
                        <p class="curso-grupo">Inicio: ${formatFecha(curso.Fecha_Inicio)}</p>
                        <button class="btn-acceder">Acceder al curso</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showCursosError(error) {
            const container = document.getElementById('cursosContainer');
            container.innerHTML = '<div class="error">Error al cargar los cursos: ' + error + '</div>';
        }

        function accederAlCurso(cursoId, grupoId) {
            currentCourseId = cursoId;
            currentGrupoId = grupoId;
            
            // Encontrar los datos del curso actual
            currentCourseData = cursosCache.find(curso => 
                curso.ID_Curso === cursoId && curso.ID_Grupo === grupoId
            );
            
            // Mostrar cabecera del curso
            if (currentCourseData) {
                document.getElementById('courseTitle').textContent = currentCourseData.Nombre_Curso;
                document.getElementById('courseDescription').textContent = currentCourseData.Descripcion || 'No hay descripción disponible para este curso.';
                
                // Imagen de cabecera del curso
                if (currentCourseData.Foto_Cabecera) {
                    document.getElementById('courseHeaderImage').src = currentCourseData.Foto_Cabecera;
                    document.getElementById('courseHeaderImage').style.display = 'block';
                } else {
                    document.getElementById('courseHeaderImage').style.display = 'none';
                }
                
                // Botón manual del curso
                if (currentCourseData.Manual_c) {
                    document.getElementById('courseManualBtn').style.display = 'inline-block';
                    document.getElementById('courseManualBtn').onclick = function() {
                        showCourseManual(currentCourseData.Manual_c);
                    };
                } else {
                    document.getElementById('courseManualBtn').style.display = 'none';
                }
                
                document.getElementById('courseHeader').style.display = 'block';
            }
            
            // Ocultar cursos y mostrar módulos
            document.getElementById('cursosContainer').style.display = 'none';
            document.getElementById('mainTitle').textContent = 'Módulos del Curso';
            
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button><div class="loading">Cargando módulos...</div>';
            
            const cacheKey = `modulos_${alumnoActual.ID_Alumno}_${cursoId}_${grupoId}`;
            const cached = sessionStorage.getItem(cacheKey);
            
            if (cached) {
                console.log('Cargando módulos desde cache frontend');
                displayModulos(JSON.parse(cached), cursoId, grupoId);
            } else {
                google.script.run
                    .withSuccessHandler((modulos) => {
                        sessionStorage.setItem(cacheKey, JSON.stringify(modulos));
                        displayModulos(modulos, cursoId, grupoId);
                    })
                    .withFailureHandler((error) => {
                        container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button><div class="error">Error al cargar módulos: ' + error + '</div>';
                    })
                    .getModulosCurso(alumnoActual.ID_Alumno, cursoId, grupoId);
            }
        }

        function volverACursos() {
            // Limpiar reproductores
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId]) {
                    currentPlayers[lessonId].destroy();
                }
            }
            currentPlayers = {};
            
            // Ocultar cabecera del curso
            document.getElementById('courseHeader').style.display = 'none';
            
            // Mostrar cursos nuevamente
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';
            document.getElementById('cursosContainer').style.display = 'grid';
            document.getElementById('mainTitle').textContent = 'Mis Cursos';
        }

        // === MANUAL DEL CURSO ===
        function showCourseManual(manualUrl) {
            if (manualUrl) {
                window.open(manualUrl, '_blank');
            }
        }

        // === SISTEMA DE MÓDULOS Y CLASES ===
        function displayModulos(modules, cursoId, grupoId) {
            const container = document.getElementById("modulesContainer");
            container.innerHTML = '<button class="back-to-courses-btn" onclick="volverACursos()">← Volver a Mis Cursos</button>';
            
            if (!modules || modules.length === 0) {
                container.innerHTML += "<p class='no-content'>No tienes módulos disponibles en este momento.</p>";
                return;
            }
            
            userModules = modules;
            
            let modulesList = "<h3>Tus Módulos Disponibles:</h3><div class='modules-grid'>";
            
            modules.forEach(module => {
                const progressPercentage = module.Total_Clases > 0 ? 
                    Math.round((module.Clases_Completadas / module.Total_Clases) * 100) : 0;
                
                modulesList += `
                <div class='module-card' onclick='expandModule("${module.ID_Módulo}")'>
                    <h4>${module['Nombre del Módulo'] || module.Nombre_Modulo}</h4>
                    <div class='module-progress'>
                        <div class='progress-label'>Progreso del Módulo</div>
                        <div class='module-progress-bar-container'>
                            <div class='module-progress-bar' style='width: ${progressPercentage}%'></div>
                        </div>
                        <div class='module-progress-text'>${progressPercentage}% completado</div>
                    </div>
                </div>`;
            });
            
            modulesList += "</div>";
            container.innerHTML += modulesList;
        }

        function expandModule(moduleId) {
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'none';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'none';
            
            var selectedModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_Módulo === moduleId) {
                    selectedModule = userModules[i];
                    break;
                }
            }
            
            if (!selectedModule) return;
            
            var expandedContent = "<div class='expanded-module'>";
            
            // Cabecera del módulo
            expandedContent += `
            <div class='module-header-expanded'>
                <div class='module-title-section'>
                    <h2>${selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo}</h2>
                </div>
                <div class='module-content'>
                    <div class='module-image-container'>
                        ${selectedModule['imagen_m'] ? 
                            `<img src="${selectedModule['imagen_m']}" class='module-header-image' alt='Imagen del módulo' onerror='this.style.display=\"none\"'>` : 
                            '<div style="width: 180px; height: 120px; background: linear-gradient(135deg, var(--azul), var(--naranja)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">📚</div>'
                        }
                    </div>
                    <div class='module-info'>
                        <p class='module-description'>${selectedModule['Descripción del Módulo'] || 'No hay descripción disponible para este módulo.'}</p>
                        ${selectedModule['Manual_m'] ? 
                            `<button class='module-manual-btn' onclick='showModuleManual(\"${selectedModule['Manual_m']}\")'>📘 Manual del Módulo</button>` : 
                            ''
                        }
                    </div>
                </div>
            </div>`;
            
            // Resto del contenido del módulo (clases)
            expandedContent += "<div class='module-header'>";
            expandedContent += "<button class='back-button' onclick='collapseModule()'>← Mis Módulos</button>";
            expandedContent += "</div>";
            
            var completedCount = selectedModule.Clases_Completadas || 0;
            var totalCount = selectedModule.Total_Clases || 0;
            
            var progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            expandedContent += "<div class='module-progress-expanded'>";
            expandedContent += "<div class='progress-label'>Progreso del Módulo</div>";
            expandedContent += "<div class='module-progress-bar-container'>";
            expandedContent += "<div class='module-progress-bar' style='width: " + progressPercentage + "%'></div>";
            expandedContent += "</div>";
            expandedContent += "<div class='module-progress-text'>" + completedCount + "/" + totalCount + " lecciones (" + progressPercentage + "%)</div>";
            expandedContent += "</div>";
            
            if (selectedModule.Clases && selectedModule.Clases.length > 0) {
                expandedContent += "<div class='content-list-expanded'>";
                
                for (var j = 0; j < selectedModule.Clases.length; j++) {
                    var content = selectedModule.Clases[j];
                    var lessonId = content.ID_Clase;
                    var isCompleted = userProgress[lessonId] && userProgress[lessonId].completed;
                    var hasNotes = userProgress[lessonId] && userProgress[lessonId].notes && userProgress[lessonId].notes.trim() !== '';
                    
                    expandedContent += "<div class='content-item" + (isCompleted ? " completed" : "") + "'>";
                    
                    expandedContent += "<div class='lesson-header'>";
                    expandedContent += "<input type='checkbox' id='check_" + lessonId + "' class='lesson-checkbox' ";
                    expandedContent += "onchange='markAsViewed(\"" + lessonId + "\", \"" + moduleId + "\", \"" + (selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\", this)' ";
                    if (isCompleted) {
                        expandedContent += "checked ";
                    }
                    expandedContent += "/>";
                    expandedContent += "<label for='check_" + lessonId + "' class='lesson-title'>" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "</label>";
                    expandedContent += "</div>";
                    
                    // === MINIATURA Y DESCRIPCIÓN ===
                    var videoUrl = content['URL Video'] || '';
                    var videoId = extractVideoId(videoUrl);
                    var description = content['Descripción'] || '';
                    
                    if (videoId || description) {
                        expandedContent += "<div class='lesson-preview'>";
                        
                        // Miniatura del video (si existe)
                        if (videoId) {
                            var thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                            expandedContent += "<div class='lesson-thumbnail' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + videoUrl + "\")'>";
                            expandedContent += "<img src='" + thumbnailUrl + "' alt='Miniatura del video'>";
                            expandedContent += "<div class='play-icon'>▶</div>";
                            expandedContent += "</div>";
                        }
                        
                        // Descripción de la clase
                        if (description) {
                            expandedContent += "<div class='lesson-description'>" + description + "</div>";
                        }
                        
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div class='content-links'>";
                    
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<button id='show-player-" + lessonId + "' class='video-link' onclick='showVideoPlayer(\"" + lessonId + "\", \"" + content['URL Video'] + "\")'>🎬 Ver Video</button>";
                        expandedContent += "<button id='hide-player-" + lessonId + "' class='video-link' onclick='hideVideoPlayer(\"" + lessonId + "\")' style='display: none;'>❌ Cerrar Video</button>";
                    }
                    
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<button id='show-manual-" + lessonId + "' class='manual-link' onclick='showManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>📄 Ver Manual</button>";
                        expandedContent += "<button id='hide-manual-" + lessonId + "' class='manual-link' onclick='hideManual(\"" + lessonId + "\")' style='display: none;'>❌ Cerrar Manual</button>";
                    }
                    
                    expandedContent += "<button id='notes-btn-" + lessonId + "' class='notes-link' onclick='toggleNotes(\"" + lessonId + "\")'>";
                    expandedContent += hasNotes ? "📝 Ver notas (" + (userProgress[lessonId].notes.length > 0 ? "1" : "0") + ")" : "📝 Agregar notas";
                    expandedContent += "</button>";
                    
                    // Botón Clase Siguiente (excepto para la última clase)
                    if (j < selectedModule.Clases.length - 1) {
                        expandedContent += "<button class='next-class-link' onclick='nextClass(\"" + lessonId + "\", \"" + moduleId + "\")'>➡️ Clase Siguiente</button>";
                    }
                    
                    expandedContent += "</div>";
                    
                    // Contenedores para video, manual y notas
                    if (content['URL Video'] && content['URL Video'].trim() !== '') {
                        expandedContent += "<div id='player-container-" + lessonId + "' class='player-container' style='display: none;'>";
                        expandedContent += "<div class='video-container' id='videoContainer-" + lessonId + "'>";
                        expandedContent += "<div id='player-" + lessonId + "'></div>";
                        expandedContent += "<div class='overlay' id='overlay-" + lessonId + "'></div>";
                        expandedContent += "<div class='corner-box'>🎓</div>";
                        expandedContent += "<div class='exit-fullscreen' id='exitFullscreenBtn-" + lessonId + "'>✖</div>";
                        
                        expandedContent += "<div class='progress-container' id='progressBar-" + lessonId + "'>";
                        expandedContent += "<div class='progress' id='progress-" + lessonId + "'></div>";
                        expandedContent += "<div class='thumb' id='thumb-" + lessonId + "'></div>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='video-controls'>";
                        expandedContent += "<button id='playPauseBtn-" + lessonId + "'>▶ Play</button>";
                        expandedContent += "<button id='restartBtn-" + lessonId + "'>⏮ Reiniciar</button>";
                        expandedContent += "<button id='fullscreenBtn-" + lessonId + "'>⛶ Pantalla completa</button>";
                        expandedContent += "</div>";
                        expandedContent += "</div>";
                    }
                    
                    // Contenedor para el manual PDF
                    if (content['URL Manual'] && content['URL Manual'].trim() !== '') {
                        expandedContent += "<div id='manual-container-" + lessonId + "' class='manual-container' style='display: none; margin-top: 10px;'>";
                        expandedContent += "<div class='manual-header'>";
                        expandedContent += "<h4>📚 Material de Estudio</h4>";
                        expandedContent += "<p>Accede a tu contenido educativo</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div class='manual-controls'>";
                        expandedContent += "<button class='btn-manual btn-download' onclick='downloadManual(\"" + lessonId + "\", \"" + content['URL Manual'] + "\")'>";
                        expandedContent += "<svg class='icon' viewBox='0 0 24 24'><path d='M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z'/></svg>";
                        expandedContent += "Descargar";
                        expandedContent += "</button>";
                        
                        expandedContent += "<button class='btn-manual btn-print' onclick='printManual(\"" + lessonId + "\")'>";
                        expandedContent += "<svg class='icon' viewBox='0 0 24 24'><path d='M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z'/></svg>";
                        expandedContent += "Imprimir";
                        expandedContent += "</button>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<div id='welcome-message-" + lessonId + "' class='welcome-message'>";
                        expandedContent += "<h5>¡Bienvenido!</h5>";
                        expandedContent += "<p>Haz clic en \"Ver Manual\" para acceder al material de estudio.</p>";
                        expandedContent += "<p>Una vez abierto, podrás descargarlo o imprimirlo según necesites.</p>";
                        expandedContent += "</div>";
                        
                        expandedContent += "<iframe id='pdf-frame-" + lessonId + "' class='pdf-frame' style='display: none;'></iframe>";
                        expandedContent += "</div>";
                    }
                    
                    expandedContent += "<div id='notes-area-" + lessonId + "' class='notes-area' style='display: none; margin-top: 10px;'>";
                    expandedContent += "<h4>Notas para esta lección:</h4>";
                    expandedContent += "<textarea id='notes-text-" + lessonId + "' class='notes-textarea' placeholder='Escribe tus notas aquí...'>";
                    if (hasNotes) {
                        expandedContent += userProgress[lessonId].notes;
                    }
                    expandedContent += "</textarea>";
                    expandedContent += "<button id='save-notes-btn-" + lessonId + "' class='save-notes-btn' onclick='saveNotes(\"" + lessonId + "\", \"" + (selectedModule['Nombre del Módulo'] || selectedModule.Nombre_Modulo) + "\", \"" + (content['Nombre de la Clase'] || content.Nombre_Clase) + "\")'>Guardar notas</button>";
                    expandedContent += "</div>";
                    
                    expandedContent += "</div>";
                }
                
                expandedContent += "</div>";
            } else {
                expandedContent += "<p class='no-content'>Contenido próximamente...</p>";
            }
            
            expandedContent += "</div>";
            
            var expandedContainer = document.createElement('div');
            expandedContainer.id = 'expanded-module-container';
            expandedContainer.innerHTML = expandedContent;
            
            document.getElementById('modulesContainer').appendChild(expandedContainer);
        }

        // === MANUAL DEL MÓDULO ===
        function showModuleManual(manualUrl) {
            if (manualUrl) {
                window.open(manualUrl, '_blank');
            }
        }

        function collapseModule() {
            var expandedContainer = document.getElementById('expanded-module-container');
            if (expandedContainer) {
                expandedContainer.remove();
            }
            
            document.querySelectorAll('.module-card').forEach(card => {
                card.style.display = 'block';
            });
            
            document.querySelector('#modulesContainer h3').style.display = 'block';
        }

        // === SISTEMA DE PROGRESO MEJORADO ===
        function markAsViewed(lessonId, moduleId, moduleName, lessonName, checkbox) {
            const completed = checkbox.checked;
            const notes = userProgress[lessonId] ? userProgress[lessonId].notes : '';
            
            const contentItem = checkbox.closest('.content-item');
            if (completed) {
                contentItem.classList.add('completed');
            } else {
                contentItem.classList.remove('completed');
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        userProgress[lessonId] = {
                            completed: completed,
                            notes: notes,
                            lastUpdate: new Date()
                        };
                        
                        // Actualizar cache local
                        updateLocalCache();
                        showNotification(completed ? '✅ Lección completada' : '📝 Progreso actualizado');
                    } else {
                        showNotification('❌ Error: ' + response.message, 'error');
                        checkbox.checked = !completed;
                    }
                })
                .withFailureHandler(function(error) {
                    showNotification('❌ Error de conexión', 'error');
                    checkbox.checked = !completed;
                })
                .updateLessonProgress(currentUser.ID_Alumno, lessonId, moduleName, lessonName, completed, notes);
        }

        function saveNotes(lessonId, moduleName, lessonName) {
            const notesText = document.getElementById('notes-text-' + lessonId).value;
            const saveButton = document.getElementById('save-notes-btn-' + lessonId);
            
            saveButton.textContent = 'Guardando...';
            saveButton.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        if (!userProgress[lessonId]) {
                            userProgress[lessonId] = {};
                        }
                        userProgress[lessonId].notes = notesText;
                        
                        // Actualizar cache local
                        updateLocalCache();
                        
                        showNotification('✅ Notas guardadas correctamente');
                        saveButton.textContent = 'Guardado ✓';
                        
                        const notesButton = document.getElementById('notes-btn-' + lessonId);
                        notesButton.textContent = '📝 Ver notas (' + (notesText.length > 0 ? "1" : "0") + ')';
                        
                        setTimeout(() => {
                            saveButton.textContent = 'Guardar notas';
                            saveButton.disabled = false;
                        }, 2000);
                    } else {
                        showNotification('❌ Error: ' + response.message, 'error');
                        saveButton.textContent = 'Guardar notas';
                        saveButton.disabled = false;
                    }
                })
                .withFailureHandler(function(error) {
                    showNotification('❌ Error: ' + error.message, 'error');
                    saveButton.textContent = 'Guardar notas';
                    saveButton.disabled = false;
                })
                .saveLessonNotes(currentUser.ID_Alumno, lessonId, notesText);
        }

        // === SISTEMA DE VIDEO MEJORADO ===
        function showVideoPlayer(lessonId, videoUrl) {
            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                showNotification("URL de video inválida", "error");
                return;
            }

            pauseAllVideos();
            
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            document.querySelectorAll('.player-container').forEach(container => {
                if (container.id !== 'player-container-' + lessonId) {
                    container.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="hide-player-"]').forEach(button => {
                if (button.id !== 'hide-player-' + lessonId) {
                    button.style.display = 'none';
                }
            });
            
            document.querySelectorAll('[id^="show-player-"]').forEach(button => {
                if (button.id !== 'show-player-' + lessonId && !button.closest('.player-container')) {
                    button.style.display = 'inline-block';
                }
            });
            
            playerContainer.style.display = 'block';
            showButton.style.display = 'none';
            hideButton.style.display = 'inline-block';
            
            if (!currentPlayers[lessonId] || currentPlayers[lessonId].getVideoData === undefined) {
                createPlayer(lessonId, videoId);
            } else {
                currentPlayers[lessonId].cueVideoById(videoId);
                setTimeout(function() {
                    adjustPlayerSize(lessonId);
                }, 100);
            }
        }

        function hideVideoPlayer(lessonId) {
            var playerContainer = document.getElementById('player-container-' + lessonId);
            var showButton = document.getElementById('show-player-' + lessonId);
            var hideButton = document.getElementById('hide-player-' + lessonId);
            
            playerContainer.style.display = 'none';
            showButton.style.display = 'inline-block';
            hideButton.style.display = 'none';
            
            if (currentPlayers[lessonId]) {
                currentPlayers[lessonId].pauseVideo();
            }
        }

        function pauseAllVideos() {
            for (var lessonId in currentPlayers) {
                if (currentPlayers[lessonId] && typeof currentPlayers[lessonId].pauseVideo === 'function') {
                    currentPlayers[lessonId].pauseVideo();
                }
            }
        }

        function extractVideoId(url) {
            var regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            var match = url.match(regex);
            return match ? match[1] : null;
        }

        function adjustPlayerSize(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            var container = document.getElementById('videoContainer-' + lessonId);
            if (!container) return;
            
            var containerWidth = container.clientWidth;
            var containerHeight = containerWidth * 9 / 16;
            
            player.setSize(containerWidth, containerHeight);
        }

        function createPlayer(lessonId, videoId) {
            var playerId = 'player-' + lessonId;
            
            currentPlayers[lessonId] = new YT.Player(playerId, {
                videoId: videoId,
                playerVars: { 
                    controls: 0, 
                    modestbranding: 1, 
                    rel: 0, 
                    iv_load_policy: 3,
                    playsinline: 1
                },
                events: {
                    onReady: function() { onPlayerReady(lessonId); },
                    onStateChange: function(event) { onPlayerStateChange(lessonId, event); }
                }
            });
        }

        function onPlayerReady(lessonId) {
            var player = currentPlayers[lessonId];
            
            adjustPlayerSize(lessonId);
            
            setupCustomControls(lessonId);
            
            setInterval(function() {
                updateProgress(lessonId);
            }, 500);
        }

        function onPlayerStateChange(lessonId, event) {
            var btn = document.getElementById("playPauseBtn-" + lessonId);
            if (btn) {
                btn.textContent = event.data === YT.PlayerState.PLAYING ? "⏸ Pause" : "▶ Play";
            }
        }

        function setupCustomControls(lessonId) {
            var overlay = document.getElementById("overlay-" + lessonId);
            var playPauseBtn = document.getElementById("playPauseBtn-" + lessonId);
            var restartBtn = document.getElementById("restartBtn-" + lessonId);
            var fullscreenBtn = document.getElementById("fullscreenBtn-" + lessonId);
            var exitFullscreenBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            var progressBar = document.getElementById("progressBar-" + lessonId);
            var thumb = document.getElementById("thumb-" + lessonId);

            if (overlay) overlay.onclick = function(e) { 
                if (!e.target.closest('.video-controls') && !e.target.closest('.exit-fullscreen')) {
                    togglePlayPause(lessonId); 
                }
            };
            
            if (playPauseBtn) playPauseBtn.onclick = function() { togglePlayPause(lessonId); };
            if (restartBtn) restartBtn.onclick = function() { restartVideo(lessonId); };
            if (fullscreenBtn) fullscreenBtn.onclick = function() { goFullScreen(lessonId); };
            if (exitFullscreenBtn) exitFullscreenBtn.onclick = function() { exitFullScreen(lessonId); };

            if (thumb) {
                thumb.addEventListener("mousedown", function(e) { startDrag(e, lessonId); });
                thumb.addEventListener("touchstart", function(e) { startDrag(e, lessonId); }, {passive: false});
            }

            if (progressBar) {
                progressBar.addEventListener("click", function(e) {
                    if (!window.dragging) {
                        var rect = progressBar.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        if (x < 0) x = 0;
                        if (x > rect.width) x = rect.width;
                        seekToPosition(lessonId, x / rect.width);
                    }
                });
            }

            document.addEventListener("mousemove", function(e) { dragMove(e, lessonId); });
            document.addEventListener("mouseup", function(e) { endDrag(e); });
            document.addEventListener("touchmove", function(e) { dragMove(e, lessonId); }, {passive: false});
            document.addEventListener("touchend", function(e) { endDrag(e); });
            document.addEventListener("touchcancel", function(e) { endDrag(e); });

            document.addEventListener('fullscreenchange', function() { fullscreenChange(lessonId); });
            document.addEventListener('webkitfullscreenchange', function() { fullscreenChange(lessonId); });
            document.addEventListener('msfullscreenchange', function() { fullscreenChange(lessonId); });
            
            window.addEventListener('resize', function() {
                if (currentPlayers[lessonId]) {
                    adjustPlayerSize(lessonId);
                }
            });
            
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    fullscreenChange(lessonId);
                    adjustPlayerSize(lessonId);
                }, 300);
            });
        }

        function togglePlayPause(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function restartVideo(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            player.seekTo(0, true);
            player.playVideo();
        }

        function updateProgress(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player || !player.getCurrentTime || window.dragging) return;

            var currentTime = player.getCurrentTime();
            var duration = player.getDuration();
            var percent = (currentTime / duration) * 100;
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = percent + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent / 100 * progressBarElement.offsetWidth) + "px";
            }
        }

        function startDrag(e, lessonId) {
            e.preventDefault();
            window.dragging = true;
            window.currentDragLessonId = lessonId;
        }

        function dragMove(e, lessonId) {
            if (window.dragging && window.currentDragLessonId === lessonId) {
                e.preventDefault();
                var progressBar = document.getElementById("progressBar-" + lessonId);
                if (!progressBar) return;

                var rect = progressBar.getBoundingClientRect();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var x = clientX - rect.left;
                
                if (x < 0) x = 0;
                if (x > rect.width) x = rect.width;
                
                seekToPosition(lessonId, x / rect.width);
            }
        }

        function endDrag(e) {
            window.dragging = false;
            window.currentDragLessonId = null;
        }

        function seekToPosition(lessonId, percent) {
            var player = currentPlayers[lessonId];
            if (!player) return;

            var duration = player.getDuration();
            var newTime = duration * percent;
            player.seekTo(newTime, true);
            
            var progressElement = document.getElementById("progress-" + lessonId);
            var thumbElement = document.getElementById("thumb-" + lessonId);
            var progressBarElement = document.getElementById("progressBar-" + lessonId);
            
            if (progressElement) {
                progressElement.style.width = (percent * 100) + "%";
            }
            
            if (thumbElement && progressBarElement) {
                thumbElement.style.left = (percent * progressBarElement.offsetWidth) + "px";
            }
        }

        function goFullScreen(lessonId) {
            var container = document.getElementById("videoContainer-" + lessonId);
            if (!container) return;

            container.classList.add('fullscreen-mode');
            
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
            
            setTimeout(function() {
                var player = currentPlayers[lessonId];
                if (player && typeof player.setSize === 'function') {
                    adjustPlayerSizeForFullscreen(lessonId);
                }
            }, 100);
        }

        function adjustPlayerSizeForFullscreen(lessonId) {
            var player = currentPlayers[lessonId];
            if (!player) return;
            
            player.setSize(window.innerWidth, window.innerHeight);
        }

        function exitFullScreen(lessonId) {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            
            if (lessonId) {
                var container = document.getElementById("videoContainer-" + lessonId);
                if (container) {
                    container.classList.remove('fullscreen-mode');
                    
                    setTimeout(function() {
                        var player = currentPlayers[lessonId];
                        if (player && typeof player.setSize === 'function') {
                            adjustPlayerSize(lessonId);
                        }
                    }, 100);
                }
            }
        }

        function fullscreenChange(lessonId) {
            var exitBtn = document.getElementById("exitFullscreenBtn-" + lessonId);
            var progressBar = document.getElementById("progressBar-" + lessonId);
            
            var isFullscreen = document.fullscreenElement || 
                              document.webkitFullscreenElement || 
                              document.msFullscreenElement;
            
            if (exitBtn) {
                exitBtn.style.display = isFullscreen ? "flex" : "none";
            }
            
            if (progressBar) {
                if (isFullscreen) {
                    progressBar.classList.add("fullscreen");
                } else {
                    progressBar.classList.remove("fullscreen");
                }
            }
            
            var player = currentPlayers[lessonId];
            if (player && typeof player.setSize === 'function') {
                if (isFullscreen) {
                    setTimeout(function() {
                        adjustPlayerSizeForFullscreen(lessonId);
                    }, 100);
                } else {
                    setTimeout(function() {
                        adjustPlayerSize(lessonId);
                    }, 100);
                }
            }
        }

        // === SISTEMA DE MANUALES PDF ===
        function showManual(lessonId, manualUrl) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            if (manualContainer.style.display === 'none' || !manualContainer.style.display) {
                manualContainer.style.display = 'block';
                showManualButton.style.display = 'none';
                hideManualButton.style.display = 'inline-block';
                
                var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
                var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
                
                if (welcomeMessage) welcomeMessage.style.display = 'none';
                if (pdfFrame) {
                    pdfFrame.style.display = 'block';
                    var viewerUrl = convertToGoogleDriveViewer(manualUrl);
                    pdfFrame.src = viewerUrl;
                }
                
                showManualButton.innerHTML = '📄 Ocultar Manual';
            } else {
                hideManual(lessonId);
            }
        }

        function hideManual(lessonId) {
            var manualContainer = document.getElementById('manual-container-' + lessonId);
            var showManualButton = document.getElementById('show-manual-' + lessonId);
            var hideManualButton = document.getElementById('hide-manual-' + lessonId);
            
            manualContainer.style.display = 'none';
            showManualButton.style.display = 'inline-block';
            hideManualButton.style.display = 'none';
            
            var welcomeMessage = document.getElementById('welcome-message-' + lessonId);
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            
            if (welcomeMessage) welcomeMessage.style.display = 'block';
            if (pdfFrame) {
                pdfFrame.style.display = 'none';
                pdfFrame.src = '';
            }
            
            showManualButton.innerHTML = '📄 Ver Manual';
        }

        function convertToGoogleDriveViewer(url) {
            var fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }
            return url;
        }

        function extractGoogleDriveFileId(url) {
            var match = url.match(/[-\w]{25,}/);
            return match ? match[0] : null;
        }

        function downloadManual(lessonId, manualUrl) {
            var fileId = extractGoogleDriveFileId(manualUrl);
            if (fileId) {
                var downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
                window.open(downloadUrl, '_blank');
            } else {
                window.open(manualUrl, '_blank');
            }
        }

        function printManual(lessonId) {
            var pdfFrame = document.getElementById('pdf-frame-' + lessonId);
            if (pdfFrame && pdfFrame.contentWindow) {
                try {
                    pdfFrame.contentWindow.print();
                } catch (e) {
                    var manualUrl = pdfFrame.src;
                    window.open(manualUrl, '_blank');
                    showNotification('Se abrió el manual en una nueva ventana para imprimir', 'info');
                }
            }
        }

        // === SISTEMA DE NOTAS ===
        function toggleNotes(lessonId) {
            var notesArea = document.getElementById('notes-area-' + lessonId);
            var notesButton = document.getElementById('notes-btn-' + lessonId);
            
            if (notesArea.style.display === 'none' || !notesArea.style.display) {
                notesArea.style.display = 'block';
                notesButton.textContent = 'Ocultar notas';
                
                var notesTextarea = document.getElementById('notes-text-' + lessonId);
                if (notesTextarea.value === '' && userProgress[lessonId] && userProgress[lessonId].notes) {
                    notesTextarea.value = userProgress[lessonId].notes;
                }
            } else {
                notesArea.style.display = 'none';
                notesButton.textContent = 'Ver/Editar notas';
            }
        }

        // === FUNCIÓN CLASE SIGUIENTE ===
        function nextClass(lessonId, moduleId) {
            var currentModule = null;
            for (var i = 0; i < userModules.length; i++) {
                if (userModules[i].ID_Módulo === moduleId) {
                    currentModule = userModules[i];
                    break;
                }
            }
            
            if (!currentModule || !currentModule.Clases) return;
            
            var currentIndex = -1;
            for (var j = 0; j < currentModule.Clases.length; j++) {
                if (currentModule.Clases[j].ID_Clase === lessonId) {
                    currentIndex = j;
                    break;
                }
            }
            
            if (currentIndex === -1 || currentIndex >= currentModule.Clases.length - 1) {
                showNotification("No hay más clases en este módulo", "info");
                return;
            }
            
            var nextLesson = currentModule.Clases[currentIndex + 1];
            
            hideVideoPlayer(lessonId);
            hideManual(lessonId);
            
            var currentCheckbox = document.getElementById('check_' + lessonId);
            if (currentCheckbox && !currentCheckbox.checked) {
                currentCheckbox.checked = true;
                markAsViewed(lessonId, moduleId, currentModule['Nombre del Módulo'], currentModule.Clases[currentIndex]['Nombre de la Clase'], currentCheckbox);
            }
            
            if (nextLesson['URL Video'] && nextLesson['URL Video'].trim() !== '') {
                setTimeout(function() {
                    showVideoPlayer(nextLesson.ID_Clase, nextLesson['URL Video']);
                }, 300);
            }
            
            var nextLessonElement = document.getElementById('check_' + nextLesson.ID_Clase);
            if (nextLessonElement) {
                nextLessonElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            showNotification("Avanzando a la siguiente clase: " + nextLesson['Nombre de la Clase'], "success");
        }

        // === FUNCIONES UTILITARIAS ===
        function updateLocalCache() {
            // Invalidar cache local cuando hay cambios
            if (alumnoActual) {
                sessionStorage.removeItem(`cursos_${alumnoActual.ID_Alumno}`);
                if (currentCourseId && currentGrupoId) {
                    sessionStorage.removeItem(`modulos_${alumnoActual.ID_Alumno}_${currentCourseId}_${currentGrupoId}`);
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function formatFecha(fechaString) {
            if (!fechaString) return 'No especificada';
            try {
                const fecha = new Date(fechaString);
                return fecha.toLocaleDateString('es-ES');
            } catch (e) {
                return fechaString;
            }
        }

        function clearErrors() {
            document.getElementById("errorMessage").innerHTML = "";
        }
        
        function clearForms() {
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
        }
    </script>
</body>
</html>
